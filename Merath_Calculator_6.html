      this.addStep('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨',
        error.message,
        {
          error: error.message,
          calculationTime: `${calculationTime.toFixed(2)}ms`,
          timestamp: new Date().toISOString()
        },
        'error'
      );
      
      return {
        success: false,
        error: error.message,
        madhab: this.madhab,
        madhhabName: this.config.name,
        calculationTime,
        steps: this.state.steps
      };
    }
  }
}

// ==================== 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…Ø­Ø³Ù† ====================
class EnhancedTestSuite {
  constructor() {
    this.tests = this.loadEnhancedTests();
    this.results = [];
    this.categories = {};
  }
  
  loadEnhancedTests() {
    return {
      basic: [
        {
          name: 'Ø²ÙˆØ¬ + Ø¨Ù†Øª',
          heirs: { husband: 1, daughter: 1 },
          expected: { husband: 0.25, daughter: 0.75 },
          description: 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø²ÙˆØ¬ ÙŠØ£Ø®Ø° Ø§Ù„Ø±Ø¨Ø¹ ÙˆØ§Ù„Ø¨Ù†Øª ØªØ£Ø®Ø° Ø§Ù„Ø¨Ø§Ù‚ÙŠ'
        },
        {
          name: 'Ø²ÙˆØ¬Ø© + Ø§Ø¨Ù†',
          heirs: { wife: 1, son: 1 },
          expected: { wife: 0.125, son: 0.875 },
          description: 'Ø²ÙˆØ¬Ø© ØªØ£Ø®Ø° Ø§Ù„Ø«Ù…Ù† ÙˆØ§Ù„Ø§Ø¨Ù† Ø¹ØµØ¨Ø©'
        },
        {
          name: 'Ø²ÙˆØ¬ + Ø§Ø¨Ù† + Ø¨Ù†Øª',
          heirs: { husband: 1, son: 1, daughter: 1 },
          expected: { husband: 0.25, son: 0.5, daughter: 0.25 },
          description: 'ØªÙˆØ²ÙŠØ¹ ØªØ¹ØµÙŠØ¨: Ø§Ù„Ø§Ø¨Ù† Ø¶Ø¹Ù Ø§Ù„Ø¨Ù†Øª'
        }
      ],
      
      umariyyah: [
        {
          name: 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { husband: 1, father: 1, mother: 1 },
          expected: { husband: 0.5, father: 0.3333, mother: 0.1667 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø£Ù… = Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬ ÙˆØ§Ù„Ø£Ø¨'
        },
        {
          name: 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { wife: 1, father: 1, mother: 1 },
          expected: { wife: 0.25, father: 0.5, mother: 0.25 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø£Ù… = Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ù„Ø£Ø¨'
        }
      ],
      
      awl: [
        {
          name: 'Ø¹ÙˆÙ„: Ø²ÙˆØ¬Ø© + Ø¨Ù†ØªØ§Ù† + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { wife: 1, daughter: 2, father: 1, mother: 1 },
          expected: {},
          description: 'Ø¹ÙˆÙ„ Ù…Ù† 24 Ø¥Ù„Ù‰ 27: Â¼ Ù„Ù„Ø²ÙˆØ¬Ø©ØŒ â…” Ù„Ù„Ø¨Ù†Ø§ØªØŒ â…™ Ù„Ù„Ø£Ø¨ØŒ â…™ Ù„Ù„Ø£Ù…'
        },
        {
          name: 'Ø¹ÙˆÙ„: Ø²ÙˆØ¬ + Ø£Ø®ØªØ§Ù† Ø´Ù‚ÙŠÙ‚ØªØ§Ù† + Ø£Ù…',
          heirs: { husband: 1, full_sister: 2, mother: 1 },
          expected: { husband: 0.375, full_sister: 0.5, mother: 0.125 },
          description: 'Ø¹ÙˆÙ„ Ù…Ù† 6 Ø¥Ù„Ù‰ 8: Ø§Ù„Ù†ØµÙ Ù„Ù„Ø²ÙˆØ¬ØŒ Ø§Ù„Ø«Ù„Ø«Ø§Ù† Ù„Ù„Ø£Ø®ØªÙŠÙ†ØŒ Ø§Ù„Ø³Ø¯Ø³ Ù„Ù„Ø£Ù…'
        }
      ],
      
      radd: [
        {
          name: 'Ø±Ø¯: Ø£Ù… + Ø¨Ù†Øª',
          heirs: { mother: 1, daughter: 1 },
          expected: { mother: 0.2, daughter: 0.8 },
          tolerance: 0.01,
          description: 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù… ÙˆØ§Ù„Ø¨Ù†Øª Ø¨Ù†Ø³Ø¨Ø© â…™ : Â½'
        },
        {
          name: 'Ø±Ø¯: Ø¨Ù†ØªØ§Ù† ÙÙ‚Ø·',
          heirs: { daughter: 2 },
          expected: { daughter: 1.0 },
          description: 'Ø§Ù„Ø¨Ù†ØªØ§Ù† ØªØ£Ø®Ø°Ø§Ù† Ø§Ù„ØªØ±ÙƒØ© ÙƒØ§Ù…Ù„Ø© Ø¨Ø§Ù„Ø±Ø¯'
        }
      ],
      
      hijab: [
        {
          name: 'Ø§Ø¨Ù† ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©',
          heirs: { son: 1, full_brother: 2 },
          expected: { son: 1.0 },
          description: 'Ø§Ù„Ø§Ø¨Ù† ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡'
        },
        {
          name: 'Ø£Ø¨ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯',
          heirs: { father: 1, grandfather: 1, son: 1 },
          expected: { father: 0.1667, son: 0.8333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø£Ø¨ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø¨Ù†'
        },
        {
          name: 'Ø£Ù… ØªØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯Ø©',
          heirs: { mother: 1, grandmother: 1, son: 1 },
          expected: { mother: 0.1667, son: 0.8333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø£Ù… ØªØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯Ø© Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø¨Ù†'
        }
      ],
      
      madhhab_specific: [
        {
          name: 'Ø¬Ø¯ Ù…Ø¹ Ø¥Ø®ÙˆØ© (Ø´Ø§ÙØ¹ÙŠ)',
          heirs: { grandfather: 1, full_brother: 2 },
          madhab: 'shafii',
          expected: { grandfather: 1.0 },
          description: 'Ø§Ù„Ø´Ø§ÙØ¹ÙŠ: Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©'
        },
        {
          name: 'Ø¬Ø¯ Ù…Ø¹ Ø¥Ø®ÙˆØ© (Ù…Ø§Ù„ÙƒÙŠ)',
          heirs: { grandfather: 1, full_brother: 2 },
          madhab: 'maliki',
          expected: { grandfather: 0.6667, full_brother: 0.3333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ: Ø§Ù„Ø¬Ø¯ ÙŠÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©'
        },
        {
          name: 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† (Ø­Ù†ÙÙŠ)',
          heirs: { husband: 1 },
          madhab: 'hanafi',
          expected: { husband: 1.0 },
          description: 'Ø§Ù„Ø­Ù†ÙÙŠ: ÙŠØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ Ø¹Ù†Ø¯ Ø§Ù†ÙØ±Ø§Ø¯Ù‡'
        }
      ],
      
      complex: [
        {
          name: 'Ø­Ø§Ù„Ø© Ù…Ø¹Ù‚Ø¯Ø©: Ø²ÙˆØ¬Ø© + Ø£Ø¨Ù†Ø§Ø¡ + Ø¨Ù†Ø§Øª + Ø£Ø¨',
          heirs: { wife: 1, son: 2, daughter: 2, father: 1 },
          expected: {},
          description: 'Ø­Ø§Ù„Ø© Ù…Ø¹Ù‚Ø¯Ø© Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø©'
        },
        {
          name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø¹ÙˆÙ„',
          heirs: { wife: 1, daughter: 3, father: 1, mother: 1, full_brother: 2 },
          expected: {},
          description: 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„ ÙˆØ§Ù„Ø­Ø¬Ø¨'
        }
      ]
    };
  }
  
  async runAllTests(primaryMadhab = 'shafii') {
    this.results = [];
    const stats = {
      total: 0,
      passed: 0,
      failed: 0,
      skipped: 0,
      byCategory: {},
      byMadhab: {}
    };
    
    for (const [category, tests] of Object.entries(this.tests)) {
      stats.byCategory[category] = { passed: 0, failed: 0, total: 0 };
      
      for (const test of tests) {
        stats.total++;
        const madhab = test.madhab || primaryMadhab;
        
        if (!stats.byMadhab[madhab]) {
          stats.byMadhab[madhab] = { passed: 0, failed: 0, total: 0 };
        }
        
        const result = await this.runEnhancedTest(test, category, madhab);
        this.results.push(result);
        
        if (result.passed) {
          stats.passed++;
          stats.byCategory[category].passed++;
          stats.byMadhab[madhab].passed++;
        } else if (result.skipped) {
          stats.skipped++;
        } else {
          stats.failed++;
          stats.byCategory[category].failed++;
          stats.byMadhab[madhab].failed++;
        }
        
        stats.byCategory[category].total++;
        stats.byMadhab[madhab].total++;
      }
    }
    
    return {
      stats,
      results: this.results,
      coverage: ((stats.passed / (stats.passed + stats.failed)) * 100).toFixed(1),
      summary: this.generateTestSummary(stats)
    };
  }
  
  async runEnhancedTest(test, category, madhab) {
    const testStart = performance.now();
    
    try {
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±ÙƒØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const estate = { total: 120000, funeral: 0, debts: 0, will: 0 };
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø­Ø³Ù†
      const engine = new EnhancedInheritanceEngine(madhab, estate, test.heirs);
      const result = engine.calculate();
      
      const testEnd = performance.now();
      const testTime = testEnd - testStart;
      
      if (!result.success) {
        return {
          name: test.name,
          category,
          madhab,
          passed: false,
          skipped: false,
          error: result.error,
          testTime,
          details: { error: result.error }
        };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
      const verification = this.verifyTestResults(test, result);
      
      return {
        name: test.name,
        category,
        madhab,
        description: test.description,
        passed: verification.passed,
        skipped: verification.skipped,
        discrepancies: verification.discrepancies,
        testTime,
        result: {
          shares: result.shares,
          specialCases: result.specialCases,
          confidence: result.confidence
        },
        details: verification.details
      };
      
    } catch (error) {
      return {
        name: test.name,
        category,
        madhab,
        passed: false,
        skipped: false,
        error: error.message,
        testTime: performance.now() - testStart,
        details: { error: error.message }
      };
    }
  }
  
  verifyTestResults(test, result) {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†ØªØ§Ø¦Ø¬ Ù…ØªÙˆÙ‚Ø¹Ø© (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©)
    if (Object.keys(test.expected || {}).length === 0) {
      return {
        passed: true,
        skipped: false,
        discrepancies: null,
        details: { note: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ù‚Ø¯ - ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·' }
      };
    }
    
    const discrepancies = [];
    const details = { heirs: [] };
    let allPassed = true;
    const tolerance = test.tolerance || 0.02;
    
    for (const [heirKey, expectedShare] of Object.entries(test.expected)) {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      let actualHeir = result.shares.find(s => s.key === heirKey);
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
      if (!actualHeir) {
        if (heirKey === 'daughter' && result.shares.some(s => s.key === 'daughter')) {
          actualHeir = result.shares.find(s => s.key === 'daughter');
        } else if (heirKey === 'full_sister' && result.shares.some(s => s.key === 'full_sister')) {
          actualHeir = result.shares.find(s => s.key === 'full_sister');
        }
      }
      
      if (!actualHeir && expectedShare > 0.001) {
        allPassed = false;
        discrepancies.push(`${heirKey}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ù…ØªÙˆÙ‚Ø¹: ${(expectedShare * 100).toFixed(1)}%)`);
        details.heirs.push({
          heir: heirKey,
          status: 'missing',
          expected: expectedShare
        });
        continue;
      }
      
      if (actualHeir) {
        const actualShare = actualHeir.fraction.toDecimal();
        const diff = Math.abs(actualShare - expectedShare);
        
        details.heirs.push({
          heir: heirKey,
          actual: actualShare,
          expected: expectedShare,
          diff: diff,
          withinTolerance: diff <= tolerance
        });
        
        if (diff > tolerance) {
          allPassed = false;
          discrepancies.push(
            `${heirKey}: ${(actualShare * 100).toFixed(2)}% (Ù…ØªÙˆÙ‚Ø¹: ${(expectedShare * 100).toFixed(2)}%) - ÙØ±Ù‚: ${(diff * 100).toFixed(2)}%`
          );
        }
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const totalActual = result.shares.reduce((sum, s) => sum + s.fraction.toDecimal(), 0);
    const totalDiff = Math.abs(totalActual - 1);
    
    if (totalDiff > 0.001) {
      discrepancies.push(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${(totalActual * 100).toFixed(2)}% (Ø§Ù„Ù…ÙØªØ±Ø¶: 100%)`);
    }
    
    details.total = {
      actual: totalActual,
      diff: totalDiff,
      withinTolerance: totalDiff <= 0.001
    };
    
    return {
      passed: allPassed,
      skipped: false,
      discrepancies: discrepancies.length > 0 ? discrepancies : null,
      details
    };
  }
  
  generateTestSummary(stats) {
    const categories = Object.keys(stats.byCategory);
    const summary = [];
    
    summary.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: ${stats.total}`);
    summary.push(`âœ… Ù†Ø§Ø¬Ø­Ø©: ${stats.passed} (${((stats.passed / stats.total) * 100).toFixed(1)}%)`);
    summary.push(`âŒ ÙØ§Ø´Ù„Ø©: ${stats.failed} (${((stats.failed / stats.total) * 100).toFixed(1)}%)`);
    
    if (stats.skipped > 0) {
      summary.push(`â­ï¸ Ù…ØªØ®Ø·Ø§Ø©: ${stats.skipped} (${((stats.skipped / stats.total) * 100).toFixed(1)}%)`);
    }
    
    summary.push('\nğŸ“Š Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:');
    for (const [category, catStats] of Object.entries(stats.byCategory)) {
      const percentage = catStats.total > 0 ? 
        ((catStats.passed / catStats.total) * 100).toFixed(1) : '0.0';
      summary.push(`  ${category}: ${catStats.passed}/${catStats.total} (${percentage}%)`);
    }
    
    summary.push('\nğŸ•Œ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨:');
    for (const [madhab, madhabStats] of Object.entries(stats.byMadhab)) {
      const percentage = madhabStats.total > 0 ? 
        ((madhabStats.passed / madhabStats.total) * 100).toFixed(1) : '0.0';
      const madhabName = ENHANCED_FIQH_DATABASE.madhabs[madhab]?.name || madhab;
      summary.push(`  ${madhabName}: ${madhabStats.passed}/${madhabStats.total} (${percentage}%)`);
    }
    
    return summary.join('\n');
  }
  
  exportTestResults(format = 'text') {
    if (this.results.length === 0) {
      return null;
    }
    
    if (format === 'json') {
      return JSON.stringify({
        timestamp: new Date().toISOString(),
        results: this.results,
        summary: this.generateTestSummary({
          total: this.results.length,
          passed: this.results.filter(r => r.passed).length,
          failed: this.results.filter(r => !r.passed && !r.skipped).length,
          skipped: this.results.filter(r => r.skipped).length,
          byCategory: {},
          byMadhab: {}
        })
      }, null, 2);
    }
    
    // Ù†Øµ Ø¹Ø§Ø¯ÙŠ
    let text = `Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0\n`;
    text += `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´ØºÙŠÙ„: ${new Date().toLocaleString('ar-SA')}\n`;
    text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    const passed = this.results.filter(r => r.passed).length;
    const failed = this.results.filter(r => !r.passed && !r.skipped).length;
    const skipped = this.results.filter(r => r.skipped).length;
    const total = this.results.length;
    
    text += `Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\n`;
    text += `  â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}\n`;
    text += `  â€¢ âœ… Ù†Ø§Ø¬Ø­Ø©: ${passed} (${((passed / total) * 100).toFixed(1)}%)\n`;
    text += `  â€¢ âŒ ÙØ§Ø´Ù„Ø©: ${failed} (${((failed / total) * 100).toFixed(1)}%)\n`;
    
    if (skipped > 0) {
      text += `  â€¢ â­ï¸ Ù…ØªØ®Ø·Ø§Ø©: ${skipped} (${((skipped / total) * 100).toFixed(1)}%)\n`;
    }
    
    text += `\nØ§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
    text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const byCategory = {};
    this.results.forEach(r => {
      if (!byCategory[r.category]) byCategory[r.category] = [];
      byCategory[r.category].push(r);
    });
    
    for (const [category, tests] of Object.entries(byCategory)) {
      text += `ğŸ“ ${category.toUpperCase()}:\n`;
      text += `${'â”€'.repeat(50)}\n`;
      
      tests.forEach((test, index) => {
        const icon = test.passed ? 'âœ…' : (test.skipped ? 'â­ï¸' : 'âŒ');
        text += `${icon} ${test.name} (${test.madhab})\n`;
        
        if (test.description) {
          text += `   â†³ ${test.description}\n`;
        }
        
        if (test.discrepancies) {
          text += `   â†³ Ø£Ø®Ø·Ø§Ø¡: ${test.discrepancies.join(' | ')}\n`;
        }
        
        if (test.error) {
          text += `   â†³ Ø®Ø·Ø£: ${test.error}\n`;
        }
        
        if (index < tests.length - 1) {
          text += '\n';
        }
      });
      
      text += '\n\n';
    }
    
    return text;
  }
}

// ==================== 6. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù† ====================
class EnhancedAuditLog {
  constructor() {
    this.entries = [];
    this.maxEntries = 1000;
    this.filters = {
      types: ['success', 'error', 'warning', 'info', 'calculation', 'hijab', 'estate'],
      minDate: null,
      maxDate: null
    };
  }
  
  add(action, type, message, details = null, component = null) {
    const timestamp = new Date();
    const entry = {
      id: this.generateId(),
      timestamp,
      formattedTime: timestamp.toLocaleString('ar-SA'),
      action,
      type,
      message,
      details,
      component,
      read: false
    };
    
    this.entries.unshift(entry);
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    if (this.entries.length > this.maxEntries) {
      this.entries = this.entries.slice(0, this.maxEntries);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    this.updateDisplay();
    
    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ
    return entry;
  }
  
  generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  clear() {
    this.entries = [];
    this.updateDisplay();
  }
  
  filterByType(types) {
    if (!types || types.length === 0) return this.entries;
    return this.entries.filter(entry => types.includes(entry.type));
  }
  
  filterByDate(minDate, maxDate) {
    return this.entries.filter(entry => {
      const entryDate = entry.timestamp;
      if (minDate && entryDate < minDate) return false;
      if (maxDate && entryDate > maxDate) return false;
      return true;
    });
  }
  
  search(query) {
    if (!query) return this.entries;
    const lowerQuery = query.toLowerCase();
    
    return this.entries.filter(entry => 
      entry.action.toLowerCase().includes(lowerQuery) ||
(Content truncated due to size limit. Use page ranges or line ranges to read remaining content)