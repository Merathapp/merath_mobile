<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #3730a3;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
    }
    body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); transition: all 0.3s; }
    .card:hover { box-shadow: 0 12px 48px rgba(0,0,0,0.12); }
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%); transition: all 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
    .btn-success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
    .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
    .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); }
    .input-field { transition: all 0.3s; border: 2px solid #e2e8f0; }
    .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); outline: none; }
    .input-field.error { border-color: var(--danger); background: #fef2f2; }
    .input-field.success { border-color: var(--success); background: #f0fdf4; }
    
    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-fard { background: #dbeafe; color: #1d4ed8; }
    .badge-asaba { background: #dcfce7; color: #166534; }
    .badge-radd { background: #fef3c7; color: #92400e; }
    .badge-blocked { background: #fee2e2; color: #991b1b; }
    .badge-relative { background: #fce7f3; color: #be185d; }
    .badge-awl { background: #e0e7ff; color: #3730a3; }
    
    /* Madhab Cards */
    .madhab-card { cursor: pointer; transition: all 0.3s; border: 3px solid transparent; position: relative; overflow: hidden; }
    .madhab-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.3s; }
    .madhab-card:hover::before { opacity: 1; }
    .madhab-card:hover { transform: translateY(-4px); }
    .madhab-card.selected { border-color: white; box-shadow: 0 0 0 4px rgba(255,255,255,0.3), 0 10px 30px rgba(0,0,0,0.2); }
    .madhab-shafii { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .madhab-hanafi { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .madhab-maliki { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
    .madhab-hanbali { background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%); }
    
    /* Heir Cards */
    .heir-card { transition: all 0.3s; border: 2px solid #e2e8f0; }
    .heir-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .heir-card.active { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #0ea5e9; }
    .heir-card.blocked { background: #fef2f2; border-color: #fecaca; opacity: 0.7; }
    
    /* Tabs */
    .tab-btn { position: relative; }
    .tab-btn::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); transform: scaleX(0); transition: transform 0.3s; }
    .tab-btn.active::after { transform: scaleX(1); }
    .tab-btn.active { color: var(--primary); }
    
    /* Progress Steps */
    .step-indicator { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s; }
    .step-active { background: var(--primary); color: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
    .step-done { background: var(--success); color: white; }
    .step-pending { background: #e2e8f0; color: #64748b; }
    
    /* Alerts */
    .alert { border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .alert-success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success); }
    .alert-warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid var(--warning); }
    .alert-danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid var(--danger); }
    .alert-info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid var(--info); }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    
    /* Audit Log */
    .audit-log { font-family: 'Courier New', monospace; font-size: 12px; background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 12px; max-height: 400px; overflow-y: auto; }
    .audit-success { color: #10b981; }
    .audit-warning { color: #f59e0b; }
    .audit-error { color: #ef4444; }
    .audit-info { color: #3b82f6; }
    
    /* Test Results */
    .test-pass { background: #d1fae5; border-left: 4px solid #10b981; }
    .test-fail { background: #fee2e2; border-left: 4px solid #ef4444; }
    
    /* Charts */
    .chart-bar { transition: all 0.5s ease-out; }
    .chart-bar:hover { filter: brightness(1.1); }
    
    /* Tooltips */
    .tooltip { position: relative; }
    .tooltip::after { 
      content: attr(data-tip); 
      position: absolute; 
      bottom: 100%; 
      left: 50%; 
      transform: translateX(-50%) translateY(-8px); 
      background: #1e293b; 
      color: white; 
      padding: 8px 12px; 
      border-radius: 8px; 
      font-size: 12px; 
      white-space: nowrap; 
      opacity: 0; 
      visibility: hidden; 
      transition: all 0.2s; 
      z-index: 100;
    }
    .tooltip:hover::after { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .madhab-card { padding: 12px !important; }
      .heir-card { padding: 12px !important; }
    }
    
    /* Print Styles */
    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .card { box-shadow: none; border: 1px solid #e2e8f0; }
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="p-4 md:p-6">
  <div class="max-w-8xl mx-auto">
    
    <!-- Header -->
    <header class="card mb-6 p-8 text-center" style="background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);">
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center">
          <span class="text-4xl">âš–ï¸</span>
        </div>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</h1>
      <p class="text-gray-300 text-lg mb-4">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0 â€” Ø¯Ù…Ø¬ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© ÙˆØ§Ù„ÙÙ‚Ù‡ÙŠØ© â€” Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø´Ø§Ù…Ù„Ø©</p>
      <div class="flex flex-wrap justify-center gap-2">
        <span class="badge bg-white/20 text-white">âœ“ Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© (Ù…ØµØ­Ø­)</span>
        <span class="badge bg-white/20 text-white">âœ“ Ù†Ø¸Ø§Ù… ÙƒØ³ÙˆØ± Ù…Ø­Ø³Ù†</span>
        <span class="badge bg-white/20 text-white">âœ“ 200+ Ø­Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±</span>
        <span class="badge bg-white/20 text-white">âœ“ Ø§Ù„Ø¹ÙˆÙ„ ÙˆØ§Ù„Ø±Ø¯ (Ù…ØµØ­Ø­)</span>
        <span class="badge bg-white/20 text-white">âœ“ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨</span>
        <span class="badge bg-white/20 text-white">âœ“ Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù…</span>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="card mb-6 no-print">
      <div class="flex flex-wrap border-b">
        <button class="tab-btn active px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition" data-tab="calculator">
          ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition" data-tab="compare">
          ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨
        </button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition" data-tab="tests">
          âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        </button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition" data-tab="rules">
          ğŸ“š Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙÙ‚Ù‡ÙŠØ©
        </button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition" data-tab="audit">
          ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        </button>
      </div>
    </div>

    <!-- ==================== Calculator Tab ==================== -->
    <div id="tab-calculator" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Inputs -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- Madhab Selection -->
          <div class="card p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <span class="w-10 h-10 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center">ğŸ•Œ</span>
              Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„ÙÙ‚Ù‡ÙŠ
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div class="madhab-card madhab-shafii selected rounded-xl p-5 text-white text-center" data-madhab="shafii">
                <div class="text-3xl mb-2">ğŸŸ¢</div>
                <div class="font-bold text-lg">Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</div>
                <div class="text-sm opacity-80 mt-1">Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</div>
              </div>
              <div class="madhab-card madhab-hanafi rounded-xl p-5 text-white text-center" data-madhab="hanafi">
                <div class="text-3xl mb-2">ğŸ”´</div>
                <div class="font-bold text-lg">Ø§Ù„Ø­Ù†ÙÙŠ</div>
                <div class="text-sm opacity-80 mt-1">Ø§Ù„Ø¥Ù…Ø§Ù… Ø£Ø¨Ùˆ Ø­Ù†ÙŠÙØ©</div>
              </div>
              <div class="madhab-card madhab-maliki rounded-xl p-5 text-white text-center" data-madhab="maliki">
                <div class="text-3xl mb-2">ğŸŸ£</div>
                <div class="font-bold text-lg">Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ</div>
                <div class="text-sm opacity-80 mt-1">Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø§Ù„Ùƒ</div>
              </div>
              <div class="madhab-card madhab-hanbali rounded-xl p-5 text-white text-center" data-madhab="hanbali">
                <div class="text-3xl mb-2">ğŸ”µ</div>
                <div class="font-bold text-lg">Ø§Ù„Ø­Ù†Ø¨Ù„ÙŠ</div>
                <div class="text-sm opacity-80 mt-1">Ø§Ù„Ø¥Ù…Ø§Ù… Ø£Ø­Ù…Ø¯</div>
              </div>
            </div>
            <div id="madhhabInfo" class="p-4 bg-green-50 border border-green-200 rounded-xl">
              <h3 class="font-bold text-green-800 mb-2">Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</h3>
              <p class="text-green-700 text-sm">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶ Ø¹Ø¯Ø§ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†. Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ù…Ø·Ù„Ù‚Ø§Ù‹. Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… ÙŠØ±Ø«ÙˆÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¹ØµØ¨Ø©.</p>
            </div>
          </div>

          <!-- Estate Data -->
          <div class="card p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <span class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center">ğŸ’°</span>
              Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ© ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ±ÙƒØ© *</label>
                <input id="estateTotal" type="number" min="0" step="0.01" value="100000" 
                       class="input-field w-full p-3 rounded-xl text-lg success" placeholder="0" />
                <p class="text-xs text-gray-500 mt-1">Ù‚ÙŠÙ…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</label>
                <input id="funeralCosts" type="number" min="0" step="0.01" value="0" 
                       class="input-field w-full p-3 rounded-xl" placeholder="0" />
                <p class="text-xs text-gray-500 mt-1">ØªÙØ®ØµÙ… Ø£ÙˆÙ„Ø§Ù‹</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</label>
                <input id="debts" type="number" min="0" step="0.01" value="0" 
                       class="input-field w-full p-3 rounded-xl" placeholder="0" />
                <p class="text-xs text-gray-500 mt-1">ØªÙØ®ØµÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙˆØµÙŠØ© Ø§Ù„Ø´Ø±Ø¹ÙŠØ©</label>
                <input id="willAmount" type="number" min="0" step="0.01" value="0" 
                       class="input-field w-full p-3 rounded-xl" placeholder="0" />
                <p class="text-xs text-gray-500 mt-1">â‰¤ Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ</p>
              </div>
            </div>
            <div class="alert alert-warning">
              <p class="font-medium text-amber-800">âš ï¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø´Ø±Ø¹ÙŠ:</p>
              <p class="text-sm text-amber-700">Ù¡. ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªØ¬Ù‡ÙŠØ² ÙˆØ§Ù„Ø¯ÙÙ† â† Ù¢. Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† â† Ù£. Ø§Ù„ÙˆØµÙŠØ© (â‰¤ â…“ Ù„ØºÙŠØ± ÙˆØ§Ø±Ø«) â† Ù¤. Ø§Ù„Ø¥Ø±Ø«</p>
            </div>
          </div>

          <!-- Heirs Section -->
          <div class="card p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <span class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center">ğŸ‘¥</span>
              ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ±Ø«Ø©
            </h2>

            <!-- Spouses -->
            <div class="mb-8">
              <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <span class="w-8 h-8 bg-pink-100 text-pink-600 rounded-lg flex items-center justify-center text-sm">ğŸ’‘</span>
                Ø§Ù„Ø£Ø²ÙˆØ§Ø¬
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-husband">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø²ÙˆØ¬</span>
                      <p class="text-xs text-gray-500">Â½ Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ØŒ Â¼ Ù…Ø¹ ÙØ±Ø¹ ÙˆØ§Ø±Ø«</p>
                    </div>
                    <select id="husband" class="input-field p-2 rounded-lg w-24 text-center">
                      <option value="0">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                      <option value="1">Ù…ÙˆØ¬ÙˆØ¯</option>
                    </select>
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-wife">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø²ÙˆØ¬Ø© / Ø§Ù„Ø²ÙˆØ¬Ø§Øª</span>
                      <p class="text-xs text-gray-500">Â¼ Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ØŒ â…› Ù…Ø¹ ÙØ±Ø¹ (ÙŠØ´ØªØ±ÙƒÙ†)</p>
                    </div>
                    <select id="wife" class="input-field p-2 rounded-lg w-24 text-center">
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Parents & Grandparents -->
            <div class="mb-8">
              <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-sm">ğŸ‘´</span>
                Ø§Ù„Ø£ØµÙˆÙ„ (Ø§Ù„Ø¢Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø¯Ø§Ø¯)
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-father">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø¨</span>
                      <p class="text-xs text-gray-500">â…™ + ØªØ¹ØµÙŠØ¨ Ø£Ùˆ ØªØ¹ØµÙŠØ¨ ÙÙ‚Ø·</p>
                    </div>
                    <select id="father" class="input-field p-2 rounded-lg w-20 text-center">
                      <option value="0">Ù„Ø§</option>
                      <option value="1">Ù†Ø¹Ù…</option>
                    </select>
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-mother">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ù…</span>
                      <p class="text-xs text-gray-500">â…™ Ø£Ùˆ â…“ Ø£Ùˆ Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ</p>
                    </div>
                    <select id="mother" class="input-field p-2 rounded-lg w-20 text-center">
                      <option value="0">Ù„Ø§</option>
                      <option value="1">Ù†Ø¹Ù…</option>
                    </select>
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-grandfather">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø¬Ø¯ Ø§Ù„ØµØ­ÙŠØ­</span>
                      <p class="text-xs text-gray-500">Ø£Ø¨Ùˆ Ø§Ù„Ø£Ø¨ ÙˆØ¥Ù† Ø¹Ù„Ø§</p>
                    </div>
                    <select id="grandfather" class="input-field p-2 rounded-lg w-20 text-center">
                      <option value="0">Ù„Ø§</option>
                      <option value="1">Ù†Ø¹Ù…</option>
                    </select>
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-grandmother">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø¬Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</span>
                      <p class="text-xs text-gray-500">â…™ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø£Ù…</p>
                    </div>
                    <select id="grandmother" class="input-field p-2 rounded-lg w-20 text-center">
                      <option value="0">Ù„Ø§</option>
                      <option value="1">Ù†Ø¹Ù…</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Children & Grandchildren -->
            <div class="mb-8">
              <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <span class="w-8 h-8 bg-green-100 text-green-600 rounded-lg flex items-center justify-center text-sm">ğŸ‘¶</span>
                Ø§Ù„ÙØ±ÙˆØ¹ (Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø£Ø­ÙØ§Ø¯)
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-son">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø§Ø¨Ù†</span>
                      <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø© Ø¨Ø§Ù„Ù†ÙØ³</p>
                    </div>
                    <input id="son" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-daughter">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø¨Ù†Øª</span>
                      <p class="text-xs text-gray-500">Â½ Ø£Ùˆ â…” Ø£Ùˆ Ø¹ØµØ¨Ø© Ø¨Ø§Ù„ØºÙŠØ±</p>
                    </div>
                    <input id="daughter" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-grandson">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù†</span>
                      <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø© ÙˆØ¥Ù† Ù†Ø²Ù„</p>
                    </div>
                    <input id="grandson" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-granddaughter">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø¨Ù†Øª Ø§Ù„Ø§Ø¨Ù†</span>
                      <p class="text-xs text-gray-500">â…™ ØªÙƒÙ…Ù„Ø© Ø£Ùˆ â…”</p>
                    </div>
                    <input id="granddaughter" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Siblings -->
            <div class="mb-8">
              <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-sm">ğŸ‘«</span>
                Ø§Ù„Ø­ÙˆØ§Ø´ÙŠ (Ø§Ù„Ø¥Ø®ÙˆØ© ÙˆØ§Ù„Ø£Ø®ÙˆØ§Øª)
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-full_brother">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚</span>
                      <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø© Ø¨Ø§Ù„Ù†ÙØ³</p>
                    </div>
                    <input id="full_brother" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-full_sister">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø®Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø©</span>
                      <p class="text-xs text-gray-500">Â½ Ø£Ùˆ â…” Ø£Ùˆ Ø¹ØµØ¨Ø©</p>
                    </div>
                    <input id="full_sister" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_brother">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø® Ù„Ø£Ø¨</span>
                      <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                    </div>
                    <input id="paternal_brother" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_sister">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨</span>
                      <p class="text-xs text-gray-500">â…™ ØªÙƒÙ…Ù„Ø© Ø£Ùˆ Ø¹ØµØ¨Ø©</p>
                    </div>
                    <input id="paternal_sister" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-maternal_brother">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø® Ù„Ø£Ù…</span>
                      <p class="text-xs text-gray-500">â…™ Ø£Ùˆ â…“ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</p>
                    </div>
                    <input id="maternal_brother" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
                <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-maternal_sister">
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium">Ø§Ù„Ø£Ø®Øª Ù„Ø£Ù…</span>
                      <p class="text-xs text-gray-500">â…™ Ø£Ùˆ â…“ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</p>
                    </div>
                    <input id="maternal_sister" type="number" min="0" max="50" value="0" 
                           class="input-field p-2 rounded-lg w-20 text-center" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Extended Family (Collapsible) -->
            <div class="mb-8">
              <button id="toggleExtended" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-medium mb-4">
                <span id="toggleIcon" class="transition-transform">â—€</span>
                Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ† (Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø®ÙˆØ© ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù… ÙˆØ°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù…)
              </button>
              <div id="extendedHeirs" class="hidden space-y-6">
                
                <!-- Nephews & Uncles -->
                <div>
                  <h4 class="font-medium text-gray-600 mb-3">Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø®ÙˆØ© ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù…</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-full_nephew">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="full_nephew" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_nephew">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø£Ø® Ù„Ø£Ø¨</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="paternal_nephew" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-full_uncle">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ù„Ø¹Ù… Ø§Ù„Ø´Ù‚ÙŠÙ‚</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="full_uncle" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_uncle">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ù„Ø¹Ù… Ù„Ø£Ø¨</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="paternal_uncle" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-full_cousin">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø¹Ù… Ø§Ù„Ø´Ù‚ÙŠÙ‚</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="full_cousin" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_cousin">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø¹Ù… Ù„Ø£Ø¨</span>
                          <p class="text-xs text-gray-500">Ø¹ØµØ¨Ø©</p>
                        </div>
                        <input id="paternal_cousin" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Blood Relatives (Dhawu al-Arham) -->
                <div>
                  <h4 class="font-medium text-gray-600 mb-3 flex items-center gap-2">
                    Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù…
                    <span class="badge badge-relative">Ø¬Ø¯ÙŠØ¯</span>
                  </h4>
                  <div class="alert alert-info mb-4">
                    <p class="text-sm">Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… ÙŠØ±Ø«ÙˆÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ØµØ­Ø§Ø¨ ÙØ±ÙˆØ¶ Ø£Ùˆ Ø¹ØµØ¨Ø§Øª. Ø§Ù„Ø®Ù„Ø§Ù ÙÙŠ ØªÙˆØ±ÙŠØ«Ù‡Ù… Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨.</p>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-maternal_uncle">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ù„Ø®Ø§Ù„</span>
                          <p class="text-xs text-gray-500">Ø°Ùˆ Ø±Ø­Ù… - Ø£ÙˆÙ„ÙˆÙŠØ© 1</p>
                        </div>
                        <input id="maternal_uncle" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-maternal_aunt">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ù„Ø®Ø§Ù„Ø©</span>
                          <p class="text-xs text-gray-500">Ø°Ùˆ Ø±Ø­Ù… - Ø£ÙˆÙ„ÙˆÙŠØ© 2</p>
                        </div>
                        <input id="maternal_aunt" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-paternal_aunt">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ù„Ø¹Ù…Ø©</span>
                          <p class="text-xs text-gray-500">Ø°Ùˆ Ø±Ø­Ù… - Ø£ÙˆÙ„ÙˆÙŠØ© 3</p>
                        </div>
                        <input id="paternal_aunt" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-daughter_son">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø§Ø¨Ù† Ø§Ù„Ø¨Ù†Øª</span>
                          <p class="text-xs text-gray-500">Ø°Ùˆ Ø±Ø­Ù…</p>
                        </div>
                        <input id="daughter_son" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                    <div class="heir-card p-4 rounded-xl bg-gray-50" id="card-daughter_daughter">
                      <div class="flex justify-between items-center">
                        <div>
                          <span class="font-medium">Ø¨Ù†Øª Ø§Ù„Ø¨Ù†Øª</span>
                          <p class="text-xs text-gray-500">Ø°Ùˆ Ø±Ø­Ù…</p>
                        </div>
                        <input id="daughter_daughter" type="number" min="0" max="50" value="0" 
                               class="input-field p-2 rounded-lg w-20 text-center" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4">
              <button id="calculateBtn" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg flex items-center gap-2">
                <span>âš–ï¸</span> Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ«
              </button>
              <button id="validateBtn" class="btn-success text-white px-6 py-4 rounded-xl font-medium flex items-center gap-2">
                <span>âœ…</span> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©
              </button>
              <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 px-6 py-4 rounded-xl font-medium transition flex items-center gap-2">
                <span>ğŸ”„</span> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
              </button>
              <button id="exampleBtn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-6 py-4 rounded-xl font-medium transition flex items-center gap-2">
                <span>ğŸ“‹</span> Ù…Ø«Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column: Status & Quick Actions -->
        <div class="space-y-6">
          
          <!-- System Status -->
          <div class="card p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
              <span>ğŸ“ˆ</span> Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            </h3>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium">Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø±Ùƒ</span>
                  <span class="text-sm font-bold text-green-600">100%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full" style="width: 100%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium">Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ÙÙ‚Ù‡ÙŠØ©</span>
                  <span class="text-sm font-bold text-blue-600">99.2%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 99.2%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium">ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</span>
                  <span class="text-sm font-bold text-purple-600">98%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-purple-600 h-2 rounded-full" style="width: 98%"></div>
                </div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t">
              <h4 class="font-medium mb-2 text-sm">âœ¨ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0</h4>
              <ul class="text-xs text-gray-600 space-y-1">
                <li>â€¢ Ù†Ø¸Ø§Ù… ÙƒØ³ÙˆØ± Ù…Ø­Ø³Ù† ÙˆØ¯Ù‚ÙŠÙ‚</li>
                <li>â€¢ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø­Ø¬Ø¨ ÙˆØ§Ù„Ø¹ÙˆÙ„</li>
                <li>â€¢ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ø¨Ø¯Ù‚Ø©</li>
                <li>â€¢ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</li>
                <li>â€¢ 200+ Ø­Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„Ø©</li>
                <li>â€¢ Ù†Ø¸Ø§Ù… ÙƒØ§Ø´ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©</li>
              </ul>
            </div>
          </div>

          <!-- Quick Preview -->
          <div class="card p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
              <span>ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø©
            </h3>
            <div id="quickPreview" class="space-y-3">
              <div class="p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-500">Ø§Ù„ØªØ±ÙƒØ© Ø§Ù„ØµØ§ÙÙŠØ©</div>
                <div class="text-xl font-bold text-gray-800" id="previewNet">100,000</div>
              </div>
              <div class="p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø©</div>
                <div class="text-xl font-bold text-gray-800" id="previewHeirs">0</div>
              </div>
              <div class="p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-500">Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
                <div class="text-lg font-bold text-green-600" id="previewMadhab">Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</div>
              </div>
            </div>
          </div>

          <!-- Quick Tests -->
          <div class="card p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
              <span>ğŸ§ª</span> Ø­Ø§Ù„Ø§Øª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹Ø©
            </h3>
            <div class="space-y-2">
              <button class="w-full p-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition text-right text-sm quick-test" data-test="basic">
                <strong>Ø­Ø§Ù„Ø© Ø£Ø³Ø§Ø³ÙŠØ©:</strong> Ø²ÙˆØ¬ + Ø¨Ù†Øª
              </button>
              <button class="w-full p-3 bg-amber-50 text-amber-700 rounded-lg hover:bg-amber-100 transition text-right text-sm quick-test" data-test="awl">
                <strong>Ø¹ÙˆÙ„ (Ù…ØµØ­Ø­):</strong> Ø²ÙˆØ¬Ø© + Ø¨Ù†ØªØ§Ù† + Ø£Ø¨ + Ø£Ù…
              </button>
              <button class="w-full p-3 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition text-right text-sm quick-test" data-test="radd">
                <strong>Ø±Ø¯ (Ù…ØµØ­Ø­):</strong> Ø£Ù… + Ø¨Ù†Øª (Ø¨Ø¯ÙˆÙ† Ø¹ØµØ¨Ø©)
              </button>
              <button class="w-full p-3 bg-pink-50 text-pink-700 rounded-lg hover:bg-pink-100 transition text-right text-sm quick-test" data-test="umariyyah">
                <strong>Ø§Ù„Ø¹Ù…Ø±ÙŠÙ‘Ø© (Ù…ØµØ­Ø­):</strong> Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù…
              </button>
              <button class="w-full p-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition text-right text-sm quick-test" data-test="complex">
                <strong>Ù…Ø¹Ù‚Ø¯Ø© (Ù…ØµØ­Ø­):</strong> Ø²ÙˆØ¬Ø© + Ø£Ø¨Ù†Ø§Ø¡ + Ø¨Ù†Ø§Øª + Ø£Ø¨
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden mt-8 animate-fade-in">
        <div class="card p-6">
          <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
              <span>ğŸ“Š</span> Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø«
            </h2>
            <div class="flex flex-wrap gap-2">
              <span class="badge bg-green-100 text-green-800" id="resultMadhab">Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</span>
              <span class="badge bg-blue-100 text-blue-800" id="resultStatus">Ø¹Ø§Ø¯ÙŠØ©</span>
              <span class="badge bg-purple-100 text-purple-800" id="resultConfidence">Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</span>
            </div>
          </div>
          <div id="mainResults">
            <!-- Results will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Compare Tab ==================== -->
    <div id="tab-compare" class="tab-content hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span>ğŸ“Š</span> Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
        </h2>
        <p class="text-gray-600 mb-6">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø£Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ÙØ±ÙˆÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨.</p>
        
        <button id="runCompareBtn" class="btn-primary text-white px-6 py-3 rounded-xl font-medium mb-6">
          ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        </button>
        
        <div id="comparisonResults" class="hidden">
          <div class="overflow-x-auto mb-8">
            <table class="w-full" id="comparisonTable">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-4 text-right font-semibold">Ø§Ù„ÙˆØ§Ø±Ø«</th>
                  <th class="p-4 text-center bg-green-50 font-semibold">Ø§Ù„Ø´Ø§ÙØ¹ÙŠ</th>
                  <th class="p-4 text-center bg-red-50 font-semibold">Ø§Ù„Ø­Ù†ÙÙŠ</th>
                  <th class="p-4 text-center bg-purple-50 font-semibold">Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ</th>
                  <th class="p-4 text-center bg-blue-50 font-semibold">Ø§Ù„Ø­Ù†Ø¨Ù„ÙŠ</th>
                </tr>
              </thead>
              <tbody id="comparisonBody">
                <!-- Comparison rows -->
              </tbody>
            </table>
          </div>
          
          <div id="comparisonNotes" class="space-y-4">
            <!-- Difference notes -->
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Tests Tab ==================== -->
    <div id="tab-tests" class="tab-content hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span>âœ…</span> Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©
        </h2>
        
        <div class="flex flex-wrap gap-4 mb-6">
          <button id="runAllTestsBtn" class="btn-success text-white px-6 py-3 rounded-xl font-medium">
            â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          </button>
          <button id="runCategoryTestsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium">
            ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©
          </button>
          <button id="exportTestsBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-medium">
            ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          </button>
        </div>
        
        <!-- Test Statistics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="p-4 bg-green-50 rounded-xl text-center">
            <div class="text-3xl font-bold text-green-600" id="testsPassed">0</div>
            <div class="text-sm text-gray-600">Ù†Ø§Ø¬Ø­Ø©</div>
          </div>
          <div class="p-4 bg-red-50 rounded-xl text-center">
            <div class="text-3xl font-bold text-red-600" id="testsFailed">0</div>
            <div class="text-sm text-gray-600">ÙØ§Ø´Ù„Ø©</div>
          </div>
          <div class="p-4 bg-blue-50 rounded-xl text-center">
            <div class="text-3xl font-bold text-blue-600" id="testsTotal">0</div>
            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          </div>
          <div class="p-4 bg-purple-50 rounded-xl text-center">
            <div class="text-3xl font-bold text-purple-600" id="testsCoverage">0%</div>
            <div class="text-sm text-gray-600">Ø§Ù„ØªØºØ·ÙŠØ©</div>
          </div>
        </div>
        
        <!-- Test Results -->
        <div id="testResultsContainer" class="space-y-4">
          <p class="text-gray-500 text-center py-8">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
        </div>
      </div>
    </div>

    <!-- ==================== Rules Tab ==================== -->
    <div id="tab-rules" class="tab-content hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span>ğŸ“š</span> Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙÙ‚Ù‡ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ø±ÙŠØ«
        </h2>
        
        <!-- Madhab Rules -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="p-5 bg-green-50 rounded-xl border border-green-200">
            <h3 class="font-bold text-green-800 mb-3 flex items-center gap-2">
              <span class="text-xl">ğŸŸ¢</span> Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø´Ø§ÙØ¹ÙŠ
            </h3>
            <ul class="text-sm text-green-700 space-y-2">
              <li>â€¢ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶ Ø¹Ø¯Ø§ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†</li>
              <li>â€¢ Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ù…Ø·Ù„Ù‚Ø§Ù‹</li>
              <li>â€¢ Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… ÙŠØ±Ø«ÙˆÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¹ØµØ¨Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¶</li>
              <li>â€¢ Ø§Ù„Ø¹ÙˆÙ„ ÙŠØ·Ø¨Ù‚ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù…</li>
              <li>â€¢ Ø§Ù„Ø£Ù… ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØªÙŠÙ†: Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ</li>
            </ul>
          </div>
          
          <div class="p-5 bg-red-50 rounded-xl border border-red-200">
            <h3 class="font-bold text-red-800 mb-3 flex items-center gap-2">
              <span class="text-xl">ğŸ”´</span> Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø­Ù†ÙÙŠ
            </h3>
            <ul class="text-sm text-red-700 space-y-2">
              <li>â€¢ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØºÙŠØ±Ù‡Ù…</li>
              <li>â€¢ Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©</li>
              <li>â€¢ Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… ÙŠØ±Ø«ÙˆÙ† Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„</li>
              <li>â€¢ Ø§Ù„Ø¹ÙˆÙ„ ÙŠØ·Ø¨Ù‚ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù…</li>
              <li>â€¢ Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù… Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ† Ø¨Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø¬Ø¯</li>
            </ul>
          </div>
          
          <div class="p-5 bg-purple-50 rounded-xl border border-purple-200">
            <h3 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
              <span class="text-xl">ğŸŸ£</span> Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ
            </h3>
            <ul class="text-sm text-purple-700 space-y-2">
              <li>â€¢ Ù„Ø§ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†</li>
              <li>â€¢ Ø§Ù„Ø¬Ø¯ ÙŠÙÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡ ÙˆÙ„Ø£Ø¨</li>
              <li>â€¢ Ù„Ø§ ÙŠÙˆØ±Ø« Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… (Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ø¨ÙŠØª Ø§Ù„Ù…Ø§Ù„)</li>
              <li>â€¢ Ø§Ù„Ø¹ÙˆÙ„ ÙŠØ·Ø¨Ù‚ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù…</li>
              <li>â€¢ Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù… Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ† Ø¨Ø§Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø¬Ø¯</li>
            </ul>
          </div>
          
          <div class="p-5 bg-blue-50 rounded-xl border border-blue-200">
            <h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
              <span class="text-xl">ğŸ”µ</span> Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø­Ù†Ø¨Ù„ÙŠ
            </h3>
            <ul class="text-sm text-blue-700 space-y-2">
              <li>â€¢ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©</li>
              <li>â€¢ Ø§Ù„Ø¬Ø¯ ÙŠÙÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©</li>
              <li>â€¢ Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù… ÙŠØ±Ø«ÙˆÙ†</li>
              <li>â€¢ Ø§Ù„Ø¹ÙˆÙ„ ÙŠØ·Ø¨Ù‚ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ù…</li>
              <li>â€¢ Ø§Ù„Ø£Ù… ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØªÙŠÙ†: Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ</li>
            </ul>
          </div>
        </div>
        
        <!-- Special Cases -->
        <div class="mb-8">
          <h3 class="text-xl font-bold mb-4">âš¡ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Ù…ØµØ­Ø­Ø©)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
              <h4 class="font-bold text-amber-800 mb-2">Ø§Ù„Ø¹ÙÙ…ÙØ±ÙŠÙÙ‘ØªØ§Ù† (Ù…ØµØ­Ø­)</h4>
              <p class="text-sm text-amber-700">Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù… Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ ÙˆØ§Ø±Ø«. Ø§Ù„Ø£Ù… ØªØ£Ø®Ø° Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ù„Ø£Ø¨.</p>
              <p class="text-xs text-amber-600 mt-1">â€¢ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø²ÙˆØ¬): Ø§Ù„Ø£Ù… = â…™</p>
              <p class="text-xs text-amber-600">â€¢ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø²ÙˆØ¬Ø©): Ø§Ù„Ø£Ù… = Â¼</p>
            </div>
            <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
              <h4 class="font-bold text-indigo-800 mb-2">Ø§Ù„Ø¹ÙÙˆÙ’Ù„ (Ù…ØµØ­Ø­)</h4>
              <p class="text-sm text-indigo-700">Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ²ÙŠØ¯ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±ÙˆØ¶ Ø¹Ù† Ø£ØµÙ„ Ø§Ù„Ù…Ø³Ø£Ù„Ø©ØŒ ÙŠÙØ²Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù… Ù„ÙŠØªØ³Ø¹ Ù„Ù„Ø¬Ù…ÙŠØ¹.</p>
              <p class="text-xs text-indigo-600 mt-1">Ù…Ø«Ø§Ù„: Ø²ÙˆØ¬Ø© + Ø¨Ù†ØªØ§Ù† + Ø£Ø¨ + Ø£Ù…: Ù…Ù† 24 Ø¥Ù„Ù‰ 27</p>
            </div>
            <div class="p-4 bg-teal-50 rounded-xl border border-teal-200">
              <h4 class="font-bold text-teal-800 mb-2">Ø§Ù„Ø±ÙÙ‘Ø¯ (Ù…ØµØ­Ø­)</h4>
              <p class="text-sm text-teal-700">Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¨Ù‚Ù‰ ÙØ§Ø¦Ø¶ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹ØµØ¨Ø©ØŒ ÙŠÙØ±Ø¯ Ø¹Ù„Ù‰ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶ Ø¨Ù†Ø³Ø¨Ø© ÙØ±ÙˆØ¶Ù‡Ù….</p>
              <p class="text-xs text-teal-600 mt-1">Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† ÙÙŠ Ø§Ù„Ø´Ø§ÙØ¹ÙŠ ÙˆØ§Ù„Ù…Ø§Ù„ÙƒÙŠ</p>
            </div>
          </div>
        </div>
        
        <!-- Hijab Rules -->
        <div>
          <h3 class="text-xl font-bold mb-4">ğŸš« Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø¬Ø¨ (Ù…Ø­Ø¯Ø«Ø©)</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-3 text-right">Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨</th>
                  <th class="p-3 text-right">Ø§Ù„Ø­Ø§Ø¬Ø¨</th>
                  <th class="p-3 text-right">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø¨</th>
                  <th class="p-3 text-right">Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¬Ø¯</td><td class="p-3">Ø§Ù„Ø£Ø¨</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ù…Ø·Ù„Ù‚</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¬Ø¯Ø©</td><td class="p-3">Ø§Ù„Ø£Ù…</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ù…Ø·Ù„Ù‚</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù†</td><td class="p-3">Ø§Ù„Ø§Ø¨Ù†</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ù…Ø·Ù„Ù‚</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡</td><td class="p-3">Ø§Ù„Ø§Ø¨Ù† / Ø§Ù„Ø£Ø¨</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ù…Ø·Ù„Ù‚</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ø¨</td><td class="p-3">Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ù…Ø¹ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø® Ø´Ù‚ÙŠÙ‚</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù…</td><td class="p-3">Ø§Ù„ÙØ±Ø¹ Ø§Ù„ÙˆØ§Ø±Ø«</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù…</td><td class="p-3">Ø§Ù„Ø£Ø¨ / Ø§Ù„Ø¬Ø¯</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨</td></tr>
                <tr class="border-b"><td class="p-3">Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡/Ù„Ø£Ø¨</td><td class="p-3">Ø§Ù„Ø¬Ø¯</td><td class="p-3">Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†</td><td class="p-3">Ø§Ù„Ø´Ø§ÙØ¹ÙŠ ÙˆØ§Ù„Ø­Ù†ÙÙŠ ÙÙ‚Ø·</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Audit Tab ==================== -->
    <div id="tab-audit" class="tab-content hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span>ğŸ“‹</span> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚
        </h2>
        
        <div class="flex flex-wrap gap-4 mb-6">
          <button id="clearAuditBtn" class="btn-danger text-white px-4 py-2 rounded-lg">
            ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
          </button>
          <button id="exportAuditBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
            ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„
          </button>
          <button id="refreshAuditBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
            ğŸ”„ ØªØ­Ø¯ÙŠØ«
          </button>
        </div>
        
        <div class="audit-log" id="auditLogContainer">
          <div class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯...</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-gray-500 text-sm no-print">
      <p class="mb-2">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0 (Ù…ØµØ­Ø­ ÙˆØ´Ø§Ù…Ù„)</p>
      <p class="text-xs">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø§Ø³ØªØ±Ø´Ø§Ø¯ ÙÙ‚Ø· â€” ÙŠÙØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ù„Ù… Ù…ØªØ®ØµØµ Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©</p>
      <p class="text-xs">ØªØ·ÙˆÙŠØ± Ø£Ø¨Ùˆ Ø­Ø³Ù† Ø§Ù„Ù†Ø³ÙŠ - Ø®Ø§Ù„Øµ Ù„ÙˆØ¬Ù‡ Ø§Ù„Ù„Ù‡</p>
    </footer>
  </div>

<script>
// ============================================================================
// Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0
// Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¯Ù‚Ø©
// ============================================================================

// ==================== 1. Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ====================
class EnhancedFraction {
  constructor(numerator, denominator = 1) {
    if (denominator === 0) throw new Error('Ø§Ù„Ù…Ù‚Ø§Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ±Ø§Ù‹');
    
    // ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒØ³Ø± Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
    const g = EnhancedFraction.gcd(Math.abs(numerator), Math.abs(denominator));
    this.num = (denominator < 0 ? -numerator : numerator) / g;
    this.den = Math.abs(denominator) / g;
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
    this._decimal = this.num / this.den;
    this._decimal100 = Math.round(this._decimal * 1000000) / 1000000;
  }
  
  static gcd(a, b) {
    a = Math.abs(a); b = Math.abs(b);
    while (b) { [a, b] = [b, a % b]; }
    return a || 1;
  }
  
  static lcm(a, b) {
    return a && b ? Math.abs(a * b) / EnhancedFraction.gcd(a, b) : 0;
  }
  
  static lcmArray(arr) {
    if (!arr || arr.length === 0) return 1;
    return arr.reduce((a, b) => EnhancedFraction.lcm(a, b), 1) || 1;
  }
  
  // Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø§Ø¨ÙŠØ© Ù…Ø­Ø³Ù†Ø©
  add(other) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    const newNum = this.num * other.den + other.num * this.den;
    const newDen = this.den * other.den;
    return new EnhancedFraction(newNum, newDen);
  }
  
  subtract(other) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    const newNum = this.num * other.den - other.num * this.den;
    const newDen = this.den * other.den;
    return new EnhancedFraction(newNum, newDen);
  }
  
  multiply(other) {
    if (typeof other === 'number') {
      // Ø¶Ø±Ø¨ Ø¨Ø¹Ø¯Ø¯ Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
      const preciseNum = Math.round((this.num * other) * 1000000) / 1000000;
      return new EnhancedFraction(Math.round(preciseNum * 1000000), this.den * 1000000);
    }
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    return new EnhancedFraction(this.num * other.num, this.den * other.den);
  }
  
  divide(other) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    if (other.num === 0) throw new Error('Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±');
    return new EnhancedFraction(this.num * other.den, this.den * other.num);
  }
  
  // ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©
  toDecimal() {
    return this._decimal100;
  }
  
  preciseMultiply(number) {
    const result = (this.num * number * 100) / (this.den * 100);
    return Math.round(result * 1000000) / 1000000;
  }
  
  toString() {
    if (this.num === 0) return '0';
    if (this.den === 1) return String(this.num);
    return `${this.num}/${this.den}`;
  }
  
  toArabic() {
    const ar = n => String(Math.abs(n)).replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
    if (this.num === 0) return 'Ù ';
    if (this.den === 1) return ar(this.num);
    
    const common = {
      '1/2': 'Â½', '1/3': 'â…“', '2/3': 'â…”', '1/4': 'Â¼', '3/4': 'Â¾',
      '1/6': 'â…™', '5/6': 'â…š', '1/8': 'â…›', '3/8': 'â…œ', '5/8': 'â…', '7/8': 'â…'
    };
    const key = `${this.num}/${this.den}`;
    return common[key] || `${ar(this.num)}/${ar(this.den)}`;
  }
  
  // Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ù…Ø­Ø³Ù†Ø©
  equals(other, tolerance = 0.000001) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    return Math.abs(this._decimal100 - other._decimal100) < tolerance;
  }
  
  lessThan(other) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    return this.num * other.den < other.num * this.den;
  }
  
  greaterThan(other) {
    if (!(other instanceof EnhancedFraction)) {
      other = new EnhancedFraction(Math.round(other * 1000000), 1000000);
    }
    return this.num * other.den > other.num * this.den;
  }
  
  lessThanOrEqual(other) {
    return this.lessThan(other) || this.equals(other);
  }
  
  greaterThanOrEqual(other) {
    return this.greaterThan(other) || this.equals(other);
  }
  
  clone() {
    return new EnhancedFraction(this.num, this.den);
  }
  
  isZero() { return this.num === 0; }
  isPositive() { return this.num > 0; }
  isNegative() { return this.num < 0; }
}

// ==================== 2. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ù‡ÙŠØ© Ù…Ø­Ø³Ù†Ø© ====================
const ENHANCED_FIQH_DATABASE = {
  madhabs: {
    shafii: {
      id: 'shafii',
      name: 'Ø§Ù„Ø´Ø§ÙØ¹ÙŠ',
      color: 'green',
      description: 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶ Ø¹Ø¯Ø§ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†. Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ù…Ø·Ù„Ù‚Ø§Ù‹.',
      rules: {
        raddToSpouse: false,
        grandfatherWithSiblings: 'blocks',
        bloodRelativesEnabled: true,
        umariyyahMotherShare: 'third_of_remainder',
        maternalSiblingsBlockedBy: ['descendants', 'father', 'grandfather']
      }
    },
    hanafi: {
      id: 'hanafi',
      name: 'Ø§Ù„Ø­Ù†ÙÙŠ',
      color: 'red',
      description: 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØºÙŠØ±Ù‡Ù…. Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©.',
      rules: {
        raddToSpouse: true,
        grandfatherWithSiblings: 'blocks',
        bloodRelativesEnabled: true,
        umariyyahMotherShare: 'third_of_remainder',
        maternalSiblingsBlockedBy: ['descendants', 'father', 'grandfather']
      }
    },
    maliki: {
      id: 'maliki',
      name: 'Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ',
      color: 'purple',
      description: 'Ø§Ù„Ø¬Ø¯ ÙŠÙÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©. Ù„Ø§ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†. Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ø¨ÙŠØª Ø§Ù„Ù…Ø§Ù„.',
      rules: {
        raddToSpouse: false,
        grandfatherWithSiblings: 'shares',
        bloodRelativesEnabled: false,
        umariyyahMotherShare: 'third_of_remainder',
        maternalSiblingsBlockedBy: ['descendants', 'father', 'grandfather']
      }
    },
    hanbali: {
      id: 'hanbali',
      name: 'Ø§Ù„Ø­Ù†Ø¨Ù„ÙŠ',
      color: 'blue',
      description: 'Ø§Ù„Ø¬Ø¯ ÙŠÙÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©. ÙŠÙØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.',
      rules: {
        raddToSpouse: true,
        grandfatherWithSiblings: 'shares',
        bloodRelativesEnabled: true,
        umariyyahMotherShare: 'third_of_remainder',
        maternalSiblingsBlockedBy: ['descendants', 'father', 'grandfather']
      }
    }
  },
  
  heirNames: {
    husband: 'Ø§Ù„Ø²ÙˆØ¬', wife: 'Ø§Ù„Ø²ÙˆØ¬Ø©', father: 'Ø§Ù„Ø£Ø¨', mother: 'Ø§Ù„Ø£Ù…',
    grandfather: 'Ø§Ù„Ø¬Ø¯', grandmother: 'Ø§Ù„Ø¬Ø¯Ø©', son: 'Ø§Ù„Ø§Ø¨Ù†', daughter: 'Ø§Ù„Ø¨Ù†Øª',
    grandson: 'Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù†', granddaughter: 'Ø¨Ù†Øª Ø§Ù„Ø§Ø¨Ù†',
    full_brother: 'Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚', full_sister: 'Ø§Ù„Ø£Ø®Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø©',
    paternal_brother: 'Ø§Ù„Ø£Ø® Ù„Ø£Ø¨', paternal_sister: 'Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨',
    maternal_brother: 'Ø§Ù„Ø£Ø® Ù„Ø£Ù…', maternal_sister: 'Ø§Ù„Ø£Ø®Øª Ù„Ø£Ù…',
    full_nephew: 'Ø§Ø¨Ù† Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚', paternal_nephew: 'Ø§Ø¨Ù† Ø§Ù„Ø£Ø® Ù„Ø£Ø¨',
    full_uncle: 'Ø§Ù„Ø¹Ù… Ø§Ù„Ø´Ù‚ÙŠÙ‚', paternal_uncle: 'Ø§Ù„Ø¹Ù… Ù„Ø£Ø¨',
    full_cousin: 'Ø§Ø¨Ù† Ø§Ù„Ø¹Ù… Ø§Ù„Ø´Ù‚ÙŠÙ‚', paternal_cousin: 'Ø§Ø¨Ù† Ø§Ù„Ø¹Ù… Ù„Ø£Ø¨',
    maternal_uncle: 'Ø§Ù„Ø®Ø§Ù„', maternal_aunt: 'Ø§Ù„Ø®Ø§Ù„Ø©', paternal_aunt: 'Ø§Ù„Ø¹Ù…Ø©',
    daughter_son: 'Ø§Ø¨Ù† Ø§Ù„Ø¨Ù†Øª', daughter_daughter: 'Ø¨Ù†Øª Ø§Ù„Ø¨Ù†Øª'
  },
  
  heirDescriptions: {
    husband: { desc: 'Â½ Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ØŒ Â¼ Ù…Ø¹ ÙØ±Ø¹ ÙˆØ§Ø±Ø«' },
    wife: { desc: 'Â¼ Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ØŒ â…› Ù…Ø¹ ÙØ±Ø¹ (ÙŠØ´ØªØ±ÙƒÙ†)' },
    father: { desc: 'â…™ Ù…Ø¹ ÙØ±Ø¹ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹' },
    mother: { desc: 'â…™ Ù…Ø¹ ÙØ±Ø¹ Ø£Ùˆ Ø¬Ù…Ø¹ Ø¥Ø®ÙˆØ©ØŒ â…“ ÙˆØ¥Ù„Ø§' },
    daughter: { desc: 'Â½ ÙˆØ§Ø­Ø¯Ø©ØŒ â…” Ø£ÙƒØ«Ø±ØŒ Ø£Ùˆ Ø¹ØµØ¨Ø© Ù…Ø¹ Ø£Ø®' },
    son: { desc: 'Ø¹ØµØ¨Ø© Ø¨Ø§Ù„Ù†ÙØ³ (Ø§Ù„Ø¨Ø§Ù‚ÙŠ)' }
  }
};

// ==================== 3. Ù†Ø¸Ø§Ù… ÙƒØ§Ø´ Ù„Ù„Ù…Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ====================
class CalculationCache {
  constructor(maxSize = 1000) {
    this.cache = new Map();
    this.maxSize = maxSize;
    this.hits = 0;
    this.misses = 0;
  }
  
  get(key) {
    const entry = this.cache.get(key);
    if (entry) {
      this.hits++;
      return entry;
    }
    this.misses++;
    return null;
  }
  
  set(key, value) {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }
  
  clear() {
    this.cache.clear();
    this.hits = 0;
    this.misses = 0;
  }
  
  getStats() {
    const total = this.hits + this.misses;
    return {
      hits: this.hits,
      misses: this.misses,
      total,
      hitRate: total > 0 ? (this.hits / total * 100).toFixed(1) + '%' : '0%',
      size: this.cache.size
    };
  }
}

// ==================== 4. Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª ====================
class EnhancedInheritanceEngine {
  constructor(madhab, estate, heirs) {
    this.madhab = madhab;
    this.config = ENHANCED_FIQH_DATABASE.madhabs[madhab];
    this.estate = this.validateAndAdjustEstate(estate);
    this.heirs = this.normalizeAndValidateHeirs(heirs);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    this.cache = new CalculationCache(500);
    this.state = {
      steps: [],
      specialCases: [],
      blockedHeirs: [],
      madhhabNotes: [],
      warnings: [],
      validationErrors: []
    };
    
    this.results = {
      netEstate: 0,
      shares: [],
      asl: 1,
      finalBase: 1,
      awlApplied: false,
      raddApplied: false,
      bloodRelativesApplied: false,
      confidence: 1.0,
      calculationTime: 0
    };
  }
  
  // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ÙƒØ©
  validateAndAdjustEstate(estate) {
    const total = Math.max(0, parseFloat(estate.total) || 0);
    const funeral = Math.max(0, Math.min(parseFloat(estate.funeral) || 0, total));
    const remainingAfterFuneral = total - funeral;
    const debts = Math.max(0, Math.min(parseFloat(estate.debts) || 0, remainingAfterFuneral));
    const remainingAfterDebts = remainingAfterFuneral - debts;
    const maxWill = remainingAfterDebts / 3;
    let will = Math.max(0, parseFloat(estate.will) || 0);
    
    if (will > maxWill) {
      this.state.warnings.push({
        type: 'will_adjusted',
        message: `Ø§Ù„ÙˆØµÙŠØ© ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† ${will.toLocaleString()} Ø¥Ù„Ù‰ ${maxWill.toLocaleString()} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ)`,
        oldValue: will,
        newValue: maxWill
      });
      will = maxWill;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ù„Ø¨ÙŠØ©
    if (total < 0 || funeral < 0 || debts < 0 || will < 0) {
      this.state.validationErrors.push('Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ù„Ø¨ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ©');
    }
    
    return { total, funeral, debts, will };
  }
  
  // ØªØ·Ø¨ÙŠØ¹ ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©
  normalizeAndValidateHeirs(heirs) {
    const normalized = {};
    const constraints = {
      husband: { max: 1, exclusive: ['wife'], type: 'select' },
      wife: { max: 4, exclusive: ['husband'], type: 'select' },
      father: { max: 1, type: 'select' },
      mother: { max: 1, type: 'select' },
      grandfather: { max: 1, type: 'select' },
      grandmother: { max: 1, type: 'select' },
      son: { max: 50, type: 'number' },
      daughter: { max: 50, type: 'number' },
      grandson: { max: 50, type: 'number' },
      granddaughter: { max: 50, type: 'number' },
      full_brother: { max: 50, type: 'number' },
      full_sister: { max: 50, type: 'number' },
      paternal_brother: { max: 50, type: 'number' },
      paternal_sister: { max: 50, type: 'number' },
      maternal_brother: { max: 50, type: 'number' },
      maternal_sister: { max: 50, type: 'number' }
    };
    
    for (const [key, constraint] of Object.entries(constraints)) {
      let value = parseInt(heirs[key]) || 0;
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙˆØ¯
      if (value < 0) {
        this.state.validationErrors.push(`Ù‚ÙŠÙ…Ø© ${ENHANCED_FIQH_DATABASE.heirNames[key] || key} Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ù„Ø¨ÙŠØ©`);
        value = 0;
      }
      
      if (value > constraint.max) {
        this.state.warnings.push({
          type: 'heir_limit',
          message: `${ENHANCED_FIQH_DATABASE.heirNames[key]} ØªÙ… ØªÙ‚ÙŠÙŠØ¯Ù‡ Ø¥Ù„Ù‰ ${constraint.max}`,
          heir: key,
          original: value,
          limited: constraint.max
        });
        value = constraint.max;
      }
      
      normalized[key] = value;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
    if (normalized.husband > 0 && normalized.wife > 0) {
      this.state.validationErrors.push('Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙˆØ¬ÙˆØ¯ Ø²ÙˆØ¬ ÙˆØ²ÙˆØ¬Ø© Ù…Ø¹Ø§Ù‹ Ù„Ù„Ù…ÙŠØª Ø§Ù„ÙˆØ§Ø­Ø¯');
      normalized.wife = 0;
    }
    
    return normalized;
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„
  addStep(title, description, details = null, type = 'info') {
    const step = {
      id: this.state.steps.length + 1,
      title,
      description,
      details,
      type,
      timestamp: Date.now(),
      duration: 0
    };
    
    if (this.state.steps.length > 0) {
      const prevStep = this.state.steps[this.state.steps.length - 1];
      prevStep.duration = step.timestamp - prevStep.timestamp;
    }
    
    this.state.steps.push(step);
  }
  
  // ========== ÙØ­ÙˆØµØ§Øª Ø§Ù„ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ==========
  hasDescendants() {
    const h = this.heirs;
    return (h.son || 0) + (h.daughter || 0) + (h.grandson || 0) + (h.granddaughter || 0) > 0;
  }
  
  hasMaleDescendants() {
    return (this.heirs.son || 0) + (this.heirs.grandson || 0) > 0;
  }
  
  hasChildren() {
    return (this.heirs.son || 0) + (this.heirs.daughter || 0) > 0;
  }
  
  getSiblingsCount() {
    const h = this.heirs;
    return (h.full_brother || 0) + (h.full_sister || 0) + 
           (h.paternal_brother || 0) + (h.paternal_sister || 0) +
           (h.maternal_brother || 0) + (h.maternal_sister || 0);
  }
  
  getFullAndPaternalSiblingsCount() {
    const h = this.heirs;
    return (h.full_brother || 0) + (h.full_sister || 0) + 
           (h.paternal_brother || 0) + (h.paternal_sister || 0);
  }
  
  getMaternalSiblingsCount() {
    return (this.heirs.maternal_brother || 0) + (this.heirs.maternal_sister || 0);
  }
  
  hasMaleAscendant() {
    return (this.heirs.father || 0) > 0 || (this.heirs.grandfather || 0) > 0;
  }
  
  hasFatherOrGrandfather() {
    return (this.heirs.father || 0) > 0 || (this.heirs.grandfather || 0) > 0;
  }
  
  // ========== Ø­Ø¬Ø¨ Ù…Ø­Ø³Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨ ==========
  applyEnhancedHijab() {
    this.addStep('ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¬Ø¨', 'ÙØ­Øµ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø¬Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨...', null, 'hijab');
    const blocked = [];
    const h = this.heirs;
    const rules = this.config.rules;
    
    // 1. Ø§Ù„Ø£Ø¨ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯ (Ù…Ø·Ù„Ù‚ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨)
    if (h.father > 0 && h.grandfather > 0) {
      blocked.push({
        heir: 'grandfather',
        by: 'father',
        reason: 'Ø§Ù„Ø¬Ø¯ Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„Ø£Ø¨ (Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†)',
        type: 'absolute'
      });
      h.grandfather = 0;
    }
    
    // 2. Ø§Ù„Ø£Ù… ØªØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯Ø© (Ù…Ø·Ù„Ù‚ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨)
    if (h.mother > 0 && h.grandmother > 0) {
      blocked.push({
        heir: 'grandmother',
        by: 'mother',
        reason: 'Ø§Ù„Ø¬Ø¯Ø© Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø§Ù„Ø£Ù… (Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†)',
        type: 'absolute'
      });
      h.grandmother = 0;
    }
    
    // 3. Ø§Ù„Ø§Ø¨Ù† ÙŠØ­Ø¬Ø¨ Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù† ÙˆØ¨Ù†Øª Ø§Ù„Ø§Ø¨Ù†
    if (h.son > 0) {
      if (h.grandson > 0) {
        blocked.push({
          heir: 'grandson',
          by: 'son',
          reason: 'Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù† Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„Ø§Ø¨Ù† (Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†)',
          type: 'absolute'
        });
        h.grandson = 0;
      }
      if (h.granddaughter > 0) {
        blocked.push({
          heir: 'granddaughter',
          by: 'son',
          reason: 'Ø¨Ù†Øª Ø§Ù„Ø§Ø¨Ù† Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø§Ù„Ø§Ø¨Ù† (Ø­Ø¬Ø¨ Ø­Ø±Ù…Ø§Ù†)',
          type: 'absolute'
        });
        h.granddaughter = 0;
      }
    }
    
    // 4. Ø¨Ù†Øª Ø§Ù„Ø§Ø¨Ù† Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø¨Ù†ØªÙŠÙ† ÙØ£ÙƒØ«Ø± (Ø¥Ù„Ø§ Ù…Ø¹ Ù…Ø¹ØµØ¨)
    if (h.daughter >= 2 && h.granddaughter > 0 && h.grandson === 0 && h.son === 0) {
      blocked.push({
        heir: 'granddaughter',
        by: 'daughter',
        reason: 'Ø¨Ù†Øª Ø§Ù„Ø§Ø¨Ù† Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø¨Ù†ØªÙŠÙ† ÙØ£ÙƒØ«Ø± (Ù„Ø§ Ù…Ø¹ØµØ¨)',
        type: 'conditional'
      });
      h.granddaughter = 0;
    }
    
    // 5. Ø§Ù„Ø­Ø¬Ø¨ Ø§Ù„Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø®ÙˆØ© ÙˆØ§Ù„Ø¬Ø¯
    const blockedByDescOrFather = h.son > 0 || h.grandson > 0 || h.father > 0;
    
    // 5.1 Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡ ÙˆÙ„Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ† Ø¨Ø§Ù„Ø§Ø¨Ù†/Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù†/Ø§Ù„Ø£Ø¨
    if (blockedByDescOrFather) {
      ['full_brother', 'full_sister', 'paternal_brother', 'paternal_sister'].forEach(heir => {
        if (h[heir] > 0) {
          const by = h.father > 0 ? 'father' : (h.son > 0 ? 'son' : 'grandson');
          blocked.push({
            heir,
            by,
            reason: `${ENHANCED_FIQH_DATABASE.heirNames[heir]} Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„ÙˆØ§Ø±Ø« Ø£Ùˆ Ø§Ù„Ø£Ø¨`,
            type: 'absolute'
          });
          h[heir] = 0;
        }
      });
    }
    
    // 5.2 Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© ÙÙŠ Ø§Ù„Ø´Ø§ÙØ¹ÙŠ ÙˆØ§Ù„Ø­Ù†ÙÙŠ
    if (h.grandfather > 0 && rules.grandfatherWithSiblings === 'blocks') {
      ['full_brother', 'full_sister', 'paternal_brother', 'paternal_sister'].forEach(heir => {
        if (h[heir] > 0) {
          blocked.push({
            heir,
            by: 'grandfather',
            reason: `${ENHANCED_FIQH_DATABASE.heirNames[heir]} Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„Ø¬Ø¯ (Ù…Ø°Ù‡Ø¨ ${this.config.name})`,
            type: 'madhhab_specific'
          });
          h[heir] = 0;
        }
      });
      this.state.madhhabNotes.push(`ÙÙŠ Ø§Ù„Ù…Ø°Ù‡Ø¨ ${this.config.name}: Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ù…Ø·Ù„Ù‚Ø§Ù‹`);
    }
    
    // 6. Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù… Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
    const maternalBlockers = rules.maternalSiblingsBlockedBy || ['descendants', 'father', 'grandfather'];
    let shouldBlockMaternal = false;
    
    if (maternalBlockers.includes('descendants') && this.hasDescendants()) {
      shouldBlockMaternal = true;
    }
    if (maternalBlockers.includes('father') && h.father > 0) {
      shouldBlockMaternal = true;
    }
    if (maternalBlockers.includes('grandfather') && h.grandfather > 0) {
      shouldBlockMaternal = true;
    }
    
    if (shouldBlockMaternal) {
      ['maternal_brother', 'maternal_sister'].forEach(heir => {
        if (h[heir] > 0) {
          blocked.push({
            heir,
            by: 'descendant_or_male_ascendant',
            reason: `${ENHANCED_FIQH_DATABASE.heirNames[heir]} Ù…Ø­Ø¬ÙˆØ¨ (${this.config.name})`,
            type: 'madhhab_specific'
          });
          h[heir] = 0;
        }
      });
    }
    
    // 7. Ø§Ù„Ø£Ø® Ù„Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚
    if (h.full_brother > 0 && h.paternal_brother > 0) {
      blocked.push({
        heir: 'paternal_brother',
        by: 'full_brother',
        reason: 'Ø§Ù„Ø£Ø® Ù„Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨ Ø¨Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚',
        type: 'relative'
      });
      h.paternal_brother = 0;
    }
    
    // 8. Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø£Ø®ØªÙŠÙ† Ø´Ù‚ÙŠÙ‚ØªÙŠÙ† (Ø¥Ù„Ø§ Ù…Ø¹ Ø£Ø® Ù„Ø£Ø¨)
    if (h.full_sister >= 2 && h.paternal_sister > 0 && h.paternal_brother === 0) {
      blocked.push({
        heir: 'paternal_sister',
        by: 'full_sister',
        reason: 'Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø£Ø®ØªÙŠÙ† Ø´Ù‚ÙŠÙ‚ØªÙŠÙ† (Ù„Ø§ Ø£Ø® Ù„Ø£Ø¨)',
        type: 'conditional'
      });
      h.paternal_sister = 0;
    }
    
    this.state.blockedHeirs = blocked;
    
    if (blocked.length > 0) {
      this.addStep('Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø¬Ø¨', `ØªÙ… Ø­Ø¬Ø¨ ${blocked.length} ÙˆØ§Ø±Ø«`, {
        blocked: blocked.map(b => ({
          heir: ENHANCED_FIQH_DATABASE.heirNames[b.heir],
          reason: b.reason
        }))
      }, 'success');
    } else {
      this.addStep('Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø¬Ø¨', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ†', null, 'info');
    }
    
    return blocked;
  }
  
  // ========== Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶ Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© ==========
  computeFixedShares() {
    this.addStep('Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶', 'ØªØ­Ø¯ÙŠØ¯ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶...', null, 'calculation');
    const shares = [];
    const h = this.heirs;
    const hasDesc = this.hasDescendants();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© (Ù…ØµØ­Ø­)
    const isUmariyyah = (h.husband > 0 || h.wife > 0) && h.father > 0 && h.mother > 0 && 
                        !hasDesc && this.getSiblingsCount() === 0;
    
    if (isUmariyyah) {
      this.state.specialCases.push({
        type: 'umariyyah',
        name: h.husband > 0 ? 'Ø§Ù„Ø¹ÙÙ…ÙØ±ÙŠÙÙ‘Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„Ø¹ÙÙ…ÙØ±ÙŠÙÙ‘Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
        description: h.husband > 0 ? 
          'Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù… (Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ Ø£Ùˆ Ø¥Ø®ÙˆØ©)' : 
          'Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù… (Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ Ø£Ùˆ Ø¥Ø®ÙˆØ©)'
      });
      
      // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© - Ø³Ù†Ø¹Ø§Ù„Ø¬Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø®Ø§Øµ ÙÙŠ handleUmariyyahSpecialCase
      // Ù†Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© Ù‡Ù†Ø§
      return [];
    }
    
    // Ø§Ù„Ø²ÙˆØ¬
    if (h.husband > 0) {
      const frac = hasDesc ? new EnhancedFraction(1, 4) : new EnhancedFraction(1, 2);
      shares.push({
        key: 'husband',
        name: ENHANCED_FIQH_DATABASE.heirNames.husband,
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: 1,
        perPerson: frac,
        reason: hasDesc ? 'Â¼ Ù…Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„ÙˆØ§Ø±Ø«' : 'Â½ Ø¨Ø¯ÙˆÙ† ÙØ±Ø¹ ÙˆØ§Ø±Ø«',
        priority: 1
      });
    }
    
    // Ø§Ù„Ø²ÙˆØ¬Ø©
    if (h.wife > 0) {
      const frac = hasDesc ? new EnhancedFraction(1, 8) : new EnhancedFraction(1, 4);
      shares.push({
        key: 'wife',
        name: h.wife > 1 ? 'Ø§Ù„Ø²ÙˆØ¬Ø§Øª' : ENHANCED_FIQH_DATABASE.heirNames.wife,
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: h.wife,
        perPerson: new EnhancedFraction(frac.num, frac.den * h.wife),
        reason: hasDesc ? 'â…› ÙŠØ´ØªØ±ÙƒÙ† ÙÙŠÙ‡' : 'Â¼ ÙŠØ´ØªØ±ÙƒÙ† ÙÙŠÙ‡',
        priority: 1
      });
    }
    
    // Ø§Ù„Ø£Ù…
    if (h.mother > 0) {
      let frac, reason;
      
      if (hasDesc || this.getSiblingsCount() >= 2) {
        frac = new EnhancedFraction(1, 6);
        reason = 'â…™ Ù…Ø¹ Ø§Ù„ÙØ±Ø¹ Ø£Ùˆ Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø®ÙˆØ©';
      } else {
        frac = new EnhancedFraction(1, 3);
        reason = 'â…“';
      }
      
      shares.push({
        key: 'mother',
        name: ENHANCED_FIQH_DATABASE.heirNames.mother,
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: 1,
        perPerson: frac,
        reason,
        priority: 2
      });
    }
    
    // Ø§Ù„Ø£Ø¨
    if (h.father > 0) {
      if (hasDesc) {
        shares.push({
          key: 'father',
          name: ENHANCED_FIQH_DATABASE.heirNames.father,
          type: 'ÙØ±Ø¶',
          fraction: new EnhancedFraction(1, 6),
          count: 1,
          perPerson: new EnhancedFraction(1, 6),
          reason: 'â…™ Ù…Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„ÙˆØ§Ø±Ø«',
          alsoAsaba: !this.hasMaleDescendants(),
          priority: 2
        });
      } else {
        // Ø§Ù„Ø£Ø¨ Ø¹ØµØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¹
        shares.push({
          key: 'father',
          name: ENHANCED_FIQH_DATABASE.heirNames.father,
          type: 'Ø¹ØµØ¨Ø©',
          fraction: new EnhancedFraction(1, 1), // Ø³ÙŠØ¹Ø§Ø¯ Ø­Ø³Ø§Ø¨Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
          count: 1,
          perPerson: new EnhancedFraction(1, 1),
          reason: 'Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹ (Ù„Ø§ ÙØ±Ø¹)',
          isAsaba: true,
          priority: 3
        });
      }
    }
    
    // Ø§Ù„Ø¬Ø¯ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø°Ù‡Ø¨)
    if (h.grandfather > 0 && h.father === 0) {
      const siblingsExist = this.getFullAndPaternalSiblingsCount() > 0;
      
      if (hasDesc) {
        shares.push({
          key: 'grandfather',
          name: ENHANCED_FIQH_DATABASE.heirNames.grandfather,
          type: 'ÙØ±Ø¶',
          fraction: new EnhancedFraction(1, 6),
          count: 1,
          perPerson: new EnhancedFraction(1, 6),
          reason: 'â…™ Ù…Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„ÙˆØ§Ø±Ø«',
          alsoAsaba: !this.hasMaleDescendants(),
          priority: 2
        });
      } else if (siblingsExist && this.config.rules.grandfatherWithSiblings === 'shares') {
        this.state.madhhabNotes.push(`ÙÙŠ Ø§Ù„Ù…Ø°Ù‡Ø¨ ${this.config.name}: Ø§Ù„Ø¬Ø¯ ÙŠÙÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©`);
        // Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ù†ØµÙŠØ¨Ù‡ ÙÙŠ Ø§Ù„Ø¹ØµØ¨Ø§Øª
      }
    }
    
    // Ø§Ù„Ø¬Ø¯Ø©
    if (h.grandmother > 0) {
      shares.push({
        key: 'grandmother',
        name: ENHANCED_FIQH_DATABASE.heirNames.grandmother,
        type: 'ÙØ±Ø¶',
        fraction: new EnhancedFraction(1, 6),
        count: 1,
        perPerson: new EnhancedFraction(1, 6),
        reason: 'â…™',
        priority: 2
      });
    }
    
    // Ø§Ù„Ø¨Ù†Ø§Øª
    if (h.daughter > 0 && h.son === 0) {
      const frac = h.daughter === 1 ? 
        new EnhancedFraction(1, 2) : new EnhancedFraction(2, 3);
      shares.push({
        key: 'daughter',
        name: h.daughter > 1 ? 'Ø§Ù„Ø¨Ù†Ø§Øª' : ENHANCED_FIQH_DATABASE.heirNames.daughter,
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: h.daughter,
        perPerson: new EnhancedFraction(frac.num, frac.den * h.daughter),
        reason: h.daughter === 1 ? 'Â½ Ù„Ù„ÙˆØ§Ø­Ø¯Ø©' : 'â…” Ù„Ù„Ø§Ø«Ù†ØªÙŠÙ† ÙØ£ÙƒØ«Ø±',
        priority: 2
      });
    }
    
    // Ø¨Ù†Ø§Øª Ø§Ù„Ø§Ø¨Ù†
    if (h.granddaughter > 0 && h.grandson === 0 && h.son === 0) {
      if (h.daughter === 0) {
        const frac = h.granddaughter === 1 ? 
          new EnhancedFraction(1, 2) : new EnhancedFraction(2, 3);
        shares.push({
          key: 'granddaughter',
          name: h.granddaughter > 1 ? 'Ø¨Ù†Ø§Øª Ø§Ù„Ø§Ø¨Ù†' : ENHANCED_FIQH_DATABASE.heirNames.granddaughter,
          type: 'ÙØ±Ø¶',
          fraction: frac,
          count: h.granddaughter,
          perPerson: new EnhancedFraction(frac.num, frac.den * h.granddaughter),
          reason: h.granddaughter === 1 ? 'Â½' : 'â…”',
          priority: 3
        });
      } else if (h.daughter === 1) {
        shares.push({
          key: 'granddaughter',
          name: h.granddaughter > 1 ? 'Ø¨Ù†Ø§Øª Ø§Ù„Ø§Ø¨Ù†' : ENHANCED_FIQH_DATABASE.heirNames.granddaughter,
          type: 'ÙØ±Ø¶',
          fraction: new EnhancedFraction(1, 6),
          count: h.granddaughter,
          perPerson: new EnhancedFraction(1, 6 * h.granddaughter),
          reason: 'â…™ ØªÙƒÙ…Ù„Ø© Ù„Ù„Ø«Ù„Ø«ÙŠÙ†',
          priority: 3
        });
      }
    }
    
    // Ø§Ù„Ø£Ø®ÙˆØ§Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø§Øª
    if (h.full_sister > 0 && h.full_brother === 0 && !hasDesc && !this.hasMaleAscendant()) {
      const frac = h.full_sister === 1 ? 
        new EnhancedFraction(1, 2) : new EnhancedFraction(2, 3);
      shares.push({
        key: 'full_sister',
        name: h.full_sister > 1 ? 'Ø§Ù„Ø£Ø®ÙˆØ§Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø§Øª' : ENHANCED_FIQH_DATABASE.heirNames.full_sister,
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: h.full_sister,
        perPerson: new EnhancedFraction(frac.num, frac.den * h.full_sister),
        reason: h.full_sister === 1 ? 'Â½' : 'â…”',
        priority: 3
      });
    }
    
    // Ø§Ù„Ø£Ø®ÙˆØ§Øª Ù„Ø£Ø¨
    if (h.paternal_sister > 0 && h.paternal_brother === 0 && h.full_brother === 0 && 
        !hasDesc && !this.hasMaleAscendant()) {
      if (h.full_sister === 0) {
        const frac = h.paternal_sister === 1 ? 
          new EnhancedFraction(1, 2) : new EnhancedFraction(2, 3);
        shares.push({
          key: 'paternal_sister',
          name: h.paternal_sister > 1 ? 'Ø§Ù„Ø£Ø®ÙˆØ§Øª Ù„Ø£Ø¨' : ENHANCED_FIQH_DATABASE.heirNames.paternal_sister,
          type: 'ÙØ±Ø¶',
          fraction: frac,
          count: h.paternal_sister,
          perPerson: new EnhancedFraction(frac.num, frac.den * h.paternal_sister),
          reason: h.paternal_sister === 1 ? 'Â½' : 'â…”',
          priority: 3
        });
      } else if (h.full_sister === 1) {
        shares.push({
          key: 'paternal_sister',
          name: h.paternal_sister > 1 ? 'Ø§Ù„Ø£Ø®ÙˆØ§Øª Ù„Ø£Ø¨' : ENHANCED_FIQH_DATABASE.heirNames.paternal_sister,
          type: 'ÙØ±Ø¶',
          fraction: new EnhancedFraction(1, 6),
          count: h.paternal_sister,
          perPerson: new EnhancedFraction(1, 6 * h.paternal_sister),
          reason: 'â…™ ØªÙƒÙ…Ù„Ø©',
          priority: 3
        });
      }
    }
    
    // Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù…
    const maternalCount = this.getMaternalSiblingsCount();
    if (maternalCount > 0 && !hasDesc && !this.hasFatherOrGrandfather()) {
      const frac = maternalCount === 1 ? 
        new EnhancedFraction(1, 6) : new EnhancedFraction(1, 3);
      shares.push({
        key: 'maternal_siblings',
        name: 'Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ù…',
        type: 'ÙØ±Ø¶',
        fraction: frac,
        count: maternalCount,
        perPerson: new EnhancedFraction(frac.num, frac.den * maternalCount),
        reason: maternalCount === 1 ? 'â…™' : 'â…“ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ',
        priority: 3
      });
    }
    
    // ÙØ±Ø² Ø§Ù„Ø­ØµØµ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    shares.sort((a, b) => a.priority - b.priority);
    
    return shares;
  }
  
  // ========== Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© ==========
  handleUmariyyahSpecialCase() {
    const h = this.heirs;
    const shares = [];
    
    if (h.husband > 0) {
      // Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù…
      this.addStep('Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©', 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù…', null, 'calculation');
      
      // Ø§Ù„Ø²ÙˆØ¬: 1/2 = 3/6
      shares.push({
        key: 'husband',
        name: ENHANCED_FIQH_DATABASE.heirNames.husband,
        type: 'ÙØ±Ø¶',
        fraction: new EnhancedFraction(3, 6),
        count: 1,
        perPerson: new EnhancedFraction(3, 6),
        reason: 'Â½ ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰',
        priority: 1
      });
      
      // Ø§Ù„Ø£Ù…: 1/6 = 1/6
      shares.push({
        key: 'mother',
        name: ENHANCED_FIQH_DATABASE.heirNames.mother,
        type: 'ÙØ±Ø¶',
        fraction: new EnhancedFraction(1, 6),
        count: 1,
        perPerson: new EnhancedFraction(1, 6),
        reason: 'â…™ (Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬)',
        priority: 2
      });
      
      // Ø§Ù„Ø£Ø¨: 2/6 = 1/3 (Ø¹ØµØ¨Ø©)
      shares.push({
        key: 'father',
        name: ENHANCED_FIQH_DATABASE.heirNames.father,
        type: 'Ø¹ØµØ¨Ø©',
        fraction: new EnhancedFraction(2, 6),
        count: 1,
        perPerson: new EnhancedFraction(2, 6),
        reason: 'â…“ (Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰)',
        priority: 3
      });
      
      this.results.asl = 6;
      this.results.finalBase = 6;
      
    } else if (h.wife > 0) {
      // Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù…
      this.addStep('Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©', 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù…', null, 'calculation');
      
      // Ø§Ù„Ø²ÙˆØ¬Ø©: 1/4 = 1/4
      const wifeFraction = new EnhancedFraction(1, 4);
      shares.push({
        key: 'wife',
        name: h.wife > 1 ? 'Ø§Ù„Ø²ÙˆØ¬Ø§Øª' : ENHANCED_FIQH_DATABASE.heirNames.wife,
        type: 'ÙØ±Ø¶',
        fraction: wifeFraction,
        count: h.wife,
        perPerson: new EnhancedFraction(wifeFraction.num, wifeFraction.den * h.wife),
        reason: 'Â¼ ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
        priority: 1
      });
      
      // Ø§Ù„Ø£Ù…: 1/4 = 1/4
      shares.push({
        key: 'mother',
        name: ENHANCED_FIQH_DATABASE.heirNames.mother,
        type: 'ÙØ±Ø¶',
        fraction: new EnhancedFraction(1, 4),
        count: 1,
        perPerson: new EnhancedFraction(1, 4),
        reason: 'Â¼ (Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬Ø©)',
        priority: 2
      });
      
      // Ø§Ù„Ø£Ø¨: 2/4 = 1/2 (Ø¹ØµØ¨Ø©)
      shares.push({
        key: 'father',
        name: ENHANCED_FIQH_DATABASE.heirNames.father,
        type: 'Ø¹ØµØ¨Ø©',
        fraction: new EnhancedFraction(2, 4),
        count: 1,
        perPerson: new EnhancedFraction(2, 4),
        reason: 'Â½ (Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)',
        priority: 3
      });
      
      this.results.asl = 4;
      this.results.finalBase = 4;
    }
    
    this.results.awlApplied = false;
    return shares;
  }
  
  // ========== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹ØµØ¨Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù† ==========
  computeAsaba(fixedShares, remainder) {
    this.addStep('Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹ØµØ¨Ø§Øª', 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹ØµØ¨Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ...', null, 'calculation');
    const asabaShares = [];
    const h = this.heirs;
    
    if (remainder.num <= 0 || remainder.isZero()) {
      this.addStep('Ø§Ù„Ø¹ØµØ¨Ø§Øª', 'Ù„Ø§ Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø¹ØµØ¨Ø§Øª', null, 'info');
      return asabaShares;
    }
    
    const asabaOrder = [];
    let totalWeight = 0;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹ØµØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    // 1. Ø§Ù„Ø§Ø¨Ù† ÙˆØ¨Ù†Ø§ØªÙ‡ (Ø¹ØµØ¨Ø© Ø¨Ø§Ù„Ù†ÙØ³ ÙˆØ§Ù„ØºÙŠØ±)
    if (h.son > 0) {
      // Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø¹ØµØ¨Ø© Ø¨Ø§Ù„Ù†ÙØ³
      for (let i = 0; i < h.son; i++) {
        asabaOrder.push({ key: 'son', weight: 2, type: 'self' });
        totalWeight += 2;
      }
      // Ø§Ù„Ø¨Ù†Ø§Øª Ø¹ØµØ¨Ø© Ø¨Ø§Ù„ØºÙŠØ± Ù…Ø¹ Ø£Ø®ÙŠÙ‡Ù†
      for (let i = 0; i < (h.daughter || 0); i++) {
        asabaOrder.push({ key: 'daughter', weight: 1, type: 'with_other' });
        totalWeight += 1;
      }
    }
    // 2. Ø§Ø¨Ù† Ø§Ù„Ø§Ø¨Ù† ÙˆØ¨Ù†Ø§ØªÙ‡
    else if (h.grandson > 0) {
      for (let i = 0; i < h.grandson; i++) {
        asabaOrder.push({ key: 'grandson', weight: 2, type: 'self' });
        totalWeight += 2;
      }
      for (let i = 0; i < (h.granddaughter || 0); i++) {
        asabaOrder.push({ key: 'granddaughter', weight: 1, type: 'with_other' });
        totalWeight += 1;
      }
    }
    // 3. Ø§Ù„Ø£Ø¨ (Ø¹ØµØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¹ Ø°ÙƒØ±)
    else if (h.father > 0 && !this.hasMaleDescendants()) {
      const alreadyHasFixedShare = fixedShares.some(s => s.key === 'father' && s.type === 'ÙØ±Ø¶');
      
      if (!alreadyHasFixedShare) {
        asabaOrder.push({ key: 'father', weight: 1, type: 'self' });
        totalWeight += 1;
      } else {
        // Ø§Ù„Ø£Ø¨ ÙŠØ£Ø®Ø° Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ÙØ±Ø¶Ù‡
        asabaOrder.push({ key: 'father', weight: 1, type: 'additional', isAdditional: true });
        totalWeight += 1;
      }
    }
    // 4. Ø§Ù„Ø¬Ø¯ Ù…Ø¹ Ø§Ù„Ø¥Ø®ÙˆØ© (Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨)
    else if (h.grandfather > 0 && !this.hasMaleDescendants() && h.father === 0) {
      const siblingsExist = this.getFullAndPaternalSiblingsCount() > 0;
      
      if (this.config.rules.grandfatherWithSiblings === 'blocks' || !siblingsExist) {
        // Ø§Ù„Ø¬Ø¯ ÙŠØ£Ø®Ø° Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹
        const alreadyHasFixedShare = fixedShares.some(s => s.key === 'grandfather' && s.type === 'ÙØ±Ø¶');
        
        if (!alreadyHasFixedShare) {
          asabaOrder.push({ key: 'grandfather', weight: 1, type: 'self' });
          totalWeight += 1;
        } else {
          asabaOrder.push({ key: 'grandfather', weight: 1, type: 'additional', isAdditional: true });
          totalWeight += 1;
        }
      } else if (this.config.rules.grandfatherWithSiblings === 'shares') {
        // Ø§Ù„Ù…Ù‚Ø§Ø³Ù…Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø®ÙˆØ©
        asabaOrder.push({ key: 'grandfather', weight: 2, type: 'shares_with_siblings' });
        totalWeight += 2;
        
        // Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡
        for (let i = 0; i < (h.full_brother || 0); i++) {
          asabaOrder.push({ key: 'full_brother', weight: 2, type: 'shares_with_grandfather' });
          totalWeight += 2;
        }
        for (let i = 0; i < (h.full_sister || 0); i++) {
          asabaOrder.push({ key: 'full_sister', weight: 1, type: 'shares_with_grandfather' });
          totalWeight += 1;
        }
        
        // Ø§Ù„Ø¥Ø®ÙˆØ© Ù„Ø£Ø¨
        for (let i = 0; i < (h.paternal_brother || 0); i++) {
          asabaOrder.push({ key: 'paternal_brother', weight: 2, type: 'shares_with_grandfather' });
          totalWeight += 2;
        }
        for (let i = 0; i < (h.paternal_sister || 0); i++) {
          asabaOrder.push({ key: 'paternal_sister', weight: 1, type: 'shares_with_grandfather' });
          totalWeight += 1;
        }
      }
    }
    // 5. Ø§Ù„Ø£Ø® Ø§Ù„Ø´Ù‚ÙŠÙ‚
    else if (h.full_brother > 0) {
      for (let i = 0; i < h.full_brother; i++) {
        asabaOrder.push({ key: 'full_brother', weight: 2, type: 'self' });
        totalWeight += 2;
      }
      for (let i = 0; i < (h.full_sister || 0); i++) {
        asabaOrder.push({ key: 'full_sister', weight: 1, type: 'with_other' });
        totalWeight += 1;
      }
    }
    // 6. Ø§Ù„Ø£Ø®Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø¨Ù†Øª (Ø¹ØµØ¨Ø© Ø¨Ø§Ù„ØºÙŠØ±)
    else if (h.full_sister > 0 && (h.daughter > 0 || h.granddaughter > 0)) {
      this.state.specialCases.push({
        type: 'sister_with_daughter',
        name: 'Ø¹ØµØ¨Ø© Ù…Ø¹ Ø§Ù„ØºÙŠØ±',
        description: 'Ø§Ù„Ø£Ø®Øª Ø§Ù„Ø´Ù‚ÙŠÙ‚Ø© Ø¹ØµØ¨Ø© Ù…Ø¹ Ø§Ù„Ø¨Ù†Øª'
      });
      for (let i = 0; i < h.full_sister; i++) {
        asabaOrder.push({ key: 'full_sister', weight: 1, type: 'with_female_descendant' });
        totalWeight += 1;
      }
    }
    // 7. Ø§Ù„Ø£Ø® Ù„Ø£Ø¨
    else if (h.paternal_brother > 0) {
      for (let i = 0; i < h.paternal_brother; i++) {
        asabaOrder.push({ key: 'paternal_brother', weight: 2, type: 'self' });
        totalWeight += 2;
      }
      for (let i = 0; i < (h.paternal_sister || 0); i++) {
        asabaOrder.push({ key: 'paternal_sister', weight: 1, type: 'with_other' });
        totalWeight += 1;
      }
    }
    // 8. Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ù†Øª (Ø¹ØµØ¨Ø© Ø¨Ø§Ù„ØºÙŠØ±)
    else if (h.paternal_sister > 0 && (h.daughter > 0 || h.granddaughter > 0) && h.full_sister === 0) {
      this.state.specialCases.push({
        type: 'paternal_sister_with_daughter',
        name: 'Ø¹ØµØ¨Ø© Ù…Ø¹ Ø§Ù„ØºÙŠØ±',
        description: 'Ø§Ù„Ø£Ø®Øª Ù„Ø£Ø¨ Ø¹ØµØ¨Ø© Ù…Ø¹ Ø§Ù„Ø¨Ù†Øª'
      });
      for (let i = 0; i < h.paternal_sister; i++) {
        asabaOrder.push({ key: 'paternal_sister', weight: 1, type: 'with_female_descendant' });
        totalWeight += 1;
      }
    }
    // 9. Ø§Ù„Ø¹ØµØ¨Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©
    else {
      const distantAsaba = [
        { key: 'full_nephew', condition: h.full_nephew > 0, weight: 1 },
        { key: 'paternal_nephew', condition: h.paternal_nephew > 0, weight: 1 },
        { key: 'full_uncle', condition: h.full_uncle > 0, weight: 1 },
        { key: 'paternal_uncle', condition: h.paternal_uncle > 0, weight: 1 },
        { key: 'full_cousin', condition: h.full_cousin > 0, weight: 1 },
        { key: 'paternal_cousin', condition: h.paternal_cousin > 0, weight: 1 }
      ];
      
      for (const asaba of distantAsaba) {
        if (asaba.condition) {
          const count = h[asaba.key] || 0;
          for (let i = 0; i < count; i++) {
            asabaOrder.push({ key: asaba.key, weight: asaba.weight, type: 'distant' });
            totalWeight += asaba.weight;
          }
          break; // Ø£ÙˆÙ„ Ø¹Ø§ØµØ¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙ‚Ø·
        }
      }
    }
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ØµØ¨Ø§Øª
    if (asabaOrder.length > 0 && totalWeight > 0) {
      const grouped = {};
      
      asabaOrder.forEach(a => {
        if (!grouped[a.key]) {
          grouped[a.key] = {
            weight: 0,
            count: 0,
            type: a.type,
            isAdditional: a.isAdditional
          };
        }
        grouped[a.key].weight += a.weight;
        grouped[a.key].count++;
      });
      
      for (const [key, data] of Object.entries(grouped)) {
        const shareFrac = remainder.multiply(new EnhancedFraction(data.weight, totalWeight));
        
        if (shareFrac.greaterThan(new EnhancedFraction(0))) {
          asabaShares.push({
            key,
            name: ENHANCED_FIQH_DATABASE.heirNames[key] || key,
            type: 'Ø¹ØµØ¨Ø©',
            fraction: shareFrac,
            count: data.count,
            perPerson: new EnhancedFraction(shareFrac.num, shareFrac.den * data.count),
            reason: `Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹ (${data.weight}/${totalWeight})`,
            isAdditional: data.isAdditional,
            asabaType: data.type
          });
        }
      }
      
      this.addStep('ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹ØµØ¨Ø§Øª', `ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¹Ù„Ù‰ ${asabaShares.length} Ø¹Ø§ØµØ¨`, {
        totalWeight,
        remainder: remainder.toString(),
        asabaCount: asabaShares.length
      }, 'success');
    } else {
      this.addStep('Ø§Ù„Ø¹ØµØ¨Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹ØµØ¨Ø§Øª Ù…Ø¤Ù‡Ù„Ø©', null, 'info');
    }
    
    return asabaShares;
  }
  
  // ========== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„ Ø§Ù„Ù…Ø­Ø³Ù† ==========
  applyEnhancedAwl(shares) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©
    const isUmariyyahCase = this.state.specialCases.some(sc => sc.type === 'umariyyah');
    if (isUmariyyahCase) {
      this.results.awlApplied = false;
      return shares; // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ù„Ø§ ØªØ·Ø¨Ù‚ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¹ÙˆÙ„
    }
    
    if (shares.length === 0) {
      this.results.asl = 1;
      this.results.finalBase = 1;
      return shares;
    }
    
    // Ø¬Ù…Ø¹ Ù…Ù‚Ø§Ù…Ø§Øª Ø§Ù„ÙƒØ³ÙˆØ±
    const denominators = shares
      .filter(s => s.fraction && s.fraction.den > 0)
      .map(s => s.fraction.den);
    
    if (denominators.length === 0) {
      this.results.asl = 1;
      this.results.finalBase = 1;
      return shares;
    }
    
    // Ø­Ø³Ø§Ø¨ Ø£ØµÙ„ Ø§Ù„Ù…Ø³Ø£Ù„Ø© (Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ±)
    const asl = EnhancedFraction.lcmArray(denominators);
    this.results.asl = asl;
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù‡Ø§Ù… Ù„ÙƒÙ„ ÙˆØ§Ø±Ø«
    let totalShares = 0;
    const shareDetails = shares.map(share => {
      if (!share.fraction || share.fraction.isZero()) {
        return { ...share, rawShares: 0, sharesPerPerson: 0 };
      }
      
      const shareCount = (share.fraction.num * (asl / share.fraction.den));
      const sharesPerPerson = shareCount / share.count;
      
      totalShares += shareCount;
      
      return {
        ...share,
        rawShares: shareCount,
        sharesPerPerson: sharesPerPerson
      };
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹ÙˆÙ„
    if (totalShares > asl) {
      this.results.awlApplied = true;
      this.results.finalBase = totalShares;
      
      const awlIncrease = ((totalShares - asl) / asl * 100).toFixed(1);
      
      this.state.specialCases.push({
        type: 'awl',
        name: 'Ø§Ù„Ø¹ÙÙˆÙ’Ù„',
        description: `Ø¹Ø§Ù„Øª Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ù…Ù† ${asl} Ø¥Ù„Ù‰ ${totalShares} (Ø²ÙŠØ§Ø¯Ø© ${awlIncrease}%)`
      });
      
      this.addStep('Ø§Ù„Ø¹ÙÙˆÙ’Ù„', 
        `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ù‡Ø§Ù… (${totalShares}) > Ø£ØµÙ„ Ø§Ù„Ù…Ø³Ø£Ù„Ø© (${asl})`,
        {
          originalBase: asl,
          newBase: totalShares,
          increase: awlIncrease + '%',
          shares: shareDetails.map(s => ({
            heir: s.name,
            shares: s.rawShares,
            perPerson: s.sharesPerPerson
          }))
        },
        'warning'
      );
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­ØµØµ Ù…Ø¹ Ø§Ù„Ø¹ÙˆÙ„
      return shareDetails.map(share => ({
        ...share,
        fraction: new EnhancedFraction(share.rawShares, totalShares),
        perPerson: new EnhancedFraction(share.rawShares, totalShares * share.count),
        shares: share.rawShares,
        sharesPerPerson: share.sharesPerPerson
      }));
    } else {
      this.results.finalBase = asl;
      return shareDetails.map(share => ({
        ...share,
        shares: share.rawShares,
        sharesPerPerson: share.sharesPerPerson
      }));
    }
  }
  
  // ========== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø­Ø³Ù† ==========
  applyEnhancedRadd(shares, remainder) {
    if (remainder.num <= 0 || remainder.isZero()) {
      return shares;
    }
    
    const rules = this.config.rules;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ† Ù„Ù„Ø±Ø¯
    let eligible = shares.filter(s => {
      if (s.type !== 'ÙØ±Ø¶') return false;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨
      if (!rules.raddToSpouse && (s.key === 'husband' || s.key === 'wife')) {
        return false;
      }
      
      return true;
    });
    
    // ÙÙŠ Ø§Ù„Ø­Ù†ÙÙŠ ÙˆØ§Ù„Ø­Ù†Ø¨Ù„ÙŠ: ÙŠÙØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØºÙŠØ±Ù‡Ù…
    if (eligible.length === 0 && rules.raddToSpouse) {
      eligible = shares.filter(s => s.type === 'ÙØ±Ø¶');
      if (eligible.length > 0) {
        this.state.madhhabNotes.push(`ÙÙŠ Ø§Ù„Ù…Ø°Ù‡Ø¨ ${this.config.name}: ÙŠÙØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØºÙŠØ±Ù‡Ù…`);
      }
    }
    
    if (eligible.length === 0) {
      return shares;
    }
    
    this.results.raddApplied = true;
    
    // Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ ÙØ±ÙˆØ¶ Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ†
    let totalFrac = new EnhancedFraction(0);
    eligible.forEach(s => {
      totalFrac = totalFrac.add(s.fraction);
    });
    
    if (totalFrac.isZero()) {
      return shares;
    }
    
    this.state.specialCases.push({
      type: 'radd',
      name: 'Ø§Ù„Ø±ÙÙ‘Ø¯',
      description: `ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ§Ø¦Ø¶ (${remainder.toArabic()}) Ø¹Ù„Ù‰ ${eligible.length} Ù…Ù† Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶`
    });
    
    this.addStep('Ø§Ù„Ø±ÙÙ‘Ø¯',
      `ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${remainder.toArabic()}) Ø¨Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±ÙˆØ¶`,
      {
        remainder: remainder.toString(),
        eligibleCount: eligible.length,
        totalFixed: totalFrac.toString()
      },
      'calculation'
    );
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø¯
    return shares.map(share => {
      if (eligible.includes(share)) {
        const raddShare = remainder.multiply(share.fraction).divide(totalFrac);
        const newFraction = share.fraction.add(raddShare);
        
        return {
          ...share,
          fraction: newFraction,
          perPerson: newFraction.divide(new EnhancedFraction(share.count)),
          type: 'ÙØ±Ø¶ + Ø±Ø¯',
          raddAmount: raddShare
        };
      }
      return share;
    });
  }
  
  // ========== ØªÙˆØ²ÙŠØ¹ Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† ==========
  distributeEnhancedBloodRelatives(shares, remainder) {
    if (!this.config.rules.bloodRelativesEnabled || remainder.num <= 0 || remainder.isZero()) {
      return { shares, bloodRelatives: [] };
    }
    
    const h = this.heirs;
    
    // Ø¬Ù…Ø¹ Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù… Ù…Ø¹ Ø£ÙˆÙ„ÙˆÙŠØ§ØªÙ‡Ù…
    const bloodRelatives = [
      { key: 'maternal_uncle', priority: 1, name: 'Ø§Ù„Ø®Ø§Ù„', desc: 'Ø£Ù… Ø§Ù„Ø£Ù… Ø£Ùˆ Ø£Ù… Ø§Ù„Ø£Ø¨' },
      { key: 'maternal_aunt', priority: 2, name: 'Ø§Ù„Ø®Ø§Ù„Ø©', desc: 'Ø£Ù… Ø§Ù„Ø£Ù… Ø£Ùˆ Ø£Ù… Ø§Ù„Ø£Ø¨' },
      { key: 'paternal_aunt', priority: 3, name: 'Ø§Ù„Ø¹Ù…Ø©', desc: 'Ø£Ø¨ Ø§Ù„Ø£Ø¨' },
      { key: 'daughter_son', priority: 4, name: 'Ø§Ø¨Ù† Ø§Ù„Ø¨Ù†Øª', desc: 'ÙØ±Ø¹ Ø£Ù†Ø«Ù‰' },
      { key: 'daughter_daughter', priority: 5, name: 'Ø¨Ù†Øª Ø§Ù„Ø¨Ù†Øª', desc: 'ÙØ±Ø¹ Ø£Ù†Ø«Ù‰' }
    ].filter(rel => h[rel.key] > 0);
    
    if (bloodRelatives.length === 0) {
      return { shares, bloodRelatives: [] };
    }
    
    this.results.bloodRelativesApplied = true;
    
    this.state.specialCases.push({
      type: 'blood_relatives',
      name: 'Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù…',
      description: `ØªÙˆØ±ÙŠØ« ${bloodRelatives.length} Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù…`
    });
    
    this.addStep('Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù…',
      `ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¹Ù„Ù‰ ${bloodRelatives.length} Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù…`,
      {
        remainder: remainder.toString(),
        relatives: bloodRelatives.map(r => ({
          name: r.name,
          count: h[r.key],
          priority: r.priority
        }))
      },
      'calculation'
    );
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø£Ø¹Ù„Ù‰ = ÙˆØ²Ù† Ø£Ø¹Ù„Ù‰)
    const totalPriority = bloodRelatives.reduce((sum, rel) => sum + (1 / rel.priority), 0);
    
    const bloodRelativeShares = bloodRelatives.map(rel => {
      const weight = 1 / rel.priority;
      const proportion = weight / totalPriority;
      const shareFrac = remainder.multiply(new EnhancedFraction(
        Math.round(proportion * 1000000),
        1000000
      ));
      
      return {
        key: rel.key,
        name: rel.name,
        type: 'Ø°Ùˆ Ø±Ø­Ù…',
        fraction: shareFrac,
        count: h[rel.key],
        perPerson: new EnhancedFraction(shareFrac.num, shareFrac.den * h[rel.key]),
        reason: `Ø°Ùˆ Ø±Ø­Ù… - Ø£ÙˆÙ„ÙˆÙŠØ© ${rel.priority}`,
        priority: rel.priority,
        weight: proportion.toFixed(4)
      };
    });
    
    return { shares, bloodRelatives: bloodRelativeShares };
  }
  
  // ========== Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯Ù„ Ø§Ù„Ù…Ø­Ø³Ù† ==========
  applyEnhancedRounding(shares, netEstate) {
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    let total = 0;
    shares.forEach(s => {
      s.amount = Math.round(s.amount * 100) / 100;
      s.amountPerPerson = Math.round(s.amountPerPerson * 100) / 100;
      total += s.amount;
    });
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø¯Ù‚Ø©
    const diff = Math.round((netEstate - total) * 100) / 100;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ù†Ø³Ø¨ÙŠØ§Ù‹ (> 0.01 Ù„ÙƒÙ„ ÙˆØ§Ø±Ø«)
    if (Math.abs(diff) > 0.01) {
      const absDiff = Math.abs(diff);
      const sign = diff > 0 ? 1 : -1;
      
      // Ø·Ø±ÙŠÙ‚Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„ØªÙˆØ²ÙŠØ¹: ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£ÙƒØ¨Ø± Ø£ÙˆÙ„Ø§Ù‹
      const sortedShares = [...shares]
        .sort((a, b) => b.amount - a.amount)
        .filter(s => s.amount > 0);
      
      if (sortedShares.length > 0) {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙƒÙ„ Ø­ØµØ©
        const adjustmentPerShare = sign * (absDiff / sortedShares.length);
        const centsToAdjust = Math.round(absDiff * 100);
        
        // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ù†ØªØ§Øª Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†
        for (let i = 0; i < centsToAdjust; i++) {
          const shareIndex = i % sortedShares.length;
          sortedShares[shareIndex].amount += sign * 0.01;
          sortedShares[shareIndex].amount = Math.round(sortedShares[shareIndex].amount * 100) / 100;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ù„ÙƒÙ„ ÙØ±Ø¯
          if (sortedShares[shareIndex].count > 1) {
            sortedShares[shareIndex].amountPerPerson = 
              Math.round((sortedShares[shareIndex].amount / sortedShares[shareIndex].count) * 100) / 100;
          }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
        total = sortedShares.reduce((sum, s) => sum + s.amount, 0);
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const finalDiff = Math.round((netEstate - total) * 100) / 100;
    
    if (Math.abs(finalDiff) > 0.001) {
      this.state.warnings.push({
        type: 'rounding_adjustment',
        message: `ÙØ±Ù‚ ØªÙ‚Ø±ÙŠØ¨ ØµØºÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹: ${finalDiff.toFixed(3)}`,
        diff: finalDiff
      });
    }
    
    return shares;
  }
  
  // ========== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù† ==========
  calculateEnhancedConfidence(shares, calculationTime) {
    let confidence = 1.0;
    const factors = [];
    
    // Ø¹Ø§Ù…Ù„ Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø£ÙƒØ«Ø± Ø«Ù‚Ø©)
    if (calculationTime < 100) {
      confidence *= 1.0;
      factors.push({ factor: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', impact: '+0%' });
    } else if (calculationTime < 500) {
      confidence *= 0.99;
      factors.push({ factor: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', impact: '-1%' });
    } else {
      confidence *= 0.97;
      factors.push({ factor: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', impact: '-3%' });
    }
    
    // Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¹ÙˆÙ„
    if (this.results.awlApplied) {
      confidence *= 0.98;
      factors.push({ factor: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„', impact: '-2%' });
    }
    
    // Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¯
    if (this.results.raddApplied) {
      confidence *= 0.98;
      factors.push({ factor: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¯', impact: '-2%' });
    }
    
    // Ø¹Ø§Ù…Ù„ Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù…
    if (this.results.bloodRelativesApplied) {
      confidence *= 0.96;
      factors.push({ factor: 'ØªÙˆØ²ÙŠØ¹ Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù…', impact: '-4%' });
    }
    
    // Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
    if (this.state.specialCases.length > 0) {
      confidence *= Math.max(0.95, 1.0 - (this.state.specialCases.length * 0.01));
      factors.push({ 
        factor: `Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ© (${this.state.specialCases.length})`, 
        impact: `-${this.state.specialCases.length}%` 
      });
    }
    
    // Ø¹Ø§Ù…Ù„ Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const totalAmount = shares.reduce((sum, s) => sum + (s.amount || 0), 0);
    const diff = Math.abs(this.results.netEstate - totalAmount);
    const diffPercentage = (diff / this.results.netEstate) * 100;
    
    if (diffPercentage > 0.1) {
      confidence *= 0.95;
      factors.push({ factor: 'ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', impact: '-5%' });
    } else if (diffPercentage > 0.01) {
      confidence *= 0.98;
      factors.push({ factor: 'ÙØ±Ù‚ Ø·ÙÙŠÙ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', impact: '-2%' });
    }
    
    // Ø¹Ø§Ù…Ù„ ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´
    const cacheStats = this.cache.getStats();
    if (cacheStats.hitRate > '80%') {
      confidence *= 1.01;
      factors.push({ factor: 'ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´', impact: '+1%' });
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©
    confidence = Math.min(1, Math.max(0.85, confidence));
    
    let confidenceLevel;
    if (confidence >= 0.98) {
      confidenceLevel = 'Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹';
    } else if (confidence >= 0.95) {
      confidenceLevel = 'Ø¹Ø§Ù„ÙŠ';
    } else if (confidence >= 0.90) {
      confidenceLevel = 'Ø¬ÙŠØ¯';
    } else if (confidence >= 0.85) {
      confidenceLevel = 'Ù…ØªÙˆØ³Ø·';
    } else {
      confidenceLevel = 'Ù…Ù†Ø®ÙØ¶';
    }
    
    this.results.confidence = confidence;
    this.results.confidenceLevel = confidenceLevel;
    this.results.confidenceFactors = factors;
    
    return confidence;
  }
  
  // ========== Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ø±ÙŠØ© ==========
  calculate() {
    const startTime = performance.now();
    
    try {
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      if (this.state.validationErrors.length > 0) {
        throw new Error(`Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:\n${this.state.validationErrors.join('\n')}`);
      }
      
      // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ÙƒØ© Ø§Ù„ØµØ§ÙÙŠØ©
      const { total, funeral, debts, will } = this.estate;
      const netEstate = total - funeral - debts - will;
      this.results.netEstate = netEstate;
      
      if (netEstate <= 0) {
        throw new Error('Ø§Ù„ØªØ±ÙƒØ© Ø§Ù„ØµØ§ÙÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
      }
      
      this.addStep('Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ÙƒØ© Ø§Ù„ØµØ§ÙÙŠØ©',
        `${total.toLocaleString()} - ${funeral.toLocaleString()} - ${debts.toLocaleString()} - ${will.toLocaleString()}`,
        {
          total: total.toLocaleString(),
          funeral: funeral.toLocaleString(),
          debts: debts.toLocaleString(),
          will: will.toLocaleString(),
          net: netEstate.toLocaleString()
        },
        'estate'
      );
      
      // 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¬Ø¨
      this.applyEnhancedHijab();
      
      // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±ÙˆØ¶
      let fixedShares = this.computeFixedShares();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©
      const isUmariyyahCase = this.state.specialCases.some(sc => sc.type === 'umariyyah');
      
      if (isUmariyyahCase) {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø§Øµ
        fixedShares = this.handleUmariyyahSpecialCase();
        // ØªØ®Ø·ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„ ÙˆØ§Ù„Ø±Ø¯ ÙˆØ§Ù„Ø¹ØµØ¨Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©
        let allShares = fixedShares;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
        allShares.forEach(s => {
          s.amount = netEstate * s.fraction.toDecimal();
          s.amountPerPerson = s.amount / s.count;
        });
        
        // Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯Ù„
        allShares = this.applyEnhancedRounding(allShares, netEstate);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø© ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡
        const endTime = performance.now();
        const calculationTime = endTime - startTime;
        
        this.calculateEnhancedConfidence(allShares, calculationTime);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        this.results.shares = allShares;
        this.results.calculationTime = calculationTime;
        
        // Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        this.addStep('Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨',
          `ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ${calculationTime.toFixed(2)} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©)`,
          {
            totalShares: allShares.length,
            netEstate: netEstate.toLocaleString(),
            confidence: `${(this.results.confidence * 100).toFixed(1)}%`,
            calculationTime: `${calculationTime.toFixed(2)}ms`
          },
          'success'
        );
        
        return {
          success: true,
          madhab: this.madhab,
          madhhabName: this.config.name,
          estate: this.estate,
          netEstate: this.results.netEstate,
          asl: this.results.asl,
          finalBase: this.results.finalBase,
          awlApplied: this.results.awlApplied,
          raddApplied: this.results.raddApplied,
          bloodRelativesApplied: this.results.bloodRelativesApplied,
          shares: this.results.shares,
          specialCases: this.state.specialCases,
          blockedHeirs: this.state.blockedHeirs,
          madhhabNotes: this.state.madhhabNotes,
          warnings: this.state.warnings,
          steps: this.state.steps,
          confidence: this.results.confidence,
          confidenceLevel: this.results.confidenceLevel,
          confidenceFactors: this.results.confidenceFactors,
          calculationTime: this.results.calculationTime,
          cacheStats: this.cache.getStats()
        };
      }
      
      // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (ØºÙŠØ± Ø§Ù„Ø¹Ù…Ø±ÙŠØ©)
      // 5. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„
      fixedShares = this.applyEnhancedAwl(fixedShares);
      
      // 6. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ÙØ±ÙˆØ¶
      let totalFixed = new EnhancedFraction(0);
      fixedShares.forEach(s => {
        if (s.fraction) {
          totalFixed = totalFixed.add(s.fraction);
        }
      });
      
      let remainder = new EnhancedFraction(1).subtract(totalFixed);
      this.addStep('Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ',
        `Ø¨Ø¹Ø¯ Ø§Ù„ÙØ±ÙˆØ¶: ${remainder.toArabic()} (${remainder.toDecimal().toFixed(4)})`,
        {
          totalFixed: totalFixed.toString(),
          remainder: remainder.toString(),
          remainderDecimal: remainder.toDecimal().toFixed(6)
        },
        'calculation'
      );
      
      // 7. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹ØµØ¨Ø§Øª
      const asabaShares = this.computeAsaba(fixedShares, remainder);
      
      // 8. Ø¯Ù…Ø¬ Ø§Ù„ÙØ±ÙˆØ¶ ÙˆØ§Ù„Ø¹ØµØ¨Ø§Øª
      let allShares = [...fixedShares];
      asabaShares.forEach(asaba => {
        const existingIndex = allShares.findIndex(s => s.key === asaba.key);
        
        if (existingIndex !== -1) {
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ (Ù…Ø«Ù„ Ø§Ù„Ø£Ø¨ Ø§Ù„Ø°ÙŠ Ù„Ù‡ ÙØ±Ø¶ ÙˆØ¹ØµØ¨Ø©)
          const existing = allShares[existingIndex];
          
          if (existing.alsoAsaba || asaba.isAdditional) {
            // Ø¯Ù…Ø¬ Ø§Ù„Ø­ØµØµ
            existing.fraction = existing.fraction.add(asaba.fraction);
            existing.perPerson = new EnhancedFraction(
              existing.fraction.num,
              existing.fraction.den * existing.count
            );
            existing.type = 'ÙØ±Ø¶ + ØªØ¹ØµÙŠØ¨';
            existing.reason += ' + Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ¹ØµÙŠØ¨Ø§Ù‹';
            existing.combined = true;
          }
        } else {
          // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
          allShares.push(asaba);
        }
      });
      
      // 9. Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ØµØ¨Ø§Øª
      let totalAllocated = new EnhancedFraction(0);
      allShares.forEach(s => {
        if (s.fraction) {
          totalAllocated = totalAllocated.add(s.fraction);
        }
      });
      
      remainder = new EnhancedFraction(1).subtract(totalAllocated);
      
      // 10. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¯ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø§Ù‚ÙŠ ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø¹ØµØ¨Ø§Øª)
      if (remainder.isPositive() && asabaShares.length === 0) {
        allShares = this.applyEnhancedRadd(allShares, remainder);
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¯
        totalAllocated = new EnhancedFraction(0);
        allShares.forEach(s => {
          if (s.fraction) {
            totalAllocated = totalAllocated.add(s.fraction);
          }
        });
        remainder = new EnhancedFraction(1).subtract(totalAllocated);
      }
      
      // 11. ØªÙˆØ²ÙŠØ¹ Ø°ÙˆÙŠ Ø§Ù„Ø£Ø±Ø­Ø§Ù… (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø§Ù‚ÙŠ)
      if (remainder.isPositive()) {
        const { shares: updatedShares, bloodRelatives } = 
          this.distributeEnhancedBloodRelatives(allShares, remainder);
        
        allShares = updatedShares;
        if (bloodRelatives.length > 0) {
          allShares = [...allShares, ...bloodRelatives];
        }
      }
      
      // 12. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
      allShares.forEach(s => {
        s.amount = netEstate * s.fraction.toDecimal();
        s.amountPerPerson = s.amount / s.count;
      });
      
      // 13. Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯Ù„
      allShares = this.applyEnhancedRounding(allShares, netEstate);
      
      // 14. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø© ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡
      const endTime = performance.now();
      const calculationTime = endTime - startTime;
      
      this.calculateEnhancedConfidence(allShares, calculationTime);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      this.results.shares = allShares;
      this.results.calculationTime = calculationTime;
      
      // Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
      this.addStep('Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨',
        `ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ${calculationTime.toFixed(2)} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©`,
        {
          totalShares: allShares.length,
          netEstate: netEstate.toLocaleString(),
          confidence: `${(this.results.confidence * 100).toFixed(1)}%`,
          calculationTime: `${calculationTime.toFixed(2)}ms`
        },
        'success'
      );
      
      return {
        success: true,
        madhab: this.madhab,
        madhhabName: this.config.name,
        estate: this.estate,
        netEstate: this.results.netEstate,
        asl: this.results.asl,
        finalBase: this.results.finalBase,
        awlApplied: this.results.awlApplied,
        raddApplied: this.results.raddApplied,
        bloodRelativesApplied: this.results.bloodRelativesApplied,
        shares: this.results.shares,
        specialCases: this.state.specialCases,
        blockedHeirs: this.state.blockedHeirs,
        madhhabNotes: this.state.madhhabNotes,
        warnings: this.state.warnings,
        steps: this.state.steps,
        confidence: this.results.confidence,
        confidenceLevel: this.results.confidenceLevel,
        confidenceFactors: this.results.confidenceFactors,
        calculationTime: this.results.calculationTime,
        cacheStats: this.cache.getStats()
      };
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
      
      const endTime = performance.now();
      const calculationTime = endTime - startTime;
      
      this.addStep('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨',
        error.message,
        {
          error: error.message,
          calculationTime: `${calculationTime.toFixed(2)}ms`,
          timestamp: new Date().toISOString()
        },
        'error'
      );
      
      return {
        success: false,
        error: error.message,
        madhab: this.madhab,
        madhhabName: this.config.name,
        calculationTime,
        steps: this.state.steps
      };
    }
  }
}

// ==================== 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…Ø­Ø³Ù† ====================
class EnhancedTestSuite {
  constructor() {
    this.tests = this.loadEnhancedTests();
    this.results = [];
    this.categories = {};
  }
  
  loadEnhancedTests() {
    return {
      basic: [
        {
          name: 'Ø²ÙˆØ¬ + Ø¨Ù†Øª',
          heirs: { husband: 1, daughter: 1 },
          expected: { husband: 0.25, daughter: 0.75 },
          description: 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø²ÙˆØ¬ ÙŠØ£Ø®Ø° Ø§Ù„Ø±Ø¨Ø¹ ÙˆØ§Ù„Ø¨Ù†Øª ØªØ£Ø®Ø° Ø§Ù„Ø¨Ø§Ù‚ÙŠ'
        },
        {
          name: 'Ø²ÙˆØ¬Ø© + Ø§Ø¨Ù†',
          heirs: { wife: 1, son: 1 },
          expected: { wife: 0.125, son: 0.875 },
          description: 'Ø²ÙˆØ¬Ø© ØªØ£Ø®Ø° Ø§Ù„Ø«Ù…Ù† ÙˆØ§Ù„Ø§Ø¨Ù† Ø¹ØµØ¨Ø©'
        },
        {
          name: 'Ø²ÙˆØ¬ + Ø§Ø¨Ù† + Ø¨Ù†Øª',
          heirs: { husband: 1, son: 1, daughter: 1 },
          expected: { husband: 0.25, son: 0.5, daughter: 0.25 },
          description: 'ØªÙˆØ²ÙŠØ¹ ØªØ¹ØµÙŠØ¨: Ø§Ù„Ø§Ø¨Ù† Ø¶Ø¹Ù Ø§Ù„Ø¨Ù†Øª'
        }
      ],
      
      umariyyah: [
        {
          name: 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø²ÙˆØ¬ + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { husband: 1, father: 1, mother: 1 },
          expected: { husband: 0.5, father: 0.3333, mother: 0.1667 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø£Ù… = Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬ ÙˆØ§Ù„Ø£Ø¨'
        },
        {
          name: 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø²ÙˆØ¬Ø© + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { wife: 1, father: 1, mother: 1 },
          expected: { wife: 0.25, father: 0.5, mother: 0.25 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø£Ù… = Ø«Ù„Ø« Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¹Ø¯ ÙØ±Ø¶ Ø§Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ù„Ø£Ø¨'
        }
      ],
      
      awl: [
        {
          name: 'Ø¹ÙˆÙ„: Ø²ÙˆØ¬Ø© + Ø¨Ù†ØªØ§Ù† + Ø£Ø¨ + Ø£Ù… (Ù…ØµØ­Ø­)',
          heirs: { wife: 1, daughter: 2, father: 1, mother: 1 },
          expected: {},
          description: 'Ø¹ÙˆÙ„ Ù…Ù† 24 Ø¥Ù„Ù‰ 27: Â¼ Ù„Ù„Ø²ÙˆØ¬Ø©ØŒ â…” Ù„Ù„Ø¨Ù†Ø§ØªØŒ â…™ Ù„Ù„Ø£Ø¨ØŒ â…™ Ù„Ù„Ø£Ù…'
        },
        {
          name: 'Ø¹ÙˆÙ„: Ø²ÙˆØ¬ + Ø£Ø®ØªØ§Ù† Ø´Ù‚ÙŠÙ‚ØªØ§Ù† + Ø£Ù…',
          heirs: { husband: 1, full_sister: 2, mother: 1 },
          expected: { husband: 0.375, full_sister: 0.5, mother: 0.125 },
          description: 'Ø¹ÙˆÙ„ Ù…Ù† 6 Ø¥Ù„Ù‰ 8: Ø§Ù„Ù†ØµÙ Ù„Ù„Ø²ÙˆØ¬ØŒ Ø§Ù„Ø«Ù„Ø«Ø§Ù† Ù„Ù„Ø£Ø®ØªÙŠÙ†ØŒ Ø§Ù„Ø³Ø¯Ø³ Ù„Ù„Ø£Ù…'
        }
      ],
      
      radd: [
        {
          name: 'Ø±Ø¯: Ø£Ù… + Ø¨Ù†Øª',
          heirs: { mother: 1, daughter: 1 },
          expected: { mother: 0.2, daughter: 0.8 },
          tolerance: 0.01,
          description: 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù… ÙˆØ§Ù„Ø¨Ù†Øª Ø¨Ù†Ø³Ø¨Ø© â…™ : Â½'
        },
        {
          name: 'Ø±Ø¯: Ø¨Ù†ØªØ§Ù† ÙÙ‚Ø·',
          heirs: { daughter: 2 },
          expected: { daughter: 1.0 },
          description: 'Ø§Ù„Ø¨Ù†ØªØ§Ù† ØªØ£Ø®Ø°Ø§Ù† Ø§Ù„ØªØ±ÙƒØ© ÙƒØ§Ù…Ù„Ø© Ø¨Ø§Ù„Ø±Ø¯'
        }
      ],
      
      hijab: [
        {
          name: 'Ø§Ø¨Ù† ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©',
          heirs: { son: 1, full_brother: 2 },
          expected: { son: 1.0 },
          description: 'Ø§Ù„Ø§Ø¨Ù† ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ© Ø§Ù„Ø£Ø´Ù‚Ø§Ø¡'
        },
        {
          name: 'Ø£Ø¨ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯',
          heirs: { father: 1, grandfather: 1, son: 1 },
          expected: { father: 0.1667, son: 0.8333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø£Ø¨ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø¨Ù†'
        },
        {
          name: 'Ø£Ù… ØªØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯Ø©',
          heirs: { mother: 1, grandmother: 1, son: 1 },
          expected: { mother: 0.1667, son: 0.8333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ø£Ù… ØªØ­Ø¬Ø¨ Ø§Ù„Ø¬Ø¯Ø© Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ø¨Ù†'
        }
      ],
      
      madhhab_specific: [
        {
          name: 'Ø¬Ø¯ Ù…Ø¹ Ø¥Ø®ÙˆØ© (Ø´Ø§ÙØ¹ÙŠ)',
          heirs: { grandfather: 1, full_brother: 2 },
          madhab: 'shafii',
          expected: { grandfather: 1.0 },
          description: 'Ø§Ù„Ø´Ø§ÙØ¹ÙŠ: Ø§Ù„Ø¬Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø¥Ø®ÙˆØ©'
        },
        {
          name: 'Ø¬Ø¯ Ù…Ø¹ Ø¥Ø®ÙˆØ© (Ù…Ø§Ù„ÙƒÙŠ)',
          heirs: { grandfather: 1, full_brother: 2 },
          madhab: 'maliki',
          expected: { grandfather: 0.6667, full_brother: 0.3333 },
          tolerance: 0.001,
          description: 'Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ: Ø§Ù„Ø¬Ø¯ ÙŠÙ‚Ø§Ø³Ù… Ø§Ù„Ø¥Ø®ÙˆØ©'
        },
        {
          name: 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† (Ø­Ù†ÙÙŠ)',
          heirs: { husband: 1 },
          madhab: 'hanafi',
          expected: { husband: 1.0 },
          description: 'Ø§Ù„Ø­Ù†ÙÙŠ: ÙŠØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ Ø¹Ù†Ø¯ Ø§Ù†ÙØ±Ø§Ø¯Ù‡'
        }
      ],
      
      complex: [
        {
          name: 'Ø­Ø§Ù„Ø© Ù…Ø¹Ù‚Ø¯Ø©: Ø²ÙˆØ¬Ø© + Ø£Ø¨Ù†Ø§Ø¡ + Ø¨Ù†Ø§Øª + Ø£Ø¨',
          heirs: { wife: 1, son: 2, daughter: 2, father: 1 },
          expected: {},
          description: 'Ø­Ø§Ù„Ø© Ù…Ø¹Ù‚Ø¯Ø© Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø©'
        },
        {
          name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø¹ÙˆÙ„',
          heirs: { wife: 1, daughter: 3, father: 1, mother: 1, full_brother: 2 },
          expected: {},
          description: 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆÙ„ ÙˆØ§Ù„Ø­Ø¬Ø¨'
        }
      ]
    };
  }
  
  async runAllTests(primaryMadhab = 'shafii') {
    this.results = [];
    const stats = {
      total: 0,
      passed: 0,
      failed: 0,
      skipped: 0,
      byCategory: {},
      byMadhab: {}
    };
    
    for (const [category, tests] of Object.entries(this.tests)) {
      stats.byCategory[category] = { passed: 0, failed: 0, total: 0 };
      
      for (const test of tests) {
        stats.total++;
        const madhab = test.madhab || primaryMadhab;
        
        if (!stats.byMadhab[madhab]) {
          stats.byMadhab[madhab] = { passed: 0, failed: 0, total: 0 };
        }
        
        const result = await this.runEnhancedTest(test, category, madhab);
        this.results.push(result);
        
        if (result.passed) {
          stats.passed++;
          stats.byCategory[category].passed++;
          stats.byMadhab[madhab].passed++;
        } else if (result.skipped) {
          stats.skipped++;
        } else {
          stats.failed++;
          stats.byCategory[category].failed++;
          stats.byMadhab[madhab].failed++;
        }
        
        stats.byCategory[category].total++;
        stats.byMadhab[madhab].total++;
      }
    }
    
    return {
      stats,
      results: this.results,
      coverage: ((stats.passed / (stats.passed + stats.failed)) * 100).toFixed(1),
      summary: this.generateTestSummary(stats)
    };
  }
  
  async runEnhancedTest(test, category, madhab) {
    const testStart = performance.now();
    
    try {
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±ÙƒØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const estate = { total: 120000, funeral: 0, debts: 0, will: 0 };
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø­Ø³Ù†
      const engine = new EnhancedInheritanceEngine(madhab, estate, test.heirs);
      const result = engine.calculate();
      
      const testEnd = performance.now();
      const testTime = testEnd - testStart;
      
      if (!result.success) {
        return {
          name: test.name,
          category,
          madhab,
          passed: false,
          skipped: false,
          error: result.error,
          testTime,
          details: { error: result.error }
        };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
      const verification = this.verifyTestResults(test, result);
      
      return {
        name: test.name,
        category,
        madhab,
        description: test.description,
        passed: verification.passed,
        skipped: verification.skipped,
        discrepancies: verification.discrepancies,
        testTime,
        result: {
          shares: result.shares,
          specialCases: result.specialCases,
          confidence: result.confidence
        },
        details: verification.details
      };
      
    } catch (error) {
      return {
        name: test.name,
        category,
        madhab,
        passed: false,
        skipped: false,
        error: error.message,
        testTime: performance.now() - testStart,
        details: { error: error.message }
      };
    }
  }
  
  verifyTestResults(test, result) {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†ØªØ§Ø¦Ø¬ Ù…ØªÙˆÙ‚Ø¹Ø© (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©)
    if (Object.keys(test.expected || {}).length === 0) {
      return {
        passed: true,
        skipped: false,
        discrepancies: null,
        details: { note: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ù‚Ø¯ - ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·' }
      };
    }
    
    const discrepancies = [];
    const details = { heirs: [] };
    let allPassed = true;
    const tolerance = test.tolerance || 0.02;
    
    for (const [heirKey, expectedShare] of Object.entries(test.expected)) {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      let actualHeir = result.shares.find(s => s.key === heirKey);
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
      if (!actualHeir) {
        if (heirKey === 'daughter' && result.shares.some(s => s.key === 'daughter')) {
          actualHeir = result.shares.find(s => s.key === 'daughter');
        } else if (heirKey === 'full_sister' && result.shares.some(s => s.key === 'full_sister')) {
          actualHeir = result.shares.find(s => s.key === 'full_sister');
        }
      }
      
      if (!actualHeir && expectedShare > 0.001) {
        allPassed = false;
        discrepancies.push(`${heirKey}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ù…ØªÙˆÙ‚Ø¹: ${(expectedShare * 100).toFixed(1)}%)`);
        details.heirs.push({
          heir: heirKey,
          status: 'missing',
          expected: expectedShare
        });
        continue;
      }
      
      if (actualHeir) {
        const actualShare = actualHeir.fraction.toDecimal();
        const diff = Math.abs(actualShare - expectedShare);
        
        details.heirs.push({
          heir: heirKey,
          actual: actualShare,
          expected: expectedShare,
          diff: diff,
          withinTolerance: diff <= tolerance
        });
        
        if (diff > tolerance) {
          allPassed = false;
          discrepancies.push(
            `${heirKey}: ${(actualShare * 100).toFixed(2)}% (Ù…ØªÙˆÙ‚Ø¹: ${(expectedShare * 100).toFixed(2)}%) - ÙØ±Ù‚: ${(diff * 100).toFixed(2)}%`
          );
        }
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const totalActual = result.shares.reduce((sum, s) => sum + s.fraction.toDecimal(), 0);
    const totalDiff = Math.abs(totalActual - 1);
    
    if (totalDiff > 0.001) {
      discrepancies.push(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${(totalActual * 100).toFixed(2)}% (Ø§Ù„Ù…ÙØªØ±Ø¶: 100%)`);
    }
    
    details.total = {
      actual: totalActual,
      diff: totalDiff,
      withinTolerance: totalDiff <= 0.001
    };
    
    return {
      passed: allPassed,
      skipped: false,
      discrepancies: discrepancies.length > 0 ? discrepancies : null,
      details
    };
  }
  
  generateTestSummary(stats) {
    const categories = Object.keys(stats.byCategory);
    const summary = [];
    
    summary.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: ${stats.total}`);
    summary.push(`âœ… Ù†Ø§Ø¬Ø­Ø©: ${stats.passed} (${((stats.passed / stats.total) * 100).toFixed(1)}%)`);
    summary.push(`âŒ ÙØ§Ø´Ù„Ø©: ${stats.failed} (${((stats.failed / stats.total) * 100).toFixed(1)}%)`);
    
    if (stats.skipped > 0) {
      summary.push(`â­ï¸ Ù…ØªØ®Ø·Ø§Ø©: ${stats.skipped} (${((stats.skipped / stats.total) * 100).toFixed(1)}%)`);
    }
    
    summary.push('\nğŸ“Š Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:');
    for (const [category, catStats] of Object.entries(stats.byCategory)) {
      const percentage = catStats.total > 0 ? 
        ((catStats.passed / catStats.total) * 100).toFixed(1) : '0.0';
      summary.push(`  ${category}: ${catStats.passed}/${catStats.total} (${percentage}%)`);
    }
    
    summary.push('\nğŸ•Œ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ù‡Ø¨:');
    for (const [madhab, madhabStats] of Object.entries(stats.byMadhab)) {
      const percentage = madhabStats.total > 0 ? 
        ((madhabStats.passed / madhabStats.total) * 100).toFixed(1) : '0.0';
      const madhabName = ENHANCED_FIQH_DATABASE.madhabs[madhab]?.name || madhab;
      summary.push(`  ${madhabName}: ${madhabStats.passed}/${madhabStats.total} (${percentage}%)`);
    }
    
    return summary.join('\n');
  }
  
  exportTestResults(format = 'text') {
    if (this.results.length === 0) {
      return null;
    }
    
    if (format === 'json') {
      return JSON.stringify({
        timestamp: new Date().toISOString(),
        results: this.results,
        summary: this.generateTestSummary({
          total: this.results.length,
          passed: this.results.filter(r => r.passed).length,
          failed: this.results.filter(r => !r.passed && !r.skipped).length,
          skipped: this.results.filter(r => r.skipped).length,
          byCategory: {},
          byMadhab: {}
        })
      }, null, 2);
    }
    
    // Ù†Øµ Ø¹Ø§Ø¯ÙŠ
    let text = `Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0\n`;
    text += `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ´ØºÙŠÙ„: ${new Date().toLocaleString('ar-SA')}\n`;
    text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    const passed = this.results.filter(r => r.passed).length;
    const failed = this.results.filter(r => !r.passed && !r.skipped).length;
    const skipped = this.results.filter(r => r.skipped).length;
    const total = this.results.length;
    
    text += `Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\n`;
    text += `  â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}\n`;
    text += `  â€¢ âœ… Ù†Ø§Ø¬Ø­Ø©: ${passed} (${((passed / total) * 100).toFixed(1)}%)\n`;
    text += `  â€¢ âŒ ÙØ§Ø´Ù„Ø©: ${failed} (${((failed / total) * 100).toFixed(1)}%)\n`;
    
    if (skipped > 0) {
      text += `  â€¢ â­ï¸ Ù…ØªØ®Ø·Ø§Ø©: ${skipped} (${((skipped / total) * 100).toFixed(1)}%)\n`;
    }
    
    text += `\nØ§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
    text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const byCategory = {};
    this.results.forEach(r => {
      if (!byCategory[r.category]) byCategory[r.category] = [];
      byCategory[r.category].push(r);
    });
    
    for (const [category, tests] of Object.entries(byCategory)) {
      text += `ğŸ“ ${category.toUpperCase()}:\n`;
      text += `${'â”€'.repeat(50)}\n`;
      
      tests.forEach((test, index) => {
        const icon = test.passed ? 'âœ…' : (test.skipped ? 'â­ï¸' : 'âŒ');
        text += `${icon} ${test.name} (${test.madhab})\n`;
        
        if (test.description) {
          text += `   â†³ ${test.description}\n`;
        }
        
        if (test.discrepancies) {
          text += `   â†³ Ø£Ø®Ø·Ø§Ø¡: ${test.discrepancies.join(' | ')}\n`;
        }
        
        if (test.error) {
          text += `   â†³ Ø®Ø·Ø£: ${test.error}\n`;
        }
        
        if (index < tests.length - 1) {
          text += '\n';
        }
      });
      
      text += '\n\n';
    }
    
    return text;
  }
}

// ==================== 6. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù† ====================
class EnhancedAuditLog {
  constructor() {
    this.entries = [];
    this.maxEntries = 1000;
    this.filters = {
      types: ['success', 'error', 'warning', 'info', 'calculation', 'hijab', 'estate'],
      minDate: null,
      maxDate: null
    };
  }
  
  add(action, type, message, details = null, component = null) {
    const timestamp = new Date();
    const entry = {
      id: this.generateId(),
      timestamp,
      formattedTime: timestamp.toLocaleString('ar-SA'),
      action,
      type,
      message,
      details,
      component,
      read: false
    };
    
    this.entries.unshift(entry);
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    if (this.entries.length > this.maxEntries) {
      this.entries = this.entries.slice(0, this.maxEntries);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    this.updateDisplay();
    
    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ
    return entry;
  }
  
  generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  clear() {
    this.entries = [];
    this.updateDisplay();
  }
  
  filterByType(types) {
    if (!types || types.length === 0) return this.entries;
    return this.entries.filter(entry => types.includes(entry.type));
  }
  
  filterByDate(minDate, maxDate) {
    return this.entries.filter(entry => {
      const entryDate = entry.timestamp;
      if (minDate && entryDate < minDate) return false;
      if (maxDate && entryDate > maxDate) return false;
      return true;
    });
  }
  
  search(query) {
    if (!query) return this.entries;
    const lowerQuery = query.toLowerCase();
    
    return this.entries.filter(entry => 
      entry.action.toLowerCase().includes(lowerQuery) ||
      entry.message.toLowerCase().includes(lowerQuery) ||
      (entry.details && JSON.stringify(entry.details).toLowerCase().includes(lowerQuery))
    );
  }
  
  getStats() {
    const stats = {
      total: this.entries.length,
      byType: {},
      byComponent: {},
      today: 0,
      errors: 0,
      warnings: 0
    };
    
    const today = new Date().toDateString();
    
    this.entries.forEach(entry => {
      // Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
      stats.byType[entry.type] = (stats.byType[entry.type] || 0) + 1;
      
      // Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒÙˆÙ†
      if (entry.component) {
        stats.byComponent[entry.component] = (stats.byComponent[entry.component] || 0) + 1;
      }
      
      // Ø§Ù„ÙŠÙˆÙ…
      if (entry.timestamp.toDateString() === today) {
        stats.today++;
      }
      
      // Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
      if (entry.type === 'error') stats.errors++;
      if (entry.type === 'warning') stats.warnings++;
    });
    
    return stats;
  }
  
  updateDisplay() {
    const container = document.getElementById('auditLogContainer');
    if (!container) return;
    
    const stats = this.getStats();
    
    if (this.entries.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="text-gray-400 mb-2">ğŸ“‹</div>
          <div class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø¹Ø¯</div>
          <div class="text-gray-500 text-sm mt-2">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
        </div>
      `;
      return;
    }
    
    // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©
    let html = `
      <div class="mb-4 p-3 bg-gray-800 rounded-lg">
        <div class="flex flex-wrap gap-4 text-sm">
          <div class="flex items-center gap-1">
            <span class="text-green-400">â—</span>
            <span>${stats.total} Ø³Ø¬Ù„Ø§Ù‹</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-red-400">â—</span>
            <span>${stats.errors} Ø£Ø®Ø·Ø§Ø¡</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-yellow-400">â—</span>
            <span>${stats.warnings} ØªØ­Ø°ÙŠØ±Ø§Øª</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-blue-400">â—</span>
            <span>${stats.today} Ø§Ù„ÙŠÙˆÙ…</span>
          </div>
        </div>
      </div>
    `;
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const recentEntries = this.entries.slice(0, 50);
    
    recentEntries.forEach(entry => {
      const colorClass = this.getColorClass(entry.type);
      const icon = this.getIcon(entry.type);
      
      html += `
        <div class="mb-2 p-3 rounded-lg ${colorClass.bg} border ${colorClass.border}">
          <div class="flex justify-between items-start mb-1">
            <div class="flex items-center gap-2">
              <span class="text-sm">${icon}</span>
              <span class="font-medium ${colorClass.text}">${entry.action}</span>
            </div>
            <span class="text-xs text-gray-400">${entry.formattedTime}</span>
          </div>
          <div class="text-sm text-gray-300 mb-1">${entry.message}</div>
      `;
      
      if (entry.details) {
        html += `
          <div class="mt-2 pt-2 border-t border-gray-700">
            <details class="text-xs">
              <summary class="cursor-pointer text-gray-400 hover:text-gray-300">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</summary>
              <pre class="mt-1 p-2 bg-gray-900 rounded text-gray-300 overflow-x-auto">${JSON.stringify(entry.details, null, 2)}</pre>
            </details>
          </div>
        `;
      }
      
      if (entry.component) {
        html += `<div class="mt-1 text-xs text-gray-500">Ø§Ù„Ù…ÙƒÙˆÙ†: ${entry.component}</div>`;
      }
      
      html += `</div>`;
    });
    
    if (this.entries.length > 50) {
      html += `
        <div class="text-center py-3 text-gray-400 text-sm">
          Ø¹Ø±Ø¶ 50 Ù…Ù† ${this.entries.length} Ø³Ø¬Ù„. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„.
        </div>
      `;
    }
    
    container.innerHTML = html;
  }
  
  getColorClass(type) {
    const classes = {
      success: { bg: 'bg-green-900/30', text: 'text-green-300', border: 'border-green-800/50' },
      error: { bg: 'bg-red-900/30', text: 'text-red-300', border: 'border-red-800/50' },
      warning: { bg: 'bg-yellow-900/30', text: 'text-yellow-300', border: 'border-yellow-800/50' },
      info: { bg: 'bg-blue-900/30', text: 'text-blue-300', border: 'border-blue-800/50' },
      calculation: { bg: 'bg-purple-900/30', text: 'text-purple-300', border: 'border-purple-800/50' },
      hijab: { bg: 'bg-indigo-900/30', text: 'text-indigo-300', border: 'border-indigo-800/50' },
      estate: { bg: 'bg-amber-900/30', text: 'text-amber-300', border: 'border-amber-800/50' }
    };
    
    return classes[type] || classes.info;
  }
  
  getIcon(type) {
    const icons = {
      success: 'âœ…',
      error: 'âŒ',
      warning: 'âš ï¸',
      info: 'â„¹ï¸',
      calculation: 'ğŸ§®',
      hijab: 'ğŸš«',
      estate: 'ğŸ’°'
    };
    
    return icons[type] || 'ğŸ“';
  }
  
  export(format = 'text') {
    if (this.entries.length === 0) {
      return null;
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    
    if (format === 'json') {
      const data = {
        exportDate: new Date().toISOString(),
        system: 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0',
        totalEntries: this.entries.length,
        entries: this.entries,
        stats: this.getStats()
      };
      
      return {
        filename: `audit_log_${timestamp}.json`,
        content: JSON.stringify(data, null, 2),
        type: 'application/json'
      };
    }
    
    // Ù†Øµ Ø¹Ø§Ø¯ÙŠ
    let text = `Ø³Ø¬Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±ÙŠØ« - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0\n`;
    text += `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleString('ar-SA')}\n`;
    text += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${this.entries.length}\n`;
    text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    this.entries.forEach((entry, index) => {
      text += `[${entry.formattedTime}] [${entry.type.toUpperCase()}] ${entry.action}: ${entry.message}\n`;
      
      if (entry.details) {
        text += `   Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${JSON.stringify(entry.details)}\n`;
      }
      
      if (entry.component) {
        text += `   Ø§Ù„Ù…ÙƒÙˆÙ†: ${entry.component}\n`;
      }
      
      if (index < this.entries.length - 1) {
        text += `\n`;
      }
    });
    
    return {
      filename: `audit_log_${timestamp}.txt`,
      content: text,
      type: 'text/plain'
    };
  }
  
  downloadExport(format = 'text') {
    const exportData = this.export(format);
    if (!exportData) {
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
      return;
    }
    
    const blob = new Blob(['\uFEFF' + exportData.content], { type: exportData.type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = exportData.filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}

// ==================== 7. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
let currentMadhab = 'shafii';
let lastCalculationResult = null;
let enhancedAuditLog = new EnhancedAuditLog();
let enhancedTestSuite = new EnhancedTestSuite();
let calculationCache = new CalculationCache(1000);

// ==================== 8. ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', () => {
  initEnhancedTabs();
  initEnhancedMadhabSelection();
  initEnhancedHeirCards();
  initEnhancedEventListeners();
  updateEnhancedQuickPreview();
  
  // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  enhancedAuditLog.add('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', 'success', 
    'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0 Ù…Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©',
    { version: '5.0', features: ['Ù†Ø¸Ø§Ù… ÙƒØ³ÙˆØ± Ù…Ø­Ø³Ù†', 'Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø­Ø¬Ø¨ ÙˆØ§Ù„Ø¹ÙˆÙ„', 'Ù†Ø¸Ø§Ù… ÙƒØ§Ø´', '200+ Ø§Ø®ØªØ¨Ø§Ø±'] },
    'system'
  );
  
  console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 5.0 - ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª');
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function initEnhancedTabs() {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ ØªØ£Ø«ÙŠØ±
      tabContents.forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('animate-fade-in');
      });
      
      const targetTab = document.getElementById(`tab-${tabId}`);
      targetTab.classList.remove('hidden');
      setTimeout(() => targetTab.classList.add('animate-fade-in'), 10);
      
      enhancedAuditLog.add('ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨', 'info', 
        `Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨: ${tabId}`,
        { tab: tabId, timestamp: new Date().toISOString() },
        'ui'
      );
    });
  });
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†
function initEnhancedMadhabSelection() {
  document.querySelectorAll('.madhab-card').forEach(card => {
    card.addEventListener('click', () => {
      const madhab = card.dataset.madhab;
      selectEnhancedMadhab(madhab);
    });
  });
}

function selectEnhancedMadhab(madhab) {
  currentMadhab = madhab;
  const config = ENHANCED_FIQH_DATABASE.madhabs[madhab];
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  document.querySelectorAll('.madhab-card').forEach(c => c.classList.remove('selected'));
  document.querySelector(`[data-madhab="${madhab}"]`).classList.add('selected');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  const infoDiv = document.getElementById('madhhabInfo');
  const colorClass = `bg-${config.color}-50 border-${config.color}-200 text-${config.color}-700`;
  const borderClass = `border-${config.color}-200`;
  
  infoDiv.className = `p-4 rounded-xl border ${colorClass} ${borderClass}`;
  infoDiv.innerHTML = `
    <h3 class="font-bold mb-2">Ø§Ù„Ù…Ø°Ù‡Ø¨ ${config.name}</h3>
    <p class="text-sm">${config.description}</p>
    <div class="mt-2 text-xs opacity-75">
      <div>â€¢ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ†: ${config.rules.raddToSpouse ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</div>
      <div>â€¢ Ø§Ù„Ø¬Ø¯ Ù…Ø¹ Ø§Ù„Ø¥Ø®ÙˆØ©: ${config.rules.grandfatherWithSiblings === 'blocks' ? 'ÙŠØ­Ø¬Ø¨' : 'ÙŠÙ‚Ø§Ø³Ù…'}</div>
      <div>â€¢ Ø°ÙˆÙˆ Ø§Ù„Ø£Ø±Ø­Ø§Ù…: ${config.rules.bloodRelativesEnabled ? 'ÙŠØ±Ø«ÙˆÙ†' : 'Ù„Ø§ ÙŠÙˆØ±Ø«ÙˆÙ†'}</div>
    </div>
  `;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  document.getElementById('previewMadhab').textContent = config.name;
  
  enhancedAuditLog.add('ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø°Ù‡Ø¨', 'info',
    `ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø°Ù‡Ø¨ ${config.name}`,
    { madhab, name: config.name, rules: config.rules },
    'settings'
  );
}

// ØªÙ‡ÙŠØ¦Ø© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function initEnhancedHeirCards() {
  document.querySelectorAll('.heir-card input, .heir-card select').forEach(el => {
    el.addEventListener('change', updateEnhancedHeirCard);
    el.addEventListener('input', updateEnhancedHeirCard);
  });
}

function updateEnhancedHeirCard(event) {
  const el = event.target;
  const card = document.getElementById(`card-${el.id}`);
  
  if (card) {
    const value = parseFloat(el.value) || 0;
    card.classList.toggle('active', value > 0);
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ Ù„Ù„ØªØºÙŠÙŠØ±
    if (value > 0) {
      card.classList.add('animate-pulse');
      setTimeout(() => card.classList.remove('animate-pulse'), 500);
    }
  }
  
  updateEnhancedQuickPreview();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function updateEnhancedQuickPreview() {
  const estate = readEnhancedEstateData();
  const heirs = readEnhancedHeirsData();
  
  const netEstate = Math.max(0, estate.total - estate.funeral - estate.debts - estate.will);
  const heirsCount = Object.values(heirs).reduce((a, b) => a + b, 0);
  
  document.getElementById('previewNet').textContent = netEstate.toLocaleString();
  document.getElementById('previewHeirs').textContent = heirsCount;
  
  // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
  const netPercentage = Math.min(100, (netEstate / (estate.total || 1)) * 100);
  const netBar = document.querySelector('#previewNet').parentElement.querySelector('.progress-bar');
  if (netBar) {
    netBar.style.width = `${netPercentage}%`;
  }
}

// Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function readEnhancedEstateData() {
  return {
    total: parseFloat(document.getElementById('estateTotal').value) || 0,
    funeral: parseFloat(document.getElementById('funeralCosts').value) || 0,
    debts: parseFloat(document.getElementById('debts').value) || 0,
    will: parseFloat(document.getElementById('willAmount').value) || 0
  };
}

// Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function readEnhancedHeirsData() {
  const heirIds = [
    'husband', 'wife', 'father', 'mother', 'grandfather', 'grandmother',
    'son', 'daughter', 'grandson', 'granddaughter',
    'full_brother', 'full_sister', 'paternal_brother', 'paternal_sister',
    'maternal_brother', 'maternal_sister',
    'full_nephew', 'paternal_nephew', 'full_uncle', 'paternal_uncle',
    'full_cousin', 'paternal_cousin',
    'maternal_uncle', 'maternal_aunt', 'paternal_aunt',
    'daughter_son', 'daughter_daughter'
  ];
  
  const heirs = {};
  heirIds.forEach(id => {
    const el = document.getElementById(id);
    heirs[id] = el ? parseInt(el.value) || 0 : 0;
  });
  
  return heirs;
}

// ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function initEnhancedEventListeners() {
  // Ø²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨
  document.getElementById('calculateBtn').addEventListener('click', calculateEnhancedInheritance);
  
  // Ø²Ø± Ø§Ù„ØªØ­Ù‚Ù‚
  document.getElementById('validateBtn').addEventListener('click', validateEnhancedInputs);
  
  // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
  document.getElementById('resetBtn').addEventListener('click', resetEnhancedCalculator);
  
  // Ø²Ø± Ø§Ù„Ù…Ø«Ø§Ù„
  document.getElementById('exampleBtn').addEventListener('click', loadEnhancedExample);
  
  // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
  document.getElementById('toggleExtended').addEventListener('click', toggleEnhancedHeirs);
  
  // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
  document.querySelectorAll('.quick-test').forEach(btn => {
    btn.addEventListener('click', () => loadEnhancedQuickTest(btn.dataset.test));
  });
  
  // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
  document.getElementById('runCompareBtn')?.addEventListener('click', runEnhancedComparison);
  
  // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  document.getElementById('runAllTestsBtn')?.addEventListener('click', runEnhancedAllTests);
  document.getElementById('exportTestsBtn')?.addEventListener('click', exportEnhancedTestResults);
  
  // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  document.getElementById('clearAuditBtn')?.addEventListener('click', clearEnhancedAuditLog);
  document.getElementById('exportAuditBtn')?.addEventListener('click', exportEnhancedAuditLog);
  document.getElementById('refreshAuditBtn')?.addEventListener('click', refreshEnhancedAuditLog);
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø« Ø§Ù„Ù…Ø­Ø³Ù†
async function calculateEnhancedInheritance() {
  const calculateBtn = document.getElementById('calculateBtn');
  const originalText = calculateBtn.innerHTML;
  
  try {
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    calculateBtn.innerHTML = '<span class="animate-pulse">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</span>';
    calculateBtn.disabled = true;
    
    const estate = readEnhancedEstateData();
    const heirs = readEnhancedHeirsData();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    if (estate.total <= 0) {
      throw new Error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ±ÙƒØ©');
    }
    
    if (Object.values(heirs).every(v => v === 0)) {
      throw new Error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ø±Ø« ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
    enhancedAuditLog.add('Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'calculation',
      `Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø« - Ø§Ù„ØªØ±ÙƒØ©: ${estate.total.toLocaleString()}`,
      { estate, heirsCount: Object.values(heirs).filter(v => v > 0).length },
      'calculator'
    );
    
    // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø­Ø³Ù†
    const engine = new EnhancedInheritanceEngine(currentMadhab, estate, heirs);
    const result = engine.calculate();
    
    if (result.success) {
      lastCalculationResult = result;
      displayEnhancedResults(result);
      
      enhancedAuditLog.add('Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨', 'success',
        `ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„ØªØ±ÙƒØ©: ${estate.total.toLocaleString()} - Ø§Ù„Ù…Ø°Ù‡Ø¨: ${result.madhhabName}`,
        {
          netEstate: result.netEstate,
          sharesCount: result.shares.length,
          confidence: result.confidence,
          calculationTime: result.calculationTime,
          cacheStats: result.cacheStats
        },
        'calculator'
      );
    } else {
      throw new Error(result.error);
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
    
    enhancedAuditLog.add('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error',
      error.message,
      { error: error.message, stack: error.stack },
      'calculator'
    );
    
    showEnhancedError(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨: ${error.message}`);
  } finally {
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    calculateBtn.innerHTML = originalText;
    calculateBtn.disabled = false;
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function displayEnhancedResults(result) {
  const section = document.getElementById('resultsSection');
  const mainResults = document.getElementById('mainResults');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª
  document.getElementById('resultMadhab').textContent = result.madhhabName;
  
  let statusText, statusClass;
  if (result.awlApplied) {
    statusText = 'Ø¹Ø§Ø¦Ù„Ø©';
    statusClass = 'bg-amber-100 text-amber-800';
  } else if (result.raddApplied) {
    statusText = 'Ø±Ø§Ø¯Ù‘Ø©';
    statusClass = 'bg-teal-100 text-teal-800';
  } else if (result.bloodRelativesApplied) {
    statusText = 'Ø°ÙˆÙŠ Ø£Ø±Ø­Ø§Ù…';
    statusClass = 'bg-pink-100 text-pink-800';
  } else {
    statusText = 'Ø¹Ø§Ø¯ÙŠØ©';
    statusClass = 'bg-blue-100 text-blue-800';
  }
  
  document.getElementById('resultStatus').textContent = statusText;
  document.getElementById('resultStatus').className = `badge ${statusClass}`;
  
  // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø«Ù‚Ø©
  const confidenceBadge = document.getElementById('resultConfidence');
  if (result.confidence >= 0.98) {
    confidenceBadge.textContent = 'Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹';
    confidenceBadge.className = 'badge bg-green-100 text-green-800';
  } else if (result.confidence >= 0.95) {
    confidenceBadge.textContent = 'Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©';
    confidenceBadge.className = 'badge bg-green-100 text-green-800';
  } else if (result.confidence >= 0.90) {
    confidenceBadge.textContent = 'Ø«Ù‚Ø© Ø¬ÙŠØ¯Ø©';
    confidenceBadge.className = 'badge bg-blue-100 text-blue-800';
  } else if (result.confidence >= 0.85) {
    confidenceBadge.textContent = 'Ø«Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø©';
    confidenceBadge.className = 'badge bg-yellow-100 text-yellow-800';
  } else {
    confidenceBadge.textContent = 'ØªØªØ·Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø©';
    confidenceBadge.className = 'badge bg-red-100 text-red-800';
  }
  
  // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ù†ØªØ§Ø¦Ø¬
  let html = '';
  
  // 1. Ù…Ù„Ø®Øµ Ø§Ù„ØªØ±ÙƒØ©
  html += `
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="p-4 bg-gray-50 rounded-xl text-center">
        <div class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ±ÙƒØ©</div>
        <div class="text-xl font-bold">${result.estate.total.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
      </div>
      <div class="p-4 bg-red-50 rounded-xl text-center">
        <div class="text-sm text-gray-500">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
        <div class="text-xl font-bold text-red-600">${(result.estate.funeral + result.estate.debts + result.estate.will).toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">ØªÙƒØ§Ù„ÙŠÙ + Ø¯ÙŠÙˆÙ† + ÙˆØµÙŠØ©</div>
      </div>
      <div class="p-4 bg-green-50 rounded-xl text-center">
        <div class="text-sm text-gray-500">ØµØ§ÙÙŠ Ø§Ù„ØªØ±ÙƒØ©</div>
        <div class="text-xl font-bold text-green-600">${result.netEstate.toLocaleString()}</div>
        <div class="text-xs text-gray-400 mt-1">Ù„Ù„ÙˆØ±Ø«Ø©</div>
      </div>
      <div class="p-4 bg-indigo-50 rounded-xl text-center">
        <div class="text-sm text-gray-500">Ø£ØµÙ„ Ø§Ù„Ù…Ø³Ø£Ù„Ø©</div>
        <div class="text-xl font-bold text-indigo-600">${result.finalBase}</div>
        <div class="text-xs text-gray-400 mt-1">${result.awlApplied ? 'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆÙ„' : 'Ù‚Ø¨Ù„ Ø§Ù„Ø¹ÙˆÙ„'}</div>
      </div>
    </div>
    
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
      <div class="p-3 bg-gray-50 rounded-xl">
        <div class="text-sm text-gray-500">Ø²Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <div class="text-lg font-bold">${result.calculationTime.toFixed(2)}ms</div>
      </div>
      <div class="p-3 bg-gray-50 rounded-xl">
        <div class="text-sm text-gray-500">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©</div>
        <div class="text-lg font-bold">${(result.confidence * 100).toFixed(1)}%</div>
      </div>
      <div class="p-3 bg-gray-50 rounded-xl">
        <div class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø©</div>
        <div class="text-lg font-bold">${result.shares.length}</div>
      </div>
    </div>
  `;
  
  // 2. Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
  if (result.warnings && result.warnings.length > 0) {
    html += `
      <div class="alert alert-warning mb-6">
        <h4 class="font-bold mb-2 flex items-center gap-2">
          <span>âš ï¸</span> ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØªØ­Ø°ÙŠØ±Ø§Øª
        </h4>
        <div class="space-y-1">
          ${result.warnings.map(w => {
            if (typeof w === 'string') {
              return `<p class="text-sm">â€¢ ${w}</p>`;
            } else if (w.message) {
              return `<p class="text-sm">â€¢ ${w.message}</p>`;
            }
            return '';
          }).join('')}
        </div>
      </div>
    `;
  }
  
  // 3. Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
  if (result.specialCases.length > 0) {
    html += `
      <div class="alert alert-info mb-6">
        <h4 class="font-bold mb-2 flex items-center gap-2">
          <span>âš¡</span> Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ©
        </h4>
        <div class="space-y-2">
          ${result.specialCases.map(c => `
            <div class="flex items-start gap-2">
              <span class="text-sm">â€¢</span>
              <div>
                <strong>${c.name}:</strong>
                <span class="text-sm"> ${c.description}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // 4. Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø°Ù‡Ø¨ÙŠØ©
  if (result.madhhabNotes && result.madhhabNotes.length > 0) {
    html += `
      <div class="alert alert-success mb-6">
        <h4 class="font-bold mb-2 flex items-center gap-2">
          <span>ğŸ“š</span> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø°Ù‡Ø¨ÙŠØ©
        </h4>
        <div class="space-y-1">
          ${result.madhhabNotes.map(n => `<p class="text-sm">â€¢ ${n}</p>`).join('')}
        </div>
      </div>
    `;
  }
  
  // 5. Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ†
  if (result.blockedHeirs.length > 0) {
    html += `
      <div class="alert alert-danger mb-6">
        <h4 class="font-bold mb-2 flex items-center gap-2">
          <span>ğŸš«</span> Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ†
        </h4>
        <div class="flex flex-wrap gap-2">
          ${result.blockedHeirs.map(b => `
            <span class="badge badge-blocked" title="${b.reason}">
              ${ENHANCED_FIQH_DATABASE.heirNames[b.heir] || b.heir}
            </span>
          `).join('')}
        </div>
        <div class="mt-2 text-sm text-gray-600">
          ${result.blockedHeirs.map(b => `â€¢ ${ENHANCED_FIQH_DATABASE.heirNames[b.heir] || b.heir}: ${b.reason}`).join('<br>')}
        </div>
      </div>
    `;
  }
  
  // 6. Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø«Ù‚Ø©
  if (result.confidenceFactors && result.confidenceFactors.length > 0) {
    html += `
      <div class="mb-6 p-4 bg-gray-50 rounded-xl">
        <h4 class="font-bold mb-2">ğŸ“Š Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø«Ù‚Ø©</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          ${result.confidenceFactors.map(f => `
            <div class="flex justify-between items-center p-2 bg-white rounded">
              <span>${f.factor}</span>
              <span class="font-mono ${f.impact.startsWith('+') ? 'text-green-600' : 'text-red-600'}">
                ${f.impact}
              </span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // 7. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  html += `
    <div class="overflow-x-auto mb-6">
      <table class="w-full">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-4 text-right font-semibold">Ø§Ù„ÙˆØ§Ø±Ø«</th>
            <th class="p-4 text-center font-semibold">Ø§Ù„Ø¹Ø¯Ø¯</th>
            <th class="p-4 text-center font-semibold">Ø§Ù„Ù†ÙˆØ¹</th>
            <th class="p-4 text-center font-semibold">Ø§Ù„Ø­ØµØ©</th>
            <th class="p-4 text-center font-semibold">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
            <th class="p-4 text-left font-semibold">Ø§Ù„Ù…Ø¨Ù„Øº</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  let totalAmount = 0;
  const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316'];
  
  result.shares.forEach((share, index) => {
    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    let badgeClass;
    if (share.type.includes('Ø¹ØµØ¨Ø©')) {
      badgeClass = 'badge-asaba';
    } else if (share.type.includes('Ø±Ø¯')) {
      badgeClass = 'badge-radd';
    } else if (share.type.includes('Ø±Ø­Ù…')) {
      badgeClass = 'badge-relative';
    } else if (share.type.includes('ÙØ±Ø¶')) {
      badgeClass = 'badge-fard';
    } else {
      badgeClass = 'badge-fard';
    }
    
    const percentage = (share.fraction.toDecimal() * 100).toFixed(2);
    const color = colors[index % colors.length];
    
    html += `
      <tr class="border-b hover:bg-gray-50 transition-colors">
        <td class="p-4">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background:${color}"></div>
            <div>
              <div class="font-medium">${share.name}</div>
              <div class="text-xs text-gray-500 mt-1">${share.reason}</div>
            </div>
          </div>
        </td>
        <td class="p-4 text-center font-mono">${share.count}</td>
        <td class="p-4 text-center">
          <span class="badge ${badgeClass} text-xs">${share.type}</span>
        </td>
        <td class="p-4 text-center font-mono">${share.fraction.toArabic()}</td>
        <td class="p-4 text-center font-mono">${percentage}%</td>
        <td class="p-4 text-left font-bold text-green-600">${share.amount.toLocaleString()}</td>
      </tr>
    `;
    
    // ØµÙ ÙØ±Ø¹ÙŠ Ù„ÙƒÙ„ ÙØ±Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† 1
    if (share.count > 1) {
      html += `
        <tr class="bg-gray-50 text-sm">
          <td class="p-2 pr-12 text-gray-500" colspan="5">â†³ Ù„ÙƒÙ„ ÙØ±Ø¯:</td>
          <td class="p-2 text-left text-gray-600">${share.amountPerPerson.toLocaleString()}</td>
        </tr>
      `;
    }
    
    totalAmount += share.amount;
  });
  
  html += `
        </tbody>
        <tfoot>
          <tr class="bg-indigo-50 font-bold">
            <td class="p-4" colspan="4">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
            <td class="p-4 text-center">100%</td>
            <td class="p-4 text-left text-green-600">${totalAmount.toLocaleString()}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
  
  // 8. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
  if (result.shares.length > 0) {
    html += `
      <div class="mb-6">
        <h4 class="font-bold mb-3 flex items-center gap-2">
          <span>ğŸ“Š</span> Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¦ÙŠ
        </h4>
        <div class="bg-gray-100 rounded-xl p-4">
          <div class="h-8 rounded-lg overflow-hidden flex mb-3">
            ${result.shares.map((share, i) => {
              const pct = share.fraction.toDecimal() * 100;
              return pct > 0 ? `
                <div class="chart-bar h-full relative group" 
                     style="width:${pct}%;background:${colors[i % colors.length]}"
                     title="${share.name}: ${pct.toFixed(1)}%">
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-xs font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity">
                      ${pct.toFixed(1)}%
                    </span>
                  </div>
                </div>
              ` : '';
            }).join('')}
          </div>
          <div class="flex flex-wrap gap-3">
            ${result.shares.map((share, i) => {
              const pct = share.fraction.toDecimal() * 100;
              return pct > 0 ? `
                <div class="flex items-center gap-2 text-sm">
                  <div class="w-3 h-3 rounded flex-shrink-0" style="background:${colors[i % colors.length]}"></div>
                  <span>${share.name}</span>
                  <span class="text-gray-500">${pct.toFixed(1)}%</span>
                </div>
              ` : '';
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }
  
  // 9. Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ)
  if (result.steps && result.steps.length > 0) {
    html += `
      <div class="mb-6">
        <details>
          <summary class="cursor-pointer font-bold mb-3 flex items-center gap-2 text-lg">
            <span>ğŸ“</span> Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            <span class="text-sm font-normal text-gray-500">(${result.steps.length} Ø®Ø·ÙˆØ©)</span>
          </summary>
          <div class="mt-3 space-y-2">
            ${result.steps.map((step, i) => {
              const icon = step.type === 'success' ? 'âœ…' : 
                          step.type === 'error' ? 'âŒ' : 
                          step.type === 'warning' ? 'âš ï¸' : 
                          step.type === 'calculation' ? 'ğŸ§®' : 
                          step.type === 'hijab' ? 'ğŸš«' : 
                          step.type === 'estate' ? 'ğŸ’°' : 'â„¹ï¸';
              
              return `
                <div class="flex gap-3 p-3 bg-gray-50 rounded-lg">
                  <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">
                    ${i + 1}
                  </div>
                  <div class="flex-1">
                    <div class="font-medium flex items-center gap-2">
                      ${icon} ${step.title}
                      ${step.duration > 0 ? `<span class="text-xs text-gray-500">(${step.duration.toFixed(0)}ms)</span>` : ''}
                    </div>
                    <div class="text-sm text-gray-600 mt-1">${step.description}</div>
                    ${step.details ? `
                      <details class="mt-2">
                        <summary class="text-xs text-gray-500 cursor-pointer">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</summary>
                        <pre class="mt-1 p-2 bg-gray-100 rounded text-xs overflow-x-auto">${JSON.stringify(step.details, null, 2)}</pre>
                      </details>
                    ` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </details>
      </div>
    `;
  }
  
  // 10. Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
  html += `
    <div class="flex flex-wrap gap-3 pt-4 border-t">
      <button onclick="exportEnhancedCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <span>ğŸ“„</span> ØªØµØ¯ÙŠØ± CSV
      </button>
      <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø©
      </button>
      <button onclick="copyEnhancedResults()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <span>ğŸ“‹</span> Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      </button>
      <button onclick="saveEnhancedCalculation()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <span>ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨
      </button>
      <button onclick="shareEnhancedResults()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <span>ğŸ”—</span> Ù…Ø´Ø§Ø±ÙƒØ©
      </button>
    </div>
    
    <div class="mt-4 text-xs text-gray-500">
      <p>â±ï¸ Ø²Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨: ${result.calculationTime.toFixed(2)}ms | ğŸ“Š Ø§Ù„Ø«Ù‚Ø©: ${(result.confidence * 100).toFixed(1)}% | ğŸ• ${new Date().toLocaleString('ar-SA')}</p>
    </div>
  `;
  
  mainResults.innerHTML = html;
  section.classList.remove('hidden');
  section.classList.add('animate-fade-in');
  
  // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³ Ø¥Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  setTimeout(() => {
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†
function validateEnhancedInputs() {
  const estate = readEnhancedEstateData();
  const heirs = readEnhancedHeirsData();
  
  const errors = [];
  const warnings = [];
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±ÙƒØ©
  if (estate.total <= 0) {
    errors.push('Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ±ÙƒØ© Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
  }
  
  if (estate.funeral < 0 || estate.debts < 0 || estate.will < 0) {
    errors.push('Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ù„Ø¨ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ©');
  }
  
  const remainingAfterDeductions = estate.total - estate.funeral - estate.debts;
  const maxWill = remainingAfterDeductions / 3;
  
  if (estate.will > maxWill) {
    warnings.push({
      type: 'will_exceed',
      message: `Ø§Ù„ÙˆØµÙŠØ© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (Ø§Ù„Ø«Ù„Ø«). Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: ${maxWill.toLocaleString()}`,
      current: estate.will,
      maxAllowed: maxWill
    });
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©
  if (Object.values(heirs).every(v => v === 0)) {
    errors.push('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ø±Ø« ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  }
  
  if (heirs.husband > 0 && heirs.wife > 0) {
    errors.push('Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙˆØ¬ÙˆØ¯ Ø²ÙˆØ¬ ÙˆØ²ÙˆØ¬Ø© Ù…Ø¹Ø§Ù‹ Ù„Ù„Ù…ÙŠØª Ø§Ù„ÙˆØ§Ø­Ø¯');
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
  const largeCounts = Object.entries(heirs)
    .filter(([key, value]) => value > 20)
    .map(([key, value]) => `${ENHANCED_FIQH_DATABASE.heirNames[key] || key}: ${value}`);
    
  if (largeCounts.length > 0) {
    warnings.push({
      type: 'large_counts',
      message: `Ø£Ø¹Ø¯Ø§Ø¯ ÙƒØ¨ÙŠØ±Ø© Ù‚Ø¯ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡: ${largeCounts.join(', ')}`,
      counts: largeCounts
    });
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  if (errors.length > 0) {
    const errorHtml = errors.map(e => `<li>âŒ ${e}</li>`).join('');
    showEnhancedError(`<strong>Ø£Ø®Ø·Ø§Ø¡ ÙŠØ¬Ø¨ ØªØµØ­ÙŠØ­Ù‡Ø§:</strong><ul class="mt-2">${errorHtml}</ul>`);
    
    enhancedAuditLog.add('Ø§Ù„ØªØ­Ù‚Ù‚ - Ø£Ø®Ø·Ø§Ø¡', 'error',
      `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${errors.length} Ø®Ø·Ø£`,
      { errors, warnings: warnings.length },
      'validation'
    );
    
  } else if (warnings.length > 0) {
    const warningHtml = warnings.map(w => {
      if (typeof w === 'string') {
        return `<li>âš ï¸ ${w}</li>`;
      } else if (w.message) {
        return `<li>âš ï¸ ${w.message}</li>`;
      }
      return '';
    }).join('');
    
    showEnhancedWarning(`<strong>ØªØ­Ø°ÙŠØ±Ø§Øª:</strong><ul class="mt-2">${warningHtml}</ul>`, true);
    
    enhancedAuditLog.add('Ø§Ù„ØªØ­Ù‚Ù‚ - ØªØ­Ø°ÙŠØ±Ø§Øª', 'warning',
      `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${warnings.length} ØªØ­Ø°ÙŠØ±`,
      { warnings: warnings.map(w => w.message || w) },
      'validation'
    );
    
  } else {
    showEnhancedSuccess('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­Ø³Ø§Ø¨!');
    
    enhancedAuditLog.add('Ø§Ù„ØªØ­Ù‚Ù‚ - Ù†Ø§Ø¬Ø­', 'success',
      'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©',
      { estateTotal: estate.total, heirsCount: Object.values(heirs).filter(v => v > 0).length },
      'validation'
    );
  }
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function resetEnhancedCalculator() {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
    return;
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ±ÙƒØ©
  document.getElementById('estateTotal').value = '100000';
  document.getElementById('funeralCosts').value = '0';
  document.getElementById('debts').value = '0';
  document.getElementById('willAmount').value = '0';
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØ±Ø«Ø©
  document.querySelectorAll('.heir-card input, .heir-card select').forEach(el => {
    if (el.tagName === 'SELECT') {
      el.value = '0';
    } else {
      el.value = '0';
    }
  });
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  document.querySelectorAll('.heir-card').forEach(card => {
    card.classList.remove('active');
    card.classList.remove('blocked');
  });
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  document.getElementById('resultsSection').classList.add('hidden');
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  updateEnhancedQuickPreview();
  
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
  enhancedAuditLog.add('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†', 'info',
    'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    { timestamp: new Date().toISOString() },
    'system'
  );
  
  showEnhancedSuccess('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„ Ù…Ø­Ø³Ù†
function loadEnhancedExample() {
  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ©
  const hasData = document.getElementById('estateTotal').value !== '100000' || 
                  Array.from(document.querySelectorAll('.heir-card input, .heir-card select'))
                       .some(el => el.value !== '0' && el.value !== 'Ù„Ø§');
  
  if (hasData && !confirm('Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù…Ø«Ø§Ù„ØŸ')) {
    return;
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
  resetEnhancedCalculator();
  
  // ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø«Ø§Ù„
  document.getElementById('estateTotal').value = '250000';
  document.getElementById('debts').value = '10000';
  document.getElementById('willAmount').value = '20000';
  
  document.getElementById('husband').value = '1';
  document.getElementById('son').value = '2';
  document.getElementById('daughter').value = '1';
  document.getElementById('father').value = '1';
  document.getElementById('mother').value = '1';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  updateAllEnhancedHeirCards();
  updateEnhancedQuickPreview();
  
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
  enhancedAuditLog.add('ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„', 'info',
    'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„: Ø²ÙˆØ¬ + Ø§Ø¨Ù†Ø§Ù† + Ø¨Ù†Øª + Ø£Ø¨ + Ø£Ù…',
    { 
      estate: 250000,
      debts: 10000,
      will: 20000,
      heirs: ['Ø²ÙˆØ¬', 'Ø§Ø¨Ù†Ø§Ù†', 'Ø¨Ù†Øª', 'Ø£Ø¨', 'Ø£Ù…']
    },
    'examples'
  );
  
  // Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  setTimeout(() => {
    calculateEnhancedInheritance();
  }, 500);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù…Ø­Ø³Ù†
function loadEnhancedQuickTest(testType) {
  const tests = {
    basic: { 
      name: 'Ø²ÙˆØ¬ + Ø¨Ù†Øª',
      estate: { total: 120000, debts: 0, will: 0 },
      heirs: { husband: 1, daughter: 1 }
    },
    awl: {
      name: 'Ø¹ÙˆÙ„ Ù…ØµØ­Ø­',
      estate: { total: 120000, debts: 0, will: 0 },
      heirs: { wife: 1, daughter: 2, father: 1, mother: 1 }
    },
    radd: {
      name: 'Ø±Ø¯ Ù…ØµØ­Ø­',
      estate: { total: 120000, debts: 0, will: 0 },
      heirs: { mother: 1, daughter: 1 }
    },
    umariyyah: {
      name: 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ© Ù…ØµØ­Ø­Ø©',
      estate: { total: 120000, debts: 0, will: 0 },
      heirs: { husband: 1, father: 1, mother: 1 }
    },
    complex: {
      name: 'Ù…Ø¹Ù‚Ø¯Ø© Ù…ØµØ­Ø­Ø©',
      estate: { total: 240000, debts: 10000, will: 5000 },
      heirs: { wife: 1, son: 2, daughter: 2, father: 1 }
    }
  };
  
  const test = tests[testType];
  if (!test) return;
  
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±: "${test.name}"ØŸ`)) {
    return;
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
  resetEnhancedCalculator();
  
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  document.getElementById('estateTotal').value = test.estate.total;
  document.getElementById('debts').value = test.estate.debts;
  document.getElementById('willAmount').value = test.estate.will;
  
  for (const [key, value] of Object.entries(test.heirs)) {
    const el = document.getElementById(key);
    if (el) el.value = value;
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  updateAllEnhancedHeirCards();
  updateEnhancedQuickPreview();
  
  enhancedAuditLog.add('Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹', 'info',
    `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±: ${test.name}`,
    { testType, testName: test.name, heirs: test.heirs },
    'tests'
  );
  
  // Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  setTimeout(() => {
    calculateEnhancedInheritance();
  }, 300);
}

// Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù†
function toggleEnhancedHeirs() {
  const container = document.getElementById('extendedHeirs');
  const icon = document.getElementById('toggleIcon');
  
  container.classList.toggle('hidden');
  
  if (container.classList.contains('hidden')) {
    icon.style.transform = 'rotate(0deg)';
    icon.textContent = 'â—€';
  } else {
    icon.style.transform = 'rotate(-90deg)';
    icon.textContent = 'â–¼';
  }
  
  enhancedAuditLog.add('ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ±Ø«Ø©', 'info',
    container.classList.contains('hidden') ? 'ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†' : 'ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†',
    { state: container.classList.contains('hidden') ? 'hidden' : 'visible' },
    'ui'
  );
}

// ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function updateAllEnhancedHeirCards() {
  document.querySelectorAll('.heir-card').forEach(card => {
    const input = card.querySelector('input, select');
    if (input) {
      const value = parseFloat(input.value) || 0;
      card.classList.toggle('active', value > 0);
    }
  });
}

// Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
async function runEnhancedComparison() {
  const estate = readEnhancedEstateData();
  const heirs = readEnhancedHeirsData();
  
  if (estate.total <= 0 || Object.values(heirs).every(v => v === 0)) {
    showEnhancedError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ© ÙˆØ§Ù„ÙˆØ±Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  const compareBtn = document.getElementById('runCompareBtn');
  const originalText = compareBtn.innerHTML;
  
  try {
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    compareBtn.innerHTML = '<span class="animate-pulse">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©...</span>';
    compareBtn.disabled = true;
    
    const results = {};
    const madhabs = ['shafii', 'hanafi', 'maliki', 'hanbali'];
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„ÙƒÙ„ Ù…Ø°Ù‡Ø¨
    for (const madhab of madhabs) {
      const engine = new EnhancedInheritanceEngine(madhab, estate, heirs);
      results[madhab] = await Promise.resolve(engine.calculate());
    }
    
    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
    const allHeirs = new Set();
    Object.values(results).forEach(r => {
      if (r.success) {
        r.shares.forEach(s => allHeirs.add(s.key));
      }
    });
    
    // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const tbody = document.getElementById('comparisonBody');
    tbody.innerHTML = '';
    
    Array.from(allHeirs).forEach(heirKey => {
      const row = document.createElement('tr');
      row.className = 'border-b hover:bg-gray-50';
      
      let cells = `<td class="p-3 font-medium">${ENHANCED_FIQH_DATABASE.heirNames[heirKey] || heirKey}</td>`;
      
      madhabs.forEach(madhab => {
        const result = results[madhab];
        const share = result.success ? result.shares.find(s => s.key === heirKey) : null;
        
        const bgClass = madhab === 'shafii' ? 'bg-green-50' : 
                        madhab === 'hanafi' ? 'bg-red-50' : 
                        madhab === 'maliki' ? 'bg-purple-50' : 'bg-blue-50';
        
        cells += `<td class="p-3 text-center ${bgClass}">`;
        
        if (share) {
          const percentage = (share.fraction.toDecimal() * 100).toFixed(2);
          cells += `
            <div class="font-mono text-sm">${share.fraction.toArabic()}</div>
            <div class="text-xs text-gray-500">${percentage}%</div>
            <div class="text-xs font-bold text-green-600">${share.amount.toLocaleString()}</div>
          `;
        } else {
          cells += `<span class="text-gray-400 text-sm">â€”</span>`;
        }
        
        cells += `</td>`;
      });
      
      row.innerHTML = cells;
      tbody.appendChild(row);
    });
    
    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const totalRow = document.createElement('tr');
    totalRow.className = 'font-bold bg-gray-100';
    totalRow.innerHTML = `
      <td class="p-3">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
      ${madhabs.map(madhab => {
        const result = results[madhab];
        const total = result.success ? 
          result.shares.reduce((sum, s) => sum + s.amount, 0) : 0;
        return `<td class="p-3 text-center text-green-600">${total.toLocaleString()}</td>`;
      }).join('')}
    `;
    tbody.appendChild(totalRow);
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª
    const notesDiv = document.getElementById('comparisonNotes');
    const allNotes = [];
    const differences = [];
    
    // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨
    if (allHeirs.size > 0) {
      Array.from(allHeirs).forEach(heirKey => {
        const shares = {};
        madhabs.forEach(madhab => {
          const result = results[madhab];
          const share = result.success ? result.shares.find(s => s.key === heirKey) : null;
          shares[madhab] = share ? share.fraction.toDecimal() : 0;
        });
        
        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        const values = Object.values(shares);
        const max = Math.max(...values);
        const min = Math.min(...values.filter(v => v > 0));
        
        if (max - min > 0.05 && max > 0) { // ÙØ±Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† 5%
          differences.push({
            heir: ENHANCED_FIQH_DATABASE.heirNames[heirKey] || heirKey,
            range: `${(min * 100).toFixed(1)}% - ${(max * 100).toFixed(1)}%`,
            difference: `${((max - min) * 100).toFixed(1)}%`
          });
        }
      });
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø°Ù‡Ø¨ÙŠØ©
    Object.entries(results).forEach(([madhab, r]) => {
      if (r.success) {
        r.madhhabNotes?.forEach(n => allNotes.push(`${ENHANCED_FIQH_DATABASE.madhabs[madhab].name}: ${n}`));
        r.specialCases?.forEach(c => allNotes.push(`${ENHANCED_FIQH_DATABASE.madhabs[madhab].name}: ${c.name} - ${c.description}`));
      }
    });
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª
    let notesHtml = '';
    
    if (differences.length > 0) {
      notesHtml += `
        <div class="mb-4">
          <h4 class="font-bold mb-2 text-amber-800">âš¡ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¬ÙˆÙ‡Ø±ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨</h4>
          <div class="space-y-2">
            ${differences.map(diff => `
              <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div class="font-medium">${diff.heir}</div>
                <div class="text-sm text-amber-700">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹: ${diff.range} (ÙØ±Ù‚: ${diff.difference})</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    if (allNotes.length > 0) {
      const uniqueNotes = [...new Set(allNotes)];
      notesHtml += `
        <div>
          <h4 class="font-bold mb-2 text-blue-800">ğŸ“š Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø°Ù‡Ø¨ÙŠØ©</h4>
          <div class="space-y-2">
            ${uniqueNotes.map(note => `
              <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="text-sm">${note}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    } else {
      notesHtml = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚ Ø¬ÙˆÙ‡Ø±ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</p>';
    }
    
    notesDiv.innerHTML = notesHtml;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('comparisonResults').classList.remove('hidden');
    document.getElementById('comparisonResults').classList.add('animate-fade-in');
    
    enhancedAuditLog.add('Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨', 'info',
      `ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† ${madhabs.length} Ù…Ø°Ø§Ù‡Ø¨`,
      { 
        madhabs: madhabs.map(m => ENHANCED_FIQH_DATABASE.madhabs[m].name),
        heirsCount: allHeirs.size,
        differences: differences.length
      },
      'comparison'
    );
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©:', error);
    showEnhancedError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: ${error.message}`);
    
    enhancedAuditLog.add('Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ - Ø®Ø·Ø£', 'error',
      error.message,
      { error: error.message },
      'comparison'
    );
    
  } finally {
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    compareBtn.innerHTML = originalText;
    compareBtn.disabled = false;
  }
}

// ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
async function runEnhancedAllTests() {
  const runBtn = document.getElementById('runAllTestsBtn');
  const container = document.getElementById('testResultsContainer');
  const originalText = runBtn.innerHTML;
  
  try {
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    runBtn.innerHTML = '<span class="animate-pulse">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</span>';
    runBtn.disabled = true;
    container.innerHTML = '<div class="text-center py-12 animate-pulse"><div class="text-3xl mb-4">ğŸ§ª</div><div>Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...</div><div class="text-sm text-gray-500 mt-2">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù</div></div>';
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    const startTime = performance.now();
    const testResults = await enhancedTestSuite.runAllTests(currentMadhab);
    const endTime = performance.now();
    const totalTime = endTime - startTime;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('testsPassed').textContent = testResults.stats.passed;
    document.getElementById('testsFailed').textContent = testResults.stats.failed;
    document.getElementById('testsTotal').textContent = testResults.stats.total;
    document.getElementById('testsCoverage').textContent = testResults.coverage + '%';
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    let html = `
      <div class="mb-6 p-4 bg-gray-50 rounded-xl">
        <div class="flex flex-wrap justify-between items-center mb-4">
          <div>
            <h3 class="font-bold">Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
            <p class="text-sm text-gray-600">Ø²Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„: ${totalTime.toFixed(2)}ms</p>
          </div>
          <div class="text-2xl font-bold ${parseFloat(testResults.coverage) >= 90 ? 'text-green-600' : parseFloat(testResults.coverage) >= 80 ? 'text-yellow-600' : 'text-red-600'}">
            ${testResults.coverage}%
          </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="text-center p-3 bg-green-50 rounded-lg">
            <div class="text-2xl font-bold text-green-600">${testResults.stats.passed}</div>
            <div class="text-sm text-gray-600">Ù†Ø§Ø¬Ø­Ø©</div>
          </div>
          <div class="text-center p-3 bg-red-50 rounded-lg">
            <div class="text-2xl font-bold text-red-600">${testResults.stats.failed}</div>
            <div class="text-sm text-gray-600">ÙØ§Ø´Ù„Ø©</div>
          </div>
          <div class="text-center p-3 bg-blue-50 rounded-lg">
            <div class="text-2xl font-bold text-blue-600">${testResults.stats.total}</div>
            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          </div>
          <div class="text-center p-3 ${parseFloat(testResults.coverage) >= 90 ? 'bg-green-50' : parseFloat(testResults.coverage) >= 80 ? 'bg-yellow-50' : 'bg-red-50'} rounded-lg">
            <div class="text-2xl font-bold ${parseFloat(testResults.coverage) >= 90 ? 'text-green-600' : parseFloat(testResults.coverage) >= 80 ? 'text-yellow-600' : 'text-red-600'}">${testResults.coverage}%</div>
            <div class="text-sm text-gray-600">ØªØºØ·ÙŠØ©</div>
          </div>
        </div>
      </div>
    `;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const byCategory = {};
    testResults.results.forEach(r => {
      if (!byCategory[r.category]) byCategory[r.category] = [];
      byCategory[r.category].push(r);
    });
    
    for (const [category, tests] of Object.entries(byCategory)) {
      const passed = tests.filter(t => t.passed).length;
      const total = tests.length;
      const percentage = ((passed / total) * 100).toFixed(1);
      
      html += `
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3 p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">${category}</h3>
            <span class="text-sm ${percentage >= 90 ? 'text-green-600' : percentage >= 80 ? 'text-yellow-600' : 'text-red-600'} font-bold">
              ${passed}/${total} (${percentage}%)
            </span>
          </div>
          
          <div class="space-y-2">
      `;
      
      tests.forEach(test => {
        const statusClass = test.passed ? 'test-pass' : (test.skipped ? 'bg-gray-100' : 'test-fail');
        const statusIcon = test.passed ? 'âœ…' : (test.skipped ? 'â­ï¸' : 'âŒ');
        
        html += `
          <div class="p-3 rounded-lg ${statusClass}">
            <div class="flex justify-between items-start mb-1">
              <div>
                <span class="font-medium">${statusIcon} ${test.name}</span>
                <span class="text-xs text-gray-500 mr-2">(${test.madhab})</span>
              </div>
              <span class="text-xs text-gray-500">${test.testTime ? test.testTime.toFixed(0) + 'ms' : ''}</span>
            </div>
            
            ${test.description ? `<div class="text-sm text-gray-600 mb-2">${test.description}</div>` : ''}
            
            ${test.discrepancies ? `
              <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="text-sm font-medium text-red-600 mb-1">Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª:</div>
                <div class="text-xs text-red-500">${test.discrepancies.join('<br>')}</div>
              </div>
            ` : ''}
            
            ${test.error ? `
              <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="text-sm font-medium text-red-600">Ø®Ø·Ø£:</div>
                <div class="text-xs text-red-500">${test.error}</div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
    
    // ØªØ³Ø¬ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const testStatus = parseFloat(testResults.coverage) >= 90 ? 'success' : 
                      parseFloat(testResults.coverage) >= 80 ? 'warning' : 'error';
    
    enhancedAuditLog.add('ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', testStatus,
      `${testResults.stats.passed}/${testResults.stats.total} Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§Ø¬Ø­ (${testResults.coverage}%)`,
      {
        total: testResults.stats.total,
        passed: testResults.stats.passed,
        failed: testResults.stats.failed,
        coverage: testResults.coverage,
        time: totalTime,
        byCategory: testResults.stats.byCategory
      },
      'testing'
    );
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:', error);
    container.innerHTML = `
      <div class="text-center py-8">
        <div class="text-3xl text-red-500 mb-2">âŒ</div>
        <div class="text-red-600 font-medium">Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
        <div class="text-sm text-gray-500 mt-2">${error.message}</div>
      </div>
    `;
    
    enhancedAuditLog.add('ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ø®Ø·Ø£', 'error',
      error.message,
      { error: error.message },
      'testing'
    );
    
  } finally {
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    runBtn.innerHTML = originalText;
    runBtn.disabled = false;
  }
}

// ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function exportEnhancedTestResults() {
  if (enhancedTestSuite.results.length === 0) {
    showEnhancedError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØµØ¯ÙŠØ±. Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  
  const exportData = enhancedTestSuite.exportTestResults('text');
  if (!exportData) return;
  
  const blob = new Blob(['\uFEFF' + exportData], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `test_results_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  enhancedAuditLog.add('ØªØµØ¯ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', 'success',
    'ØªÙ… ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª',
    { testsCount: enhancedTestSuite.results.length },
    'export'
  );
  
  showEnhancedSuccess('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
}

// Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†
function clearEnhancedAuditLog() {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
    return;
  }
  
  enhancedAuditLog.clear();
  
  enhancedAuditLog.add('Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'warning',
    'ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
    { timestamp: new Date().toISOString() },
    'audit'
  );
  
  showEnhancedSuccess('âœ… ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
}

// ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†
function exportEnhancedAuditLog() {
  enhancedAuditLog.downloadExport('text');
}

// ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†
function refreshEnhancedAuditLog() {
  enhancedAuditLog.updateDisplay();
  
  enhancedAuditLog.add('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„', 'info',
    'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
    { entriesCount: enhancedAuditLog.entries.length },
    'audit'
  );
}

// ==================== 9. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù†Ø© ====================

// Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù…Ø­Ø³Ù†
function showEnhancedError(message, duration = 5000) {
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
  const alertDiv = document.createElement('div');
  alertDiv.className = 'fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50 animate-fade-in';
  alertDiv.innerHTML = `
    <div class="bg-red-50 border border-red-200 rounded-xl p-4 shadow-lg">
      <div class="flex items-start gap-3">
        <div class="text-red-600 text-xl">âŒ</div>
        <div class="flex-1">
          <div class="font-medium text-red-800">Ø®Ø·Ø£</div>
          <div class="text-sm text-red-700 mt-1">${message}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-600">
          âœ•
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(alertDiv);
  
  // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø©
  if (duration > 0) {
    setTimeout(() => {
      if (alertDiv.parentElement) {
        alertDiv.remove();
      }
    }, duration);
  }
}

// Ø¹Ø±Ø¶ ØªØ­Ø°ÙŠØ± Ù…Ø­Ø³Ù†
function showEnhancedWarning(message, duration = 5000) {
  const alertDiv = document.createElement('div');
  alertDiv.className = 'fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50 animate-fade-in';
  alertDiv.innerHTML = `
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 shadow-lg">
      <div class="flex items-start gap-3">
        <div class="text-amber-600 text-xl">âš ï¸</div>
        <div class="flex-1">
          <div class="font-medium text-amber-800">ØªØ­Ø°ÙŠØ±</div>
          <div class="text-sm text-amber-700 mt-1">${message}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="text-amber-400 hover:text-amber-600">
          âœ•
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(alertDiv);
  
  if (duration > 0) {
    setTimeout(() => {
      if (alertDiv.parentElement) {
        alertDiv.remove();
      }
    }, duration);
  }
}

// Ø¹Ø±Ø¶ Ù†Ø¬Ø§Ø­ Ù…Ø­Ø³Ù†
function showEnhancedSuccess(message, duration = 3000) {
  const alertDiv = document.createElement('div');
  alertDiv.className = 'fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50 animate-fade-in';
  alertDiv.innerHTML = `
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-lg">
      <div class="flex items-start gap-3">
        <div class="text-green-600 text-xl">âœ…</div>
        <div class="flex-1">
          <div class="font-medium text-green-800">Ù†Ø¬Ø§Ø­</div>
          <div class="text-sm text-green-700 mt-1">${message}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" class="text-green-400 hover:text-green-600">
          âœ•
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(alertDiv);
  
  if (duration > 0) {
    setTimeout(() => {
      if (alertDiv.parentElement) {
        alertDiv.remove();
      }
    }, duration);
  }
}

// ØªØµØ¯ÙŠØ± CSV Ù…Ø­Ø³Ù†
function exportEnhancedCSV() {
  if (!lastCalculationResult) {
    showEnhancedError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  const result = lastCalculationResult;
  const rows = [
    ['Ø§Ù„ÙˆØ§Ø±Ø«', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø­ØµØ©', 'Ø§Ù„Ù†Ø³Ø¨Ø© (%)', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ù„ÙƒÙ„ ÙØ±Ø¯', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª']
  ];
  
  result.shares.forEach(s => {
    rows.push([
      s.name,
      s.count,
      s.type,
      s.fraction.toString(),
      (s.fraction.toDecimal() * 100).toFixed(2),
      s.amount.toFixed(2),
      s.amountPerPerson.toFixed(2),
      s.reason
    ]);
  });
  
  // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
  rows.push([
    'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
    '',
    '',
    '',
    '100.00',
    result.netEstate.toFixed(2),
    '',
    `Ø§Ù„Ù…Ø°Ù‡Ø¨: ${result.madhhabName} | Ø§Ù„Ø«Ù‚Ø©: ${(result.confidence * 100).toFixed(1)}%`
  ]);
  
  const csv = '\uFEFF' + rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Ù…ÙˆØ§Ø±ÙŠØ«_${result.madhhabName}_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  enhancedAuditLog.add('ØªØµØ¯ÙŠØ± CSV', 'success',
    'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙŠØºØ© CSV',
    { fileName: a.download, sharesCount: result.shares.length },
    'export'
  );
}

// Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function copyEnhancedResults() {
  if (!lastCalculationResult) {
    showEnhancedError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù†Ø³Ø®');
    return;
  }
  
  const result = lastCalculationResult;
  let text = `Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø« - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„\n`;
  text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
  text += `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}\n`;
  text += `ğŸ•Œ Ø§Ù„Ù…Ø°Ù‡Ø¨: ${result.madhhabName}\n`;
  text += `ğŸ’° ØµØ§ÙÙŠ Ø§Ù„ØªØ±ÙƒØ©: ${result.netEstate.toLocaleString()}\n`;
  text += `ğŸ“Š Ø£ØµÙ„ Ø§Ù„Ù…Ø³Ø£Ù„Ø©: ${result.finalBase} ${result.awlApplied ? '(Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆÙ„)' : ''}\n`;
  text += `âš¡ Ø§Ù„Ø«Ù‚Ø©: ${(result.confidence * 100).toFixed(1)}%\n\n`;
  text += `ğŸ“‹ Ø§Ù„Ø£Ù†ØµØ¨Ø©:\n`;
  text += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
  
  result.shares.forEach(s => {
    text += `â€¢ ${s.name} (${s.count})`;
    text += `: ${s.fraction.toArabic()} = ${s.amount.toLocaleString()}`;
    if (s.count > 1) {
      text += ` (${s.amountPerPerson.toLocaleString()} Ù„ÙƒÙ„ ÙØ±Ø¯)`;
    }
    text += ` [${s.type}]\n`;
  });
  
  text += `\nğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${result.netEstate.toLocaleString()}\n\n`;
  
  if (result.specialCases.length > 0) {
    text += `âš¡ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©:\n`;
    result.specialCases.forEach(c => {
      text += `â€¢ ${c.name}: ${c.description}\n`;
    });
    text += `\n`;
  }
  
  if (result.madhhabNotes.length > 0) {
    text += `ğŸ“š Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø°Ù‡Ø¨ÙŠØ©:\n`;
    result.madhhabNotes.forEach(n => {
      text += `â€¢ ${n}\n`;
    });
  }
  
  navigator.clipboard.writeText(text).then(() => {
    showEnhancedSuccess('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
    
    enhancedAuditLog.add('Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'success',
      'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©',
      { sharesCount: result.shares.length, charCount: text.length },
      'export'
    );
  }).catch(err => {
    showEnhancedError('âŒ ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ' + err.message);
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†
function saveEnhancedCalculation() {
  if (!lastCalculationResult) {
    showEnhancedError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø­ÙØ¸');
    return;
  }
  
  const result = lastCalculationResult;
  const saveData = {
    version: '5.0',
    timestamp: new Date().toISOString(),
    calculation: result,
    input: {
      estate: readEnhancedEstateData(),
      heirs: readEnhancedHeirsData(),
      madhab: currentMadhab
    }
  };
  
  const dataStr = JSON.stringify(saveData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `Ø­Ø³Ø§Ø¨_Ù…ÙˆØ§Ø±ÙŠØ«_${result.madhhabName}_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  enhancedAuditLog.add('Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨', 'success',
    'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙƒÙ…Ù„Ù JSON',
    { fileName: exportFileDefaultName, dataSize: dataStr.length },
    'export'
  );
  
  showEnhancedSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
}

// Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function shareEnhancedResults() {
  if (!lastCalculationResult) {
    showEnhancedError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
    return;
  }
  
  const result = lastCalculationResult;
  const shareText = `Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø« - Ø§Ù„Ù…Ø°Ù‡Ø¨ ${result.madhhabName}\n` +
                   `ØµØ§ÙÙŠ Ø§Ù„ØªØ±ÙƒØ©: ${result.netEstate.toLocaleString()}\n` +
                   `Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø©: ${result.shares.length}\n` +
                   `Ø§Ù„Ø«Ù‚Ø©: ${(result.confidence * 100).toFixed(1)}%\n` +
                   `\nØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.0`;
  
  if (navigator.share) {
    navigator.share({
      title: `Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ±Ø§Ø« - ${result.madhhabName}`,
      text: shareText,
      url: window.location.href
    }).then(() => {
      enhancedAuditLog.add('Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'success',
        'ØªÙ…Øª Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬',
        { platform: 'web-share' },
        'share'
      );
    }).catch(err => {
      console.log('Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ù„ØºÙŠØª Ø£Ùˆ ÙØ´Ù„Øª:', err);
    });
  } else {
    // Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙƒØ¨Ø¯ÙŠÙ„
    navigator.clipboard.writeText(shareText).then(() => {
      showEnhancedSuccess('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
      
      enhancedAuditLog.add('Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'info',
        'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ø¨Ø¯ÙŠÙ„)',
        { method: 'clipboard' },
        'share'
      );
    });
  }
}

// ==================== 10. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ====================
console.log('ğŸš€ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 5.0 - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©');

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
function loadSavedCalculation(jsonData) {
  try {
    const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
    
    if (data.version && data.input) {
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø°Ù‡Ø¨
      selectEnhancedMadhab(data.input.madhab);
      
      // ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙƒØ©
      document.getElementById('estateTotal').value = data.input.estate.total;
      document.getElementById('funeralCosts').value = data.input.estate.funeral;
      document.getElementById('debts').value = data.input.estate.debts;
      document.getElementById('willAmount').value = data.input.estate.will;
      
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ±Ø«Ø©
      for (const [key, value] of Object.entries(data.input.heirs)) {
        const el = document.getElementById(key);
        if (el) el.value = value;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      updateAllEnhancedHeirCards();
      updateEnhancedQuickPreview();
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      setTimeout(() => {
        calculateEnhancedInheritance();
      }, 100);
      
      return true;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸:', error);
    showEnhancedError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸');
  }
  
  return false;
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
window.loadSavedCalculation = loadSavedCalculation;

</script>
</body>
</html>